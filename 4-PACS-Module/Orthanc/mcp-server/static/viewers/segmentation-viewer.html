<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segmentation Viewer - PACS Advanced Tools</title>
    <link rel="stylesheet" href="../css/viewer.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="../js/viewers/segmentation-overlay.js" defer></script>
</head>
<body>
    <div class="viewer-container">
        <!-- Header -->
        <header class="viewer-header">
            <h1>ML Segmentation Viewer</h1>
            <div class="header-actions">
                <button id="backBtn" class="btn-secondary">‚Üê Back to Dashboard</button>
                <button id="helpBtn" class="btn-secondary">Help</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="viewer-content">
            <!-- Left Sidebar - Study & Segmentation Controls -->
            <aside class="sidebar-left">
                <div class="panel">
                    <h3>Study Selection</h3>
                    <div class="form-group">
                        <label for="studySelect">Select Study:</label>
                        <select id="studySelect" class="form-control">
                            <option value="">-- Select a study --</option>
                        </select>
                    </div>
                    <button id="loadStudyBtn" class="btn-primary" disabled>Load Study</button>
                </div>

                <div class="panel">
                    <h3>Segmentation Type</h3>
                    <div class="segmentation-types">
                        <button class="btn-segmentation" data-type="vessels">
                            <span class="seg-icon">ü©∏</span>
                            <span class="seg-label">Vessels</span>
                        </button>
                        <button class="btn-segmentation" data-type="organs">
                            <span class="seg-icon">ü´Ä</span>
                            <span class="seg-label">Organs</span>
                        </button>
                        <button class="btn-segmentation" data-type="nodules">
                            <span class="seg-icon">ü´Å</span>
                            <span class="seg-label">Nodules</span>
                        </button>
                    </div>
                </div>

                <div class="panel">
                    <h3>Segmentation Settings</h3>
                    
                    <div class="form-group">
                        <label for="threshold">Confidence Threshold:</label>
                        <input type="range" id="threshold" min="0" max="100" value="50" class="slider">
                        <span id="thresholdValue">50%</span>
                    </div>

                    <div class="form-group">
                        <label for="smoothing">Smoothing Level:</label>
                        <input type="range" id="smoothing" min="0" max="10" value="3" class="slider">
                        <span id="smoothingValue">3</span>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="removeSmall" checked> Remove Small Components
                        </label>
                    </div>

                    <button id="runSegmentationBtn" class="btn-primary" disabled>
                        Run Segmentation
                    </button>
                </div>

                <div class="panel">
                    <h3>Processing Status</h3>
                    <div id="processingStatus" class="status-container">
                        <p class="status-idle">Ready to segment</p>
                    </div>
                    
                    <div id="progressContainer" style="display: none;">
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <p id="progressText" class="progress-text">0%</p>
                    </div>
                </div>
            </aside>

            <!-- Center - Segmentation Viewer -->
            <main class="viewer-main">
                <div class="canvas-container">
                    <canvas id="segmentationCanvas"></canvas>
                    
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                        <p id="loadingMessage">Processing segmentation...</p>
                    </div>

                    <!-- Error Overlay -->
                    <div id="errorOverlay" class="error-overlay" style="display: none;">
                        <p id="errorMessage"></p>
                        <button id="retryBtn" class="btn-primary">Retry</button>
                    </div>
                </div>

                <!-- Canvas Controls -->
                <div class="canvas-controls">
                    <div class="control-group">
                        <button id="resetViewBtn" class="btn-icon" title="Reset View">
                            <span>‚ü≤</span>
                        </button>
                        <button id="screenshotBtn" class="btn-icon" title="Screenshot">
                            <span>üì∑</span>
                        </button>
                        <button id="toggleOverlayBtn" class="btn-icon" title="Toggle Overlay">
                            <span>üëÅ</span>
                        </button>
                    </div>
                </div>

                <!-- Info Overlay -->
                <div class="info-overlay">
                    <div id="studyInfo" class="info-panel">
                        <p><strong>Patient:</strong> <span id="patientName">-</span></p>
                        <p><strong>Study Date:</strong> <span id="studyDate">-</span></p>
                        <p><strong>Modality:</strong> <span id="modality">-</span></p>
                    </div>
                    <div id="segmentationInfo" class="info-panel" style="display: none;">
                        <p><strong>Type:</strong> <span id="segType">-</span></p>
                        <p><strong>Voxels:</strong> <span id="segVoxels">-</span></p>
                        <p><strong>Volume:</strong> <span id="segVolume">-</span></p>
                        <p><strong>Time:</strong> <span id="segTime">-</span></p>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - Results & Controls -->
            <aside class="sidebar-right">
                <div class="panel">
                    <h3>Overlay Controls</h3>
                    
                    <div class="form-group">
                        <label for="overlayOpacity">Overlay Opacity:</label>
                        <input type="range" id="overlayOpacity" min="0" max="100" value="70" class="slider">
                        <span id="overlayOpacityValue">70%</span>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOverlay" checked> Show Overlay
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showOriginal" checked> Show Original
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showBoundaries"> Show Boundaries
                        </label>
                    </div>
                </div>

                <div class="panel">
                    <h3>Color Legend</h3>
                    <div id="colorLegend" class="color-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff0000;"></div>
                            <span class="legend-label">Vessels</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00ff00;"></div>
                            <span class="legend-label">Liver</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #0000ff;"></div>
                            <span class="legend-label">Kidneys</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffff00;"></div>
                            <span class="legend-label">Spleen</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff00ff;"></div>
                            <span class="legend-label">Pancreas</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00ffff;"></div>
                            <span class="legend-label">Lungs</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffa500;"></div>
                            <span class="legend-label">Heart</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Statistics</h3>
                    <div id="statisticsPanel" class="statistics-panel">
                        <p class="empty-state">Run segmentation to see statistics</p>
                    </div>
                </div>

                <div class="panel">
                    <h3>Export Options</h3>
                    <button id="exportMask" class="btn-secondary" disabled>Export Mask (NPY)</button>
                    <button id="exportJSON" class="btn-secondary" disabled>Export JSON</button>
                    <button id="exportVisualization" class="btn-secondary" disabled>Export Visualization</button>
                    <button id="exportReport" class="btn-primary" disabled>Generate Report</button>
                </div>

                <div class="panel">
                    <h3>Segmentation History</h3>
                    <div id="historyList" class="history-list">
                        <p class="empty-state">No segmentations yet</p>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="viewer-footer">
            <div class="footer-left">
                <span id="statusMessage">Ready</span>
            </div>
            <div class="footer-right">
                <span>ML-powered segmentation using MONAI</span>
            </div>
        </footer>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Segmentation Viewer Help</h2>
            <div class="help-content">
                <h3>Getting Started</h3>
                <ol>
                    <li>Select a study from the dropdown</li>
                    <li>Click "Load Study" to load the volume</li>
                    <li>Choose a segmentation type (Vessels, Organs, or Nodules)</li>
                    <li>Adjust settings if needed</li>
                    <li>Click "Run Segmentation" to start processing</li>
                </ol>

                <h3>Segmentation Types</h3>
                <ul>
                    <li><strong>Vessels:</strong> Segments blood vessels in CT angiography</li>
                    <li><strong>Organs:</strong> Segments major organs (liver, kidneys, spleen, etc.)</li>
                    <li><strong>Nodules:</strong> Detects lung nodules in chest CT</li>
                </ul>

                <h3>Settings</h3>
                <ul>
                    <li><strong>Confidence Threshold:</strong> Minimum confidence for segmentation (higher = more conservative)</li>
                    <li><strong>Smoothing Level:</strong> Amount of smoothing applied to mask (higher = smoother)</li>
                    <li><strong>Remove Small Components:</strong> Removes small isolated regions</li>
                </ul>

                <h3>Overlay Controls</h3>
                <ul>
                    <li><strong>Overlay Opacity:</strong> Transparency of segmentation overlay</li>
                    <li><strong>Show Overlay:</strong> Toggle segmentation visibility</li>
                    <li><strong>Show Original:</strong> Toggle original volume visibility</li>
                    <li><strong>Show Boundaries:</strong> Display segmentation boundaries</li>
                </ul>

                <h3>Export Options</h3>
                <ul>
                    <li><strong>Export Mask:</strong> Save segmentation mask as NumPy array</li>
                    <li><strong>Export JSON:</strong> Save segmentation data as JSON</li>
                    <li><strong>Export Visualization:</strong> Save current view as image</li>
                    <li><strong>Generate Report:</strong> Create comprehensive segmentation report</li>
                </ul>

                <h3>Performance</h3>
                <p>Segmentation typically takes 10-30 seconds depending on volume size and GPU availability. 
                   GPU acceleration is automatically used when available.</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize viewer when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Segmentation Viewer initialized');
            
            // Load available studies
            loadStudies();
            
            // Setup event listeners
            setupEventListeners();
        });

        function loadStudies() {
            // Fetch studies from API
            fetch('/api/viewer/studies')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('studySelect');
                    data.studies.forEach(study => {
                        const option = document.createElement('option');
                        option.value = study.id;
                        option.textContent = `${study.patient_name} - ${study.study_date}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Failed to load studies:', error);
                    showError('Failed to load studies. Please refresh the page.');
                });
        }

        function setupEventListeners() {
            // Study selection
            document.getElementById('studySelect').addEventListener('change', function() {
                document.getElementById('loadStudyBtn').disabled = !this.value;
            });

            // Load study button
            document.getElementById('loadStudyBtn').addEventListener('click', loadSelectedStudy);

            // Segmentation type buttons
            document.querySelectorAll('.btn-segmentation').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectSegmentationType(this.dataset.type);
                });
            });

            // Run segmentation button
            document.getElementById('runSegmentationBtn').addEventListener('click', runSegmentation);

            // Sliders
            document.getElementById('threshold').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = this.value + '%';
            });

            document.getElementById('smoothing').addEventListener('input', function() {
                document.getElementById('smoothingValue').textContent = this.value;
            });

            document.getElementById('overlayOpacity').addEventListener('input', function() {
                document.getElementById('overlayOpacityValue').textContent = this.value + '%';
                updateOverlayOpacity(this.value);
            });

            // Checkboxes
            document.getElementById('showOverlay').addEventListener('change', toggleOverlay);
            document.getElementById('showOriginal').addEventListener('change', toggleOriginal);
            document.getElementById('showBoundaries').addEventListener('change', toggleBoundaries);

            // Canvas controls
            document.getElementById('resetViewBtn').addEventListener('click', resetView);
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('toggleOverlayBtn').addEventListener('click', () => {
                document.getElementById('showOverlay').click();
            });

            // Export buttons
            document.getElementById('exportMask').addEventListener('click', () => exportData('mask'));
            document.getElementById('exportJSON').addEventListener('click', () => exportData('json'));
            document.getElementById('exportVisualization').addEventListener('click', () => exportData('viz'));
            document.getElementById('exportReport').addEventListener('click', generateReport);

            // Navigation
            document.getElementById('backBtn').addEventListener('click', () => window.location.href = '../dashboard.html');
            document.getElementById('helpBtn').addEventListener('click', showHelp);

            // Modal close
            document.querySelector('.close').addEventListener('click', () => {
                document.getElementById('helpModal').style.display = 'none';
            });
        }

        let currentStudy = null;
        let currentSegmentationType = null;
        let segmentationResult = null;

        function loadSelectedStudy() {
            const studyId = document.getElementById('studySelect').value;
            if (!studyId) return;

            showLoading(true, 'Loading study...');
            updateStatus('Loading study...');

            fetch('/api/viewer/load-study', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ study_id: studyId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentStudy = data;
                    updateStudyInfo(data.metadata);
                    updateStatus('Study loaded successfully');
                    document.getElementById('runSegmentationBtn').disabled = currentSegmentationType === null;
                } else {
                    showError(data.message || 'Failed to load study');
                }
            })
            .catch(error => {
                console.error('Error loading study:', error);
                showError('Failed to load study. Please try again.');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function selectSegmentationType(type) {
            currentSegmentationType = type;
            
            // Update button states
            document.querySelectorAll('.btn-segmentation').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Enable run button if study is loaded
            if (currentStudy) {
                document.getElementById('runSegmentationBtn').disabled = false;
            }
            
            updateStatus(`Selected ${type} segmentation`);
        }

        function runSegmentation() {
            if (!currentStudy || !currentSegmentationType) return;

            const threshold = document.getElementById('threshold').value / 100;
            const smoothing = document.getElementById('smoothing').value;
            const removeSmall = document.getElementById('removeSmall').checked;

            showLoading(true, 'Running segmentation...');
            updateStatus('Processing...');
            showProgress(true);

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress <= 90) {
                    updateProgress(progress);
                }
            }, 500);

            fetch(`/api/segment/${currentSegmentationType}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    study_id: currentStudy.study_id,
                    threshold: threshold,
                    smoothing: smoothing,
                    remove_small: removeSmall
                })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                updateProgress(100);
                
                if (data.success) {
                    segmentationResult = data;
                    displaySegmentationResult(data);
                    updateStatus('Segmentation completed');
                    enableExportButtons();
                } else {
                    showError(data.error || 'Segmentation failed');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Segmentation error:', error);
                showError('Segmentation failed. Please try again.');
            })
            .finally(() => {
                showLoading(false);
                setTimeout(() => showProgress(false), 1000);
            });
        }

        function displaySegmentationResult(result) {
            // Update segmentation info
            document.getElementById('segmentationInfo').style.display = 'block';
            document.getElementById('segType').textContent = result.model_type;
            document.getElementById('segVoxels').textContent = result.statistics.segmented_voxels.toLocaleString();
            document.getElementById('segVolume').textContent = result.statistics.volume_mm3.toFixed(2) + ' mm¬≥';
            document.getElementById('segTime').textContent = result.inference_time.toFixed(2) + 's';

            // Update statistics panel
            const statsPanel = document.getElementById('statisticsPanel');
            statsPanel.innerHTML = `
                <p><strong>Total Voxels:</strong> ${result.statistics.total_voxels.toLocaleString()}</p>
                <p><strong>Segmented:</strong> ${result.statistics.segmented_voxels.toLocaleString()}</p>
                <p><strong>Percentage:</strong> ${result.statistics.percentage.toFixed(2)}%</p>
                <p><strong>Volume:</strong> ${result.statistics.volume_mm3.toFixed(2)} mm¬≥</p>
                <p><strong>Processing Time:</strong> ${result.inference_time.toFixed(2)}s</p>
            `;

            // Add to history
            addToHistory(result);
        }

        function addToHistory(result) {
            const historyList = document.getElementById('historyList');
            if (historyList.querySelector('.empty-state')) {
                historyList.innerHTML = '';
            }

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <p><strong>${result.model_type}</strong></p>
                <p class="history-time">${new Date().toLocaleTimeString()}</p>
                <p class="history-stats">${result.statistics.percentage.toFixed(1)}% segmented</p>
            `;
            historyList.insertBefore(historyItem, historyList.firstChild);
        }

        function enableExportButtons() {
            document.getElementById('exportMask').disabled = false;
            document.getElementById('exportJSON').disabled = false;
            document.getElementById('exportVisualization').disabled = false;
            document.getElementById('exportReport').disabled = false;
        }

        function updateStudyInfo(metadata) {
            document.getElementById('patientName').textContent = metadata.patient_name || 'Unknown';
            document.getElementById('studyDate').textContent = metadata.study_date || 'Unknown';
            document.getElementById('modality').textContent = metadata.modality || 'Unknown';
        }

        function showLoading(show, message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            overlay.style.display = show ? 'flex' : 'none';
            messageEl.textContent = message;
        }

        function showProgress(show) {
            document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorOverlay').style.display = 'flex';
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        // Placeholder functions - will be implemented in segmentation-overlay.js
        function updateOverlayOpacity(value) { console.log('Update overlay opacity:', value); }
        function toggleOverlay() { console.log('Toggle overlay'); }
        function toggleOriginal() { console.log('Toggle original'); }
        function toggleBoundaries() { console.log('Toggle boundaries'); }
        function resetView() { console.log('Reset view'); }
        function takeScreenshot() { console.log('Take screenshot'); }
        function exportData(format) { console.log('Export data:', format); }
        function generateReport() { console.log('Generate report'); }
    </script>
</body>
</html>
