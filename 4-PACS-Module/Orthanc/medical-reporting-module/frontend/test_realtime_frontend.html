<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time STT Frontend Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Real-Time STT Frontend Test</h1>
        
        <!-- Test Results -->
        <div id="test-results" class="mb-8 p-4 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-output" class="space-y-2"></div>
        </div>
        
        <!-- Voice Demo Interface -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Voice Demo Test Interface</h2>
            
            <!-- Status Indicators -->
            <div class="mb-4 space-y-2">
                <div id="status-ready" class="flex items-center text-green-600">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>Ready for recording</span>
                </div>
                <div id="status-listening" class="flex items-center text-blue-600 hidden">
                    <i class="fas fa-microphone mr-2"></i>
                    <span>Listening...</span>
                </div>
                <div id="status-processing" class="flex items-center text-yellow-600 hidden">
                    <i class="fas fa-cog fa-spin mr-2"></i>
                    <span>Processing...</span>
                </div>
                <div id="status-error" class="flex items-center text-red-600 hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Error occurred</span>
                </div>
            </div>
            
            <!-- Microphone Button -->
            <div class="text-center mb-6">
                <button id="microphone-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full text-xl">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            
            <!-- Audio Visualizer -->
            <div id="audio-visualizer" class="flex justify-center items-end space-x-1 mb-6 h-16">
                <!-- Bars will be added by JavaScript -->
            </div>
            
            <!-- Transcription Area -->
            <div id="transcription-area" class="relative">
                <textarea id="report-text" class="w-full h-40 p-4 border rounded-lg resize-none" 
                          placeholder="Your voice transcription will appear here..."></textarea>
                <div class="mt-2 text-sm text-gray-500 flex justify-between">
                    <div>
                        <i class="fas fa-microphone mr-1"></i>
                        Real-time transcription with SA medical optimization
                    </div>
                    <div>
                        <span id="word-count">0 words</span> • 
                        <span id="char-count">0 characters</span>
                    </div>
                </div>
            </div>
            
            <!-- Control Buttons -->
            <div class="mt-4 flex justify-center space-x-4">
                <button id="clear-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-trash mr-2"></i>Clear
                </button>
                <button id="copy-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-copy mr-2"></i>Copy
                </button>
                <button id="test-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-flask mr-2"></i>Run Tests
                </button>
            </div>
        </div>
    </div>

    <!-- Load the voice demo script -->
    <script src="static/js/voice-demo.js"></script>
    
    <script>
        // Frontend testing functionality
        class RealTimeSTTTester {
            constructor() {
                this.testOutput = document.getElementById('test-output');
                this.voiceDemo = null;
                this.setupTestButton();
            }
            
            setupTestButton() {
                const testBtn = document.getElementById('test-btn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => this.runTests());
                }
            }
            
            log(message, type = 'info') {
                const div = document.createElement('div');
                const icon = type === 'success' ? 'check' : type === 'error' ? 'times' : 'info';
                const color = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';
                
                div.className = `flex items-center ${color}`;
                div.innerHTML = `<i class="fas fa-${icon} mr-2"></i><span>${message}</span>`;
                this.testOutput.appendChild(div);
                
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
            
            async runTests() {
                this.testOutput.innerHTML = '';
                this.log('Starting Real-Time STT Frontend Tests...', 'info');
                
                try {
                    // Test 1: Voice Demo Initialization
                    await this.testVoiceDemoInit();
                    
                    // Test 2: Chunk Queue Management
                    await this.testChunkQueue();
                    
                    // Test 3: Network Status Handling
                    await this.testNetworkHandling();
                    
                    // Test 4: Visual Feedback
                    await this.testVisualFeedback();
                    
                    // Test 5: Medical Text Enhancement
                    await this.testMedicalEnhancement();
                    
                    this.log('All frontend tests completed successfully!', 'success');
                    
                } catch (error) {
                    this.log(`Test failed: ${error.message}`, 'error');
                }
            }
            
            async testVoiceDemoInit() {
                this.log('Testing Voice Demo initialization...', 'info');
                
                // Initialize voice demo if not already done
                if (!window.voiceDemo) {
                    window.voiceDemo = new SAVoiceDemo();
                }
                this.voiceDemo = window.voiceDemo;
                
                // Check if required properties exist
                if (!this.voiceDemo.chunkQueue) {
                    throw new Error('Chunk queue not initialized');
                }
                
                if (!this.voiceDemo.processingChunks) {
                    throw new Error('Processing chunks map not initialized');
                }
                
                if (!this.voiceDemo.offlineQueue) {
                    throw new Error('Offline queue not initialized');
                }
                
                this.log('✓ Voice Demo initialized with real-time features', 'success');
            }
            
            async testChunkQueue() {
                this.log('Testing chunk queue management...', 'info');
                
                // Create mock audio blob
                const mockBlob = new Blob(['mock audio data'], { type: 'audio/webm' });
                
                // Test chunk queuing
                const initialQueueLength = this.voiceDemo.chunkQueue.length;
                this.voiceDemo.queueAudioChunk(mockBlob, 'test_chunk_001');
                
                if (this.voiceDemo.chunkQueue.length !== initialQueueLength + 1) {
                    throw new Error('Chunk not added to queue');
                }
                
                const chunk = this.voiceDemo.chunkQueue.find(c => c.id === 'test_chunk_001');
                if (!chunk) {
                    throw new Error('Chunk not found in queue');
                }
                
                if (chunk.status !== 'pending') {
                    throw new Error('Chunk status should be pending');
                }
                
                this.log('✓ Chunk queue management working', 'success');
            }
            
            async testNetworkHandling() {
                this.log('Testing network status handling...', 'info');
                
                // Test offline detection
                const originalOnline = this.voiceDemo.isOnline;
                
                // Simulate going offline
                this.voiceDemo.isOnline = false;
                
                const mockBlob = new Blob(['offline test'], { type: 'audio/webm' });
                const initialOfflineLength = this.voiceDemo.offlineQueue.length;
                
                this.voiceDemo.queueAudioChunk(mockBlob, 'offline_chunk_001');
                
                if (this.voiceDemo.offlineQueue.length !== initialOfflineLength + 1) {
                    throw new Error('Offline chunk not queued properly');
                }
                
                // Restore online status
                this.voiceDemo.isOnline = originalOnline;
                
                this.log('✓ Network status handling working', 'success');
            }
            
            async testVisualFeedback() {
                this.log('Testing visual feedback system...', 'info');
                
                // Test status updates
                this.voiceDemo.showStatus('listening', 'Test listening status');
                
                const listeningStatus = document.getElementById('status-listening');
                if (listeningStatus.classList.contains('hidden')) {
                    throw new Error('Listening status not shown');
                }
                
                // Test processing indicator
                this.voiceDemo.addProcessingIndicatorToTextArea(1, 2, 0, 0);
                
                const indicator = document.getElementById('processing-indicator');
                if (!indicator) {
                    throw new Error('Processing indicator not created');
                }
                
                // Clean up
                this.voiceDemo.removeProcessingIndicatorFromTextArea();
                this.voiceDemo.showStatus('ready', 'Ready for testing');
                
                this.log('✓ Visual feedback system working', 'success');
            }
            
            async testMedicalEnhancement() {
                this.log('Testing medical text enhancement...', 'info');
                
                // Test medical text enhancement
                const testText = 'patient has tb and high bp';
                const enhanced = this.voiceDemo.enhanceSAMedicalText(testText);
                
                if (!enhanced.includes('tuberculosis')) {
                    throw new Error('TB not expanded to tuberculosis');
                }
                
                if (!enhanced.includes('blood pressure')) {
                    throw new Error('BP not expanded to blood pressure');
                }
                
                // Test transcription appending
                const originalText = this.voiceDemo.transcriptionText;
                this.voiceDemo.appendTranscriptionChunk('Test medical text. ', 'test_chunk');
                
                if (this.voiceDemo.transcriptionText === originalText) {
                    throw new Error('Transcription text not updated');
                }
                
                this.log('✓ Medical text enhancement working', 'success');
            }
        }
        
        // Initialize tester when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.sttTester = new RealTimeSTTTester();
            
            // Auto-run tests after a short delay
            setTimeout(() => {
                window.sttTester.runTests();
            }, 1000);
        });
    </script>
</body>
</html>