<!doctype html>
<html lang="en-ZA">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SA PACS — Patient Imaging</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{
            --bg1: #002b36; /* deep */
            --accent: #f0b429; /* gold */
            --accent-2: #27ae60; /* green */
            --panel: rgba(255,255,255,0.96);
            --muted: #6b7280;
            --glass: rgba(255,255,255,0.06);
        }
        *{box-sizing:border-box}
        body{font-family:'Poppins',sans-serif;margin:0;background:linear-gradient(135deg,var(--bg1) 0%, #0b3d4a 100%);color:#072226;min-height:100vh}
        .wrap{max-width:1200px;margin:28px auto;padding:20px}
        header.appbar{display:flex;align-items:center;gap:16px;padding:18px;border-radius:14px;background:var(--panel);box-shadow:0 10px 30px rgba(2,6,23,0.4)}
        .brand{display:flex;align-items:center;gap:12px}
        .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,var(--accent-2),#1b8a59);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
        h1{font-size:20px;margin:0}
        p.lead{margin:0;color:var(--muted);font-size:13px}
        main{display:grid;grid-template-columns:320px 1fr;gap:20px;margin-top:20px}

        /* left panel */
        .panel{background:var(--panel);padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.2)}
        .panel h2{margin:0 0 12px 0;font-size:16px}
        .group{margin-bottom:14px}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
        input[type=text],select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;font-size:14px}
        .nas-options{display:flex;flex-direction:column;gap:8px}
        .nas-option{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:1px solid #eef3f4;cursor:pointer}
        .nas-option.selected{border-color:var(--accent-2);background:linear-gradient(90deg, rgba(39,174,96,0.06), transparent)}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
        .btn.primary{background:linear-gradient(90deg,var(--accent-2),#159a5a);color:white;font-weight:600}
        .btn.ghost{background:transparent;border:1px solid #e6eef0;color:white}
        .muted{color:var(--muted)}

        /* right column */
        .status{display:flex;flex-direction:column;gap:14px}
        .status .top{display:flex;align-items:center;justify-content:space-between}
        .status .card{display:flex;align-items:center;gap:12px}
        .dot{width:14px;height:14px;border-radius:50%;background:#95a5a6}
        .dot.ok{background:var(--accent-2);box-shadow:0 0 12px rgba(39,174,96,0.25)}
        .dot.err{background:#e74c3c}
        .progress{height:12px;background:#eef5f6;border-radius:8px;overflow:hidden}
        .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#f08a24);width:0%}

        /* results */
        .results{margin-top:6px}
        .row{display:flex;align-items:center;gap:12px}
        .card-result{background:white;border-radius:10px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
        .meta{color:var(--muted);font-size:13px}
        .share{background:linear-gradient(90deg,#9b59b6,#8e44ad);color:white;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}

        @media(max-width:880px){main{grid-template-columns:1fr}header.appbar{flex-direction:column;align-items:flex-start} .wrap{padding:12px}}
    </style>
</head>
<body>
    <div class="wrap">
        <header class="appbar">
            <div class="brand">
                <div class="logo">SA</div>
                <div>
                    <h1>SA PACS</h1>
                    <p class="lead">Find, preview and securely share a single series — fast, header-only indexing</p>
                </div>
            </div>
            <div style="margin-left:auto;text-align:right">
                <div style="font-size:12px;color:var(--muted)">Local Index Service</div>
                <div style="font-weight:600;color:#0b3d4a">Status: <span id="svcStatus">Ready</span></div>
            </div>
        </header>

        <main>
            <aside class="panel">
                <h2>Controls</h2>

                <div class="group">
                    <label>NAS Device Type</label>
                    <div class="nas-options">
                        <div class="nas-option selected" data-type="dicom"><i class="fa fa-file-medical"></i> DICOM Files</div>
                        <div class="nas-option" data-type="jpeg2000"><i class="fa fa-compress"></i> JPEG2000 / Firebird</div>
                        <div class="nas-option" data-type="mixed"><i class="fa fa-layer-group"></i> Mixed</div>
                    </div>
                </div>

                <div class="group">
                    <label for="searchInput">Search patient / study</label>
                    <input id="searchInput" type="text" placeholder="Name, ID, study description...">
                </div>

                <div class="group">
                    <button id="startBtn" class="btn primary"><i class="fa fa-play"></i> Start Indexing</button>
                </div>
                <div class="group">
                    <button id="searchBtn" class="btn" style="background:#f6f7f8;border-radius:8px"> <i class="fa fa-search"></i> Search</button>
                    <button id="clearBtn" class="btn" style="margin-left:8px">Clear</button>
                </div>
                <div class="group muted" style="font-size:13px">Note: This UI performs header-only indexing. Image pixels are not copied locally.</div>
            </aside>

            <section class="status">
                <div class="card panel top">
                    <div class="card">
                        <div class="dot" id="statusDot"></div>
                        <div>
                            <div id="statusMessage" style="font-weight:600">System Ready</div>
                            <div class="meta" id="statusSub">Waiting</div>
                        </div>
                    </div>
                    <div style="min-width:220px">
                        <div class="meta">Files processed: <span id="filesCount">0</span></div>
                        <div class="meta">Series indexed: <span id="seriesCount">0</span></div>
                    </div>
                </div>

                <div class="panel">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                        <div style="font-weight:600">Index Progress</div>
                        <div class="meta" id="progressPct">0%</div>
                    </div>
                    <div class="progress"><i id="progressBar"></i></div>
                </div>

                <div class="panel">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <div style="font-weight:600">Search Results</div>
                        <div class="meta" id="lastUpdated">Never</div>
                    </div>
                    <div class="results" id="results"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // UI state
        let nasType = 'dicom';
        const nasOptions = document.querySelectorAll('.nas-option');
        const statusDot = document.getElementById('statusDot');
        const statusMessage = document.getElementById('statusMessage');
        const statusSub = document.getElementById('statusSub');
        const progressBar = document.getElementById('progressBar');
        const progressPct = document.getElementById('progressPct');
        const filesCount = document.getElementById('filesCount');
        const seriesCount = document.getElementById('seriesCount');
        const resultsEl = document.getElementById('results');
        const svcStatus = document.getElementById('svcStatus');

        nasOptions.forEach(el=>el.addEventListener('click', ()=>{
            nasOptions.forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
            nasType = el.dataset.type || 'dicom';
            setStatus('info', `NAS mode: ${nasType.toUpperCase()}`);
        }));

        function setStatus(kind, text, sub=''){
            statusMessage.textContent = text;
            statusSub.textContent = sub;
            svcStatus.textContent = (kind==='info')? 'Running' : (kind==='success')? 'Ready' : (kind==='error')? 'Error' : 'Ready';
            statusDot.className = 'dot';
            if(kind==='success') statusDot.classList.add('ok');
            if(kind==='error') statusDot.classList.add('err');
        }

        function setProgress(p){
            progressBar.style.width = p + '%';
            progressPct.textContent = p + '%';
        }

        document.getElementById('startBtn').addEventListener('click', async ()=>{
            const btn = document.getElementById('startBtn');
            btn.disabled = true; btn.textContent = 'Starting...';
            setStatus('info','Starting indexing','This runs in background');
            try{
                const res = await fetch('/api/index/start',{method:'POST'});
                if(res.ok){ setStatus('success','Indexing started','Running in background'); }
                else{ const t = await res.text(); setStatus('error','Failed to start', t); }
            }catch(e){ setStatus('error','Start request failed', e.message);} finally{ btn.disabled=false; btn.innerHTML='<i class="fa fa-play"></i> Start Indexing'; }
        });

        document.getElementById('searchBtn').addEventListener('click', doSearch);
        document.getElementById('clearBtn').addEventListener('click', ()=>{ resultsEl.innerHTML=''; setStatus('info','Results cleared'); });
        document.getElementById('searchInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') doSearch(); });

        async function doSearch(){
            const q = document.getElementById('searchInput').value.trim();
            if(!q){ setStatus('error','Enter a search term'); return; }
            setStatus('info','Searching', `for ${q}`);
            try{
                const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                if(!r.ok) throw new Error('Search failed');
                const data = await r.json();
                renderResults(data);
                setStatus('success', `Found ${data.length} result(s)`, 'Search completed');
            }catch(e){ setStatus('error','Search error', e.message); }
        }

        function renderResults(list){
            resultsEl.innerHTML = '';
            if(!list || list.length===0){ resultsEl.innerHTML = '<div class="meta" style="padding:18px">No results</div>'; return; }
            list.forEach(item=>{
                const div = document.createElement('div'); div.className='card-result';
                const left = document.createElement('div');
                left.innerHTML = `<div style="font-weight:600">${escapeHtml(item.PatientName||'Unknown')}</div><div class="meta">ID: ${escapeHtml(item.PatientID||'N/A')} • ${escapeHtml(item.StudyDate||'')}</div>`;
                const right = document.createElement('div');
                right.innerHTML = `<div class="meta">${escapeHtml(item.StudyDescription||'')}</div><div style="margin-top:8px"><button class="share" onclick="createShare('${encodeURIComponent(item.SeriesInstanceUID||item.SeriesKey||'')}', '${escapeForAttr(item.StudyInstanceUID||'')}')">Share</button></div>`;
                div.appendChild(left); div.appendChild(right);
                resultsEl.appendChild(div);
            });
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-ZA');
        }

        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
        function escapeForAttr(s){ return (s||'').replace(/'/g, "\\'"); }

        window.createShare = async function(seriesId, studyId){
            // Placeholder: call backend to create a secure, time-limited share for the series
            alert('Creating share for series: ' + decodeURIComponent(seriesId));
            // Example: POST /api/share { series: seriesId, ttl: 86400 }
        }

        // Polling index status every 3s
        setInterval(async ()=>{
            try{
                const r = await fetch('/api/index/status');
                if(!r.ok) return;
                const s = await r.json();
                // expect {status:'enumerating'|'indexing'|'complete'|'idle'|'error', percent: int, files: int, series: int, message: ''}
                if(s.status === 'enumerating') setStatus('info','Enumerating files', s.message||'');
                else if(s.status === 'indexing') setStatus('info','Indexing headers', s.message||'');
                else if(s.status === 'complete') setStatus('success','Indexing complete', s.message||'');
                else if(s.status === 'error') setStatus('error','Indexing error', s.message||'');
                else setStatus('success','Idle', 'Ready');
                setProgress(s.percent||0);
                filesCount.textContent = s.files||0; seriesCount.textContent = s.series||0;
            }catch(e){ /* ignore transient errors */ }
        },3000);

        // initial
        setStatus('success','Ready'); setProgress(0);
    </script>
</body>
</html>
