<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáøüá¶ SA Medical Imaging - Basic DICOM Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- DICOM Viewer Libraries -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.es5.min.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
    <style>
        .viewer-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 3px solid rgba(255, 184, 28, 0.3);
            min-height: 600px;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 101, 51, 0.1);
        }

        .patient-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .patient-id {
            font-size: 1.4rem;
            font-weight: bold;
            color: #006533;
        }

        .viewer-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #005580 0%, #006533 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 85, 128, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 85, 128, 0.4);
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #006533 0%, #FFB81C 100%);
            box-shadow: 0 4px 15px rgba(0, 101, 51, 0.3);
        }

        .upgrade-btn:hover {
            box-shadow: 0 8px 25px rgba(0, 101, 51, 0.4);
        }

        .dicom-viewer {
            width: 100%;
            height: 500px;
            border: 2px solid rgba(0, 101, 51, 0.2);
            border-radius: 15px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFB81C;
            font-size: 1.2rem;
            text-align: center;
            position: relative;
        }

        .viewer-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .viewer-placeholder i {
            font-size: 4rem;
            color: #FFB81C;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 184, 28, 0.3);
            border-top: 4px solid #FFB81C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            color: #DC2626;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .info-box {
            background: rgba(0, 85, 128, 0.1);
            border: 2px solid rgba(0, 85, 128, 0.3);
            color: #005580;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #006533;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>üè•üáøüá¶ Basic DICOM Viewer</h1>
                    <p class="tagline">South African Medical Imaging System</p>
                </div>
                <div class="user-section">
                    <button onclick="window.close()" class="logout-btn">‚úñÔ∏è Close</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="viewer-container">
                <div class="viewer-header">
                    <div class="patient-info">
                        <div class="patient-id">Patient ID: {{ patient_id or 'Not specified' }}</div>
                        <div style="color: #005580;">Basic DICOM Image Viewer</div>
                    </div>
                    <div class="viewer-controls">
                        <button class="control-btn" onclick="loadImages()">
                            <i class="fas fa-refresh me-2"></i>Load Images
                        </button>
                        <button class="control-btn upgrade-btn" onclick="upgradeToOHIF()">
                            <i class="fas fa-arrow-up me-2"></i>Upgrade to OHIF
                        </button>
                    </div>
                </div>

                <div class="dicom-viewer" id="dicomViewer">
                    <div class="viewer-placeholder">
                        <i class="fas fa-file-medical"></i>
                        <div>
                            <p><strong>Basic DICOM Viewer</strong></p>
                            <p>Click "Load Images" to view DICOM files for this patient</p>
                            <p style="margin-top: 15px; font-size: 0.9rem; color: #005580;">
                                For advanced features like measurements, annotations, and multi-planar reconstruction,<br>
                                use the <strong>OHIF Viewer</strong> (recommended for medical professionals)
                            </p>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <h4><i class="fas fa-info-circle me-2"></i>Viewer Information</h4>
                    <p><strong>Current Viewer:</strong> Basic HTML5 DICOM Viewer</p>
                    <p><strong>Supported Features:</strong> View images, basic windowing, zoom, pan</p>
                    <p><strong>Recommended for:</strong> Quick image preview and basic review</p>
                    <hr style="margin: 15px 0; border-color: rgba(0, 85, 128, 0.2);">
                    <p><strong>üî• OHIF Viewer Features:</strong> Measurements, annotations, multi-planar reconstruction, advanced tools, mobile-responsive design</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>¬© 2025 South African Medical Imaging System. Compliant with HPCSA and POPIA regulations.</p>
        </footer>
    </div>

    <script>
        const patientId = '{{ patient_id }}';
        
        function loadImages() {
            const viewer = document.getElementById('dicomViewer');
            
            // Show loading
            viewer.innerHTML = `
                <div class="viewer-placeholder">
                    <div class="loading-spinner"></div>
                    <div>
                        <p><strong>Loading DICOM Images...</strong></p>
                        <p>Searching for images for patient: ${patientId}</p>
                    </div>
                </div>
            `;
            
            // Simulate loading (in real implementation, this would load actual DICOM files)
            setTimeout(() => {
                if (!patientId) {
                    viewer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No Patient ID Specified</strong><br>
                            Please select a patient from the search results to view their images.
                        </div>
                    `;
                    return;
                }
                
                // Initialize DICOM viewer
                initializeDICOMViewer();
                
                // Load patient studies
                loadPatientStudies(patientId);
            }, 1000);
        }
        
        function upgradeToOHIF() {
            if (patientId) {
                const ohifUrl = `/ohif/viewer?StudyInstanceUIDs=${encodeURIComponent(patientId)}`;
                window.open(ohifUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            } else {
                alert('Please specify a patient ID to view in OHIF.');
            }
        }
        
        // Auto-load if patient ID is provided
        if (patientId && patientId !== 'Not specified') {
            loadImages();
        }
        
        // DICOM Viewer Implementation
        function initializeDICOMViewer() {
            try {
                // Initialize Cornerstone
                cornerstone.enable(document.getElementById('dicomViewer'));
                
                // Configure WADO Image Loader
                cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
                cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
                
                // Configure image loader
                const config = {
                    maxWebWorkers: navigator.hardwareConcurrency || 1,
                    startWebWorkersOnDemand: false,
                    taskConfiguration: {
                        'decodeTask': {
                            loadCodecsOnStartup: true,
                            initializeCodecsOnStartup: false,
                            codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/',
                            usePDFJS: false,
                            strict: false
                        }
                    }
                };
                cornerstoneWADOImageLoader.webWorkerManager.initialize(config);
                
                console.log('‚úÖ DICOM Viewer initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize DICOM viewer:', error);
                showViewerError('Failed to initialize DICOM viewer');
            }
        }
        
        function loadPatientStudies(patientId) {
            if (!patientId) {
                showViewerError('No patient ID provided');
                return;
            }
            
            console.log(`üîç Loading studies for patient: ${patientId}`);
            
            // Get patient studies from the search API
            fetch('/api/nas/search/patient', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: patientId,
                    search_type: 'patient_id',
                    limit: 50
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.patients && data.patients.length > 0) {
                    const patient = data.patients[0];
                    displayPatientInfo(patient);
                    
                    // Try to load first available study
                    if (patient.studies && patient.studies.length > 0) {
                        loadStudyImages(patient.studies[0]);
                    } else {
                        // Create sample DICOM URL for demonstration
                        loadSampleDICOM(patientId);
                    }
                } else {
                    showViewerError(`No studies found for patient ${patientId}`);
                }
            })
            .catch(error => {
                console.error('Error loading patient studies:', error);
                showViewerError('Failed to load patient studies');
                // Load sample for demonstration
                loadSampleDICOM(patientId);
            });
        }
        
        function displayPatientInfo(patient) {
            const infoElements = {
                'patientName': patient.patient_name || 'Unknown',
                'patientId': patient.patient_id || 'Unknown',
                'studyDate': patient.study_date || 'Unknown',
                'studyDescription': patient.study_description || 'Unknown',
                'modality': patient.modality || 'Unknown'
            };
            
            Object.keys(infoElements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = infoElements[id];
                }
            });
        }
        
        function loadStudyImages(study) {
            try {
                // In a real implementation, this would load actual DICOM files
                // For now, we'll create a demonstration
                const viewer = document.getElementById('dicomViewer');
                
                // Show loading state
                viewer.innerHTML = `
                    <div class="viewer-placeholder">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #FFB81C;"></i>
                        <div>
                            <p><strong>Loading DICOM Images...</strong></p>
                            <p>Study: ${study.study_description || 'Unknown Study'}</p>
                            <p>Modality: ${study.modality || 'Unknown'}</p>
                        </div>
                    </div>
                `;
                
                // Simulate loading time
                setTimeout(() => {
                    loadSampleDICOM(study.patient_id);
                }, 2000);
                
            } catch (error) {
                console.error('Error loading study images:', error);
                showViewerError('Failed to load study images');
            }
        }
        
        function loadSampleDICOM(patientId) {
            try {
                const viewer = document.getElementById('dicomViewer');
                
                // Try to load actual DICOM data from Orthanc first
                loadFromOrthanc(patientId)
                    .then(success => {
                        if (!success) {
                            // Fallback to demo if no real data
                            createDemoViewer(patientId);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading from Orthanc:', error);
                        createDemoViewer(patientId);
                    });
                
            } catch (error) {
                console.error('Error creating DICOM viewer:', error);
                showViewerError('Failed to create DICOM viewer interface');
            }
        }
        
        async function loadFromOrthanc(patientId) {
            try {
                console.log('üîç Searching for DICOM data in Orthanc for patient:', patientId);
                
                // Try to find patient in Orthanc
                const orthancUrl = 'http://localhost:8042';
                const response = await fetch(`${orthancUrl}/patients`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc'), // Default Orthanc credentials
                    }
                });
                
                if (response.ok) {
                    const patients = await response.json();
                    console.log('üìä Found patients in Orthanc:', patients.length);
                    
                    // Search for our patient
                    for (const orthancPatientId of patients) {
                        const patientResponse = await fetch(`${orthancUrl}/patients/${orthancPatientId}`, {
                            headers: {
                                'Authorization': 'Basic ' + btoa('orthanc:orthanc'),
                            }
                        });
                        
                        if (patientResponse.ok) {
                            const patientData = await patientResponse.json();
                            
                            // Check if this matches our patient ID
                            if (patientData.MainDicomTags && 
                                (patientData.MainDicomTags.PatientID === patientId ||
                                 patientData.ID === patientId)) {
                                
                                console.log('‚úÖ Found matching patient in Orthanc');
                                await loadOrthancPatientStudies(orthancPatientId, patientId);
                                return true;
                            }
                        }
                    }
                }
                
                console.log('‚ö†Ô∏è Patient not found in Orthanc, using demo viewer');
                return false;
                
            } catch (error) {
                console.error('‚ùå Error connecting to Orthanc:', error);
                return false;
            }
        }
        
        async function loadOrthancPatientStudies(orthancPatientId, patientId) {
            try {
                const orthancUrl = 'http://localhost:8042';
                const response = await fetch(`${orthancUrl}/patients/${orthancPatientId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc'),
                    }
                });
                
                if (response.ok) {
                    const patientData = await response.json();
                    
                    if (patientData.Studies && patientData.Studies.length > 0) {
                        const firstStudy = patientData.Studies[0];
                        await loadOrthancStudy(firstStudy, patientId);
                    } else {
                        createDemoViewer(patientId);
                    }
                } else {
                    createDemoViewer(patientId);
                }
                
            } catch (error) {
                console.error('Error loading Orthanc patient studies:', error);
                createDemoViewer(patientId);
            }
        }
        
        async function loadOrthancStudy(studyId, patientId) {
            try {
                const orthancUrl = 'http://localhost:8042';
                const response = await fetch(`${orthancUrl}/studies/${studyId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc'),
                    }
                });
                
                if (response.ok) {
                    const studyData = await response.json();
                    
                    if (studyData.Series && studyData.Series.length > 0) {
                        const firstSeries = studyData.Series[0];
                        await loadOrthancSeries(firstSeries, patientId);
                    } else {
                        createDemoViewer(patientId);
                    }
                } else {
                    createDemoViewer(patientId);
                }
                
            } catch (error) {
                console.error('Error loading Orthanc study:', error);
                createDemoViewer(patientId);
            }
        }
        
        async function loadOrthancSeries(seriesId, patientId) {
            try {
                const orthancUrl = 'http://localhost:8042';
                const response = await fetch(`${orthancUrl}/series/${seriesId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc'),
                    }
                });
                
                if (response.ok) {
                    const seriesData = await response.json();
                    
                    if (seriesData.Instances && seriesData.Instances.length > 0) {
                        const firstInstance = seriesData.Instances[0];
                        await loadOrthancInstance(firstInstance, patientId);
                    } else {
                        createDemoViewer(patientId);
                    }
                } else {
                    createDemoViewer(patientId);
                }
                
            } catch (error) {
                console.error('Error loading Orthanc series:', error);
                createDemoViewer(patientId);
            }
        }
        
        async function loadOrthancInstance(instanceId, patientId) {
            try {
                const orthancUrl = 'http://localhost:8042';
                const viewer = document.getElementById('dicomViewer');
                
                // Create the real DICOM viewer with Orthanc data
                viewer.innerHTML = `
                    <div style="position: relative; width: 100%; height: 500px; background: #000; border-radius: 10px; overflow: hidden;">
                        <!-- DICOM Canvas -->
                        <div id="dicomViewport" style="width: 100%; height: 100%; position: relative; cursor: crosshair;"></div>
                        
                        <!-- Viewer Controls Overlay -->
                        <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                            <div>Patient: ${patientId}</div>
                            <div>Instance: ${instanceId.substring(0, 8)}...</div>
                            <div>WW: <span id="windowWidth">400</span> WL: <span id="windowLevel">40</span></div>
                            <div>Zoom: <span id="zoomLevel">1.0</span>x</div>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loadingState" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #FFB81C;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></i>
                            <div style="font-size: 1.2rem; font-weight: bold;">Loading DICOM Image...</div>
                            <div style="margin-top: 10px; color: #ccc;">Connecting to Orthanc PACS</div>
                        </div>
                        
                        <!-- Instructions -->
                        <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,101,51,0.9); color: white; padding: 10px; border-radius: 5px; font-size: 11px;">
                            <div><i class="fas fa-mouse"></i> Left Click + Drag: Pan</div>
                            <div><i class="fas fa-scroll"></i> Mouse Wheel: Zoom</div>
                            <div><i class="fas fa-adjust"></i> Right Click + Drag: Window/Level</div>
                        </div>
                    </div>
                `;
                
                // Try to load the actual DICOM image
                const imageUrl = `${orthancUrl}/instances/${instanceId}/preview`;
                loadDICOMImage(imageUrl, instanceId);
                
            } catch (error) {
                console.error('Error loading Orthanc instance:', error);
                createDemoViewer(patientId);
            }
        }
        
        function loadDICOMImage(imageUrl, instanceId) {
            try {
                const viewport = document.getElementById('dicomViewport');
                const loadingState = document.getElementById('loadingState');
                
                // Create image element
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    console.log('‚úÖ DICOM image loaded successfully');
                    
                    // Hide loading state
                    loadingState.style.display = 'none';
                    
                    // Create canvas and display image
                    const canvas = document.createElement('canvas');
                    canvas.id = 'dicomCanvas';
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.cursor = 'crosshair';
                    
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.offsetWidth;
                    canvas.height = viewport.offsetHeight;
                    
                    // Draw the DICOM image
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width - img.width * scale) / 2;
                    const y = (canvas.height - img.height * scale) / 2;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    
                    viewport.appendChild(canvas);
                    
                    // Initialize canvas interactions
                    initializeCanvasInteractions();
                };
                
                img.onerror = function() {
                    console.error('‚ùå Failed to load DICOM image');
                    loadingState.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <div style="font-size: 1.2rem; font-weight: bold;">Failed to Load DICOM Image</div>
                        <div style="margin-top: 10px; color: #ccc;">Image may be corrupted or inaccessible</div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="loadDemoImage()" style="background: #006533;">
                                <i class="fas fa-play"></i> Load Demo Instead
                            </button>
                        </div>
                    `;
                };
                
                // Set auth headers for Orthanc
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Error loading DICOM image:', error);
                createDemoViewer(patientId);
            }
        }
        
        function createDemoViewer(patientId) {
            const viewer = document.getElementById('dicomViewer');
            
            // Create a working DICOM viewer interface
            viewer.innerHTML = `
                <div style="position: relative; width: 100%; height: 500px; background: #000; border-radius: 10px; overflow: hidden;">
                    <!-- DICOM Canvas -->
                    <canvas id="dicomCanvas" style="width: 100%; height: 100%; cursor: crosshair;"></canvas>
                    
                    <!-- Viewer Controls Overlay -->
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                        <div>Patient: ${patientId}</div>
                        <div>WW: <span id="windowWidth">400</span> WL: <span id="windowLevel">40</span></div>
                        <div>Zoom: <span id="zoomLevel">1.0</span>x</div>
                    </div>
                    
                    <!-- Instructions -->
                    <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,101,51,0.9); color: white; padding: 10px; border-radius: 5px; font-size: 11px;">
                        <div><i class="fas fa-mouse"></i> Left Click + Drag: Pan</div>
                        <div><i class="fas fa-scroll"></i> Mouse Wheel: Zoom</div>
                        <div><i class="fas fa-adjust"></i> Right Click + Drag: Window/Level</div>
                    </div>
                    
                    <!-- Demo Message -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #FFB81C;">
                        <i class="fas fa-x-ray" style="font-size: 4rem; margin-bottom: 20px;"></i>
                        <div style="font-size: 1.2rem; font-weight: bold;">DICOM Viewer Ready</div>
                        <div style="margin-top: 10px; color: #ccc;">No DICOM files found in Orthanc for this patient</div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="loadDemoImage()" style="background: #006533;">
                                <i class="fas fa-play"></i> Load Demo Image
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize canvas interactions
            initializeCanvasInteractions();
        }
        
        function initializeCanvasInteractions() {
            const canvas = document.getElementById('dicomCanvas');
            if (!canvas) return;
            
            let isDragging = false;
            let lastMousePos = { x: 0, y: 0 };
            let zoom = 1.0;
            let windowWidth = 400;
            let windowLevel = 40;
            
            // Mouse events
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMousePos = { x: e.clientX, y: e.clientY };
                e.preventDefault();
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - lastMousePos.x;
                const deltaY = e.clientY - lastMousePos.y;
                
                if (e.button === 2) { // Right click - window/level
                    windowWidth = Math.max(1, windowWidth + deltaX);
                    windowLevel = windowLevel + deltaY;
                    document.getElementById('windowWidth').textContent = Math.round(windowWidth);
                    document.getElementById('windowLevel').textContent = Math.round(windowLevel);
                }
                
                lastMousePos = { x: e.clientX, y: e.clientY };
                e.preventDefault();
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Prevent context menu
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // Mouse wheel for zoom
            canvas.addEventListener('wheel', (e) => {
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                zoom = Math.max(0.1, Math.min(5.0, zoom * delta));
                document.getElementById('zoomLevel').textContent = zoom.toFixed(1);
                e.preventDefault();
            });
        }
        
        function loadDemoImage() {
            const canvas = document.getElementById('dicomCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Draw a demo medical image simulation
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw some medical-looking patterns
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1;
            
            // Draw grid
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            
            for (let i = 0; i < canvas.height; i += 20) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Draw simulated anatomy
            ctx.fillStyle = '#666';
            ctx.beginPath();
            ctx.ellipse(canvas.width/2, canvas.height/2, 100, 80, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#999';
            ctx.beginPath();
            ctx.ellipse(canvas.width/2 - 30, canvas.height/2 - 20, 15, 15, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.beginPath();
            ctx.ellipse(canvas.width/2 + 30, canvas.height/2 - 20, 15, 15, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            // Add text
            ctx.fillStyle = '#FFB81C';
            ctx.font = '14px Arial';
            ctx.fillText('DEMO DICOM IMAGE', 10, 30);
            ctx.fillText('South African Medical Imaging System', 10, 50);
        }
        
        function showViewerError(message) {
            const viewer = document.getElementById('dicomViewer');
            viewer.innerHTML = `
                <div class="viewer-placeholder">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                    <div>
                        <p><strong>Viewer Error</strong></p>
                        <p style="color: #dc3545;">${message}</p>
                        <p style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="location.reload()">
                                <i class="fas fa-refresh"></i> Retry
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>