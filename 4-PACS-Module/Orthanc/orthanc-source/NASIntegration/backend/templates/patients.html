<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáøüá¶ SA Medical Imaging - Patient Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MCP Access Control -->
    <script src="{{ url_for('static', filename='js/mcp-access-control.js') }}" defer></script>
    <style>
        /* Additional styles for patient search */
        .search-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 3px solid rgba(255, 184, 28, 0.3);
        }

        .search-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-tab {
            background: rgba(255, 255, 255, 0.9);
            color: #006533;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-tab.active {
            background: linear-gradient(135deg, #FFB81C 0%, #F59E0B 100%);
            color: #1F2937;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }

        .search-tab:hover:not(.active) {
            background: linear-gradient(135deg, #006533 0%, #005580 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 101, 51, 0.3);
        }

        .search-box-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 20px 60px 20px 25px;
            font-size: 1.2rem;
            border: 3px solid rgba(0, 101, 51, 0.2);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
        }

        .search-box:focus {
            border-color: #FFB81C;
            box-shadow: 0 0 20px rgba(255, 184, 28, 0.3);
            background: white;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #006533;
            font-size: 1.3rem;
        }

        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid rgba(255, 184, 28, 0.3);
            border-radius: 15px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .suggestion-group {
            border-bottom: 2px solid rgba(0, 101, 51, 0.1);
        }

        .suggestion-group:last-child {
            border-bottom: none;
        }

        .suggestion-header {
            padding: 15px 20px 10px;
            font-weight: 700;
            color: #006533;
            background: linear-gradient(135deg, #f8f9fa 0%, rgba(255, 184, 28, 0.1) 100%);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .suggestion-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .suggestion-item:hover {
            background: rgba(255, 184, 28, 0.1);
            border-left-color: #FFB81C;
        }

        .suggestion-item.selected {
            background: linear-gradient(135deg, rgba(0, 101, 51, 0.1) 0%, rgba(255, 184, 28, 0.1) 100%);
            border-left-color: #006533;
        }

        .suggestion-text {
            font-weight: 600;
            color: #006533;
            margin-bottom: 3px;
        }

        .suggestion-meta {
            font-size: 0.9rem;
            color: #005580;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid rgba(0, 101, 51, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #006533 0%, #FFB81C 50%, #005580 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #006533;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #005580;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Quick Access Buttons */
        .quick-access-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .quick-access-section h3 {
            color: #006533;
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .quick-access-section h3 i {
            margin-right: 10px;
            color: #FFB81C;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(0, 101, 51, 0.2);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            text-align: left;
            font-family: inherit;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .quick-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #FFB81C;
        }

        .quick-btn i {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        .today-btn {
            border-left: 5px solid #28a745;
        }

        .today-btn i {
            color: #28a745;
        }

        .yesterday-btn {
            border-left: 5px solid #ffc107;
        }

        .yesterday-btn i {
            color: #ffc107;
        }

        .week-btn {
            border-left: 5px solid #006533;
        }

        .week-btn i {
            color: #006533;
        }

        .btn-content {
            display: flex;
            flex-direction: column;
        }

        .btn-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #006533;
            margin-bottom: 5px;
        }

        .btn-subtitle {
            font-size: 0.9rem;
            color: #005580;
            opacity: 0.8;
        }

        .results-section {
            display: none;
        }

        .results-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 3px solid rgba(0, 101, 51, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-header h2 {
            color: #006533;
            font-size: 1.8rem;
            margin: 0;
        }

        .results-count {
            background: linear-gradient(135deg, #FFB81C 0%, #F59E0B 100%);
            color: #1F2937;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 2px solid rgba(0, 101, 51, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #006533 0%, #FFB81C 50%, #005580 100%);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border-color: rgba(255, 184, 28, 0.4);
        }

        .patient-name {
            font-size: 1.6rem;
            font-weight: bold;
            color: #006533;
            margin-bottom: 15px;
        }

        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 101, 51, 0.1);
        }

        .detail-label {
            font-weight: 600;
            color: #005580;
        }

        .detail-value {
            color: #006533;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            color: #005580;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 101, 51, 0.2);
            border-top: 5px solid #006533;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #005580;
        }

        .no-results-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            color: #FFB81C;
        }

        .no-results h3 {
            color: #006533;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        /* Patient Action Buttons */
        .patient-actions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid rgba(0, 101, 51, 0.1);
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            min-width: 140px;
            justify-content: center;
        }

        .primary-btn {
            background: linear-gradient(135deg, #006533 0%, #FFB81C 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 101, 51, 0.3);
            font-weight: bold;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 101, 51, 0.4);
            background: linear-gradient(135deg, #005580 0%, #FFB81C 100%);
        }

        .basic-btn {
            background: linear-gradient(135deg, #005580 0%, #006533 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 85, 128, 0.3);
        }

        .basic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 85, 128, 0.4);
            background: linear-gradient(135deg, #FFB81C 0%, #006533 100%);
        }

        .download-btn {
            background: linear-gradient(135deg, #FFB81C 0%, #005580 100%);
            color: #1F2937;
            box-shadow: 0 4px 15px rgba(255, 184, 28, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 184, 28, 0.4);
            background: linear-gradient(135deg, #006533 0%, #005580 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>üè•üáøüá¶ Patient Management System</h1>
                    <p class="tagline">Advanced Patient Search & Medical Record Management</p>
                </div>
                <div class="user-section">
                    <span>Welcome, {{ session.get('user_type', 'User').title() }}!</span>
                    <button onclick="logout()" class="logout-btn">üö™ Logout</button>
                </div>
            </div>
        </header>

        <nav class="navigation" role="navigation" aria-label="Main navigation">
            <a href="/" class="nav-link">üè† Dashboard</a>
            <a href="/patients" class="nav-link active">üë• Patient Management</a>
            <a href="/nas-integration" class="nav-link">üìÅ NAS Integration</a>
            <a href="/device-discovery" class="nav-link">üîç Device Discovery</a>
            {% if session.get('user_type') == 'admin' %}
            <a href="/device-management" class="nav-link">üß∞ Device Management</a>
            <a href="/admin" class="nav-link">‚öôÔ∏è Admin</a>
            {% endif %}
        </nav>

        <main class="main-content">
            <div class="welcome-section">
                <h2>üîç Advanced Patient Search</h2>
                <p>Search through medical records with intelligent suggestions and comprehensive filtering options.</p>
            </div>

            <!-- Cloud Connect Buttons -->
            <div class="cloud-connect" style="display:flex;gap:12px;align-items:center;margin-bottom:18px;">
                <button id="onedriveConnectBtn" class="btn" style="background:linear-gradient(135deg,#0078d4,#005a9e);color:white;padding:10px 14px;border-radius:8px;border:none;">Connect OneDrive</button>
                <span id="onedriveStatus" style="color:#555;font-weight:600;">Checking OneDrive‚Ä¶</span>
                <button id="gdriveConnectBtn" class="btn" style="background:linear-gradient(135deg,#0f9d58,#0b7a45);color:white;padding:10px 14px;border-radius:8px;border:none;">Connect Google Drive</button>
                <span id="gdriveStatus" style="color:#555;font-weight:600;">Checking Google Drive‚Ä¶</span>
            </div>

            <!-- Search Container -->
            <div class="search-container">
                <div class="search-tabs">
                    <button class="search-tab active" data-type="all">
                        <i class="fas fa-search me-2"></i>All Types
                    </button>
                    <button class="search-tab" data-type="names">
                        <i class="fas fa-user me-2"></i>Patient Names
                    </button>
                    <button class="search-tab" data-type="ids">
                        <i class="fas fa-id-card me-2"></i>Patient IDs
                    </button>
                    <button class="search-tab" data-type="dates">
                        <i class="fas fa-calendar me-2"></i>Study Dates
                    </button>
                </div>

                <div class="search-box-container">
                    <input 
                        type="text" 
                        class="search-box" 
                        id="searchBox"
                        placeholder="Start typing patient name, ID, or date... (e.g., 'Smith', '000000123', '2024-09')"
                        autocomplete="off"
                    >
                    <i class="fas fa-search search-icon"></i>
                    
                    <div class="suggestions-container" id="suggestionsContainer">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2 id="resultsTitle">Search Results</h2>
                    <span class="results-count" id="resultsCount">0 results</span>
                </div>
                <div id="resultsContainer">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Quick Access Buttons -->
            <div class="quick-access-section">
                <h3><i class="fas fa-calendar-day"></i> Quick Patient Access</h3>
                <div class="quick-buttons">
                    <button class="btn quick-btn today-btn" onclick="loadTodayPatients()">
                        <i class="fas fa-calendar-check"></i>
                        <div class="btn-content">
                            <span class="btn-title">Today's Patients</span>
                            <span class="btn-subtitle" id="todayCount">Loading...</span>
                        </div>
                    </button>
                    
                    <button class="btn quick-btn yesterday-btn" onclick="loadYesterdayPatients()">
                        <i class="fas fa-calendar-minus"></i>
                        <div class="btn-content">
                            <span class="btn-title">Yesterday's Patients</span>
                            <span class="btn-subtitle" id="yesterdayCount">Loading...</span>
                        </div>
                    </button>
                    
                    <button class="btn quick-btn week-btn" onclick="loadWeekPatients()">
                        <i class="fas fa-calendar-week"></i>
                        <div class="btn-content">
                            <span class="btn-title">This Week</span>
                            <span class="btn-subtitle" id="weekCount">Loading...</span>
                        </div>
                    </button>
                </div>
            </div>
        </main>

        <!-- System Status Footer -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-icon">üóÑÔ∏è</span>
                <span class="status-text">Database: <span class="status-online">‚úÖ Connected</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon">üåê</span>
                <span class="status-text">Network: <span class="status-online">‚úÖ Online</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon">üíæ</span>
                <span class="status-text">Storage: <span class="status-online">‚úÖ Available</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon">üîí</span>
                <span class="status-text">Security: <span class="status-online">‚úÖ Secure</span></span>
            </div>
        </div>

        <footer class="footer">
            <p>¬© 2025 South African Medical Imaging System. Compliant with HPCSA and POPIA regulations.</p>
        </footer>
    </div>

    <script>
        // Consolidated client script - refactored for clarity
        (function () {
            'use strict';

            // Logout
            function logout() {
                fetch('/api/auth/logout', { method: 'POST' }).finally(() => { window.location.href = '/login'; });
            }

            // Minimal API helper
            const SearchAPI = {
                async suggestions(q, type = 'all', limit = 15) {
                    const res = await fetch(`/api/nas/search/suggestions?q=${encodeURIComponent(q)}&type=${type}&limit=${limit}`);
                    if (!res.ok) throw new Error('Failed to fetch suggestions');
                    return res.json();
                },
                async searchPatients(params) {
                    const res = await fetch('/api/nas/search/patient', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
                    if (!res.ok) throw new Error('Search failed');
                    return res.json();
                }
            };

            // Refactored PatientSearchSystem (smaller, clearer)
            class PatientSearchSystem {
                constructor() {
                    this.searchBox = document.getElementById('searchBox');
                    this.suggestionsContainer = document.getElementById('suggestionsContainer');
                    this.resultsSection = document.getElementById('resultsSection');
                    this.resultsContainer = document.getElementById('resultsContainer');
                    this.type = 'all';
                    this.selected = -1;
                    this.debounce = null;
                    this.bind();
                }

                bind() {
                    this.searchBox.addEventListener('input', (e) => this.onInput(e.target.value));
                    this.searchBox.addEventListener('keydown', (e) => this.onKey(e));
                    this.searchBox.addEventListener('blur', () => setTimeout(() => this.hideSuggestions(), 200));
                    this.searchBox.addEventListener('focus', () => { if (this.searchBox.value.trim()) this.getSuggestions(this.searchBox.value.trim()); });

                    document.querySelectorAll('.search-tab').forEach(tab => tab.addEventListener('click', (e) => this.setType(e.currentTarget.dataset.type)));

                    this.suggestionsContainer.addEventListener('click', (e) => {
                        const item = e.target.closest('.suggestion-item');
                        if (!item) return;
                        const text = item.dataset.text;
                        this.searchBox.value = text;
                        this.hideSuggestions();
                        this.search(text);
                    });

                    document.addEventListener('click', (e) => { if (!e.target.closest('.search-box-container')) this.hideSuggestions(); });
                }

                setType(t) { this.type = t; document.querySelectorAll('.search-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.type === t)); this.searchBox.placeholder = { all: 'Start typing patient name, ID, or date...', names: 'Type patient name (e.g., Smith, Johnson)...', ids: 'Type patient ID (e.g., 000000123)...', dates: 'Type study date (e.g., 2024, 2024-09)...' }[t] || '';
                    if (this.searchBox.value.trim()) this.getSuggestions(this.searchBox.value.trim()); }

                onInput(v) { clearTimeout(this.debounce); if (!v.trim()) { this.hideSuggestions(); this.hideResults(); return; } this.debounce = setTimeout(() => this.getSuggestions(v.trim()), 300); }

                onKey(e) {
                    const visible = this.suggestionsContainer.style.display !== '' && this.suggestionsContainer.style.display !== 'none';
                    if (!visible) { if (e.key === 'Enter') this.search(this.searchBox.value.trim()); return; }
                    const items = Array.from(this.suggestionsContainer.querySelectorAll('.suggestion-item'));
                    if (!items.length) return;
                    if (e.key === 'ArrowDown') { e.preventDefault(); this.selected = Math.min(this.selected + 1, items.length - 1); this.update(items); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); this.selected = Math.max(this.selected - 1, -1); this.update(items); }
                    else if (e.key === 'Enter') { e.preventDefault(); if (this.selected >= 0) items[this.selected].click(); }
                    else if (e.key === 'Escape') this.hideSuggestions();
                }

                update(items) { items.forEach((it, i) => it.classList.toggle('selected', i === this.selected)); if (this.selected >= 0) items[this.selected].scrollIntoView({ block: 'nearest' }); }

                async getSuggestions(q) { try { const d = await SearchAPI.suggestions(q, this.type, 15); this.renderSuggestions(d.suggestions || {}); } catch (e) { console.error(e); this.hideSuggestions(); } }

                renderSuggestions(groups) {
                    this.selected = -1; const has = Object.values(groups).some(g => Array.isArray(g) && g.length);
                    if (!has) return this.hideSuggestions();
                    const frag = document.createDocumentFragment();
                    const render = (title, list, cb) => { if (!list || !list.length) return; const g = document.createElement('div'); g.className = 'suggestion-group'; const h = document.createElement('div'); h.className = 'suggestion-header'; h.innerHTML = title; g.appendChild(h); list.forEach(it => g.appendChild(cb(it))); frag.appendChild(g); };
                    render('<i class="fas fa-user me-2"></i>Patient Names', groups.patient_names, item => { const d = document.createElement('div'); d.className = 'suggestion-item'; d.dataset.text = item.text; d.dataset.type = 'name'; d.innerHTML = `<div class="suggestion-text">${item.text}</div><div class="suggestion-meta">${item.count} studies available</div>`; return d; });
                    render('<i class="fas fa-id-card me-2"></i>Patient IDs', groups.patient_ids, item => { const d = document.createElement('div'); d.className = 'suggestion-item'; d.dataset.text = item.text; d.dataset.type = 'id'; d.innerHTML = `<div class="suggestion-text">${item.text}</div><div class="suggestion-meta">${(item.display||'').split(' - ')[1]||'Patient record'}</div>`; return d; });
                    render('<i class="fas fa-calendar me-2"></i>Study Dates', groups.study_dates, item => { const d = document.createElement('div'); d.className = 'suggestion-item'; d.dataset.text = item.text; d.dataset.type = 'date'; d.innerHTML = `<div class="suggestion-text">${item.formatted||item.text}</div><div class="suggestion-meta">${item.count} studies on this date</div>`; return d; });
                    this.suggestionsContainer.innerHTML = ''; this.suggestionsContainer.appendChild(frag); this.showSuggestions();
                }

                showSuggestions() { this.suggestionsContainer.style.display = 'block'; }
                hideSuggestions() { this.suggestionsContainer.style.display = 'none'; this.selected = -1; }

                async search(q) {
                    if (!q || !q.trim()) return;
                    this.showResults(); this.resultsContainer.innerHTML = `<div class="loading"><div class="spinner"></div><p>Searching for "${q}"...</p></div>`;
                    const params = { patient_id: '', patient_name: '', study_date: '' };
                    const digits = q.replace(/[^0-9]/g, '');
                    if (/^\d{8}$/.test(digits) || /^\d{4}-\d{2}-\d{2}$/.test(q)) params.study_date = q;
                    else if (/^\d{6}-\d{8}-\d{6}-\d{4}-\d{4}$/.test(q)) params.patient_id = q;
                    else if (q.length > 2 && /^[A-Za-z\s]+$/.test(q)) params.patient_name = q;
                    else { params.patient_id = q; params.patient_name = q; if (/\d{4}/.test(q)) params.study_date = q; }
                    try { const d = await SearchAPI.searchPatients(params); this.renderResults(d.patients || [], q); } catch (e) { console.error(e); this.resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon"><i class="fas fa-exclamation-triangle"></i></div><h3>Search Error</h3><p>Failed to perform search. Please try again.</p></div>`; }
                }

                renderResults(results, q) {
                    document.getElementById('resultsTitle').textContent = `Search Results for "${q}"`;
                    document.getElementById('resultsCount').textContent = `${results.length} ${results.length === 1 ? 'result' : 'results'} found`;
                    if (!results.length) { this.resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon"><i class="fas fa-search"></i></div><h3>No Results Found</h3><p>Try adjusting your search terms or use the suggestions above.</p></div>`; return; }
                    const html = results.map(p => `
                        <div class="result-card">
                            <div class="patient-name"><i class="fas fa-user-injured me-2"></i>${p.patient_name || 'Unknown Patient'}</div>
                            <div class="patient-details">
                                <div class="detail-item"><span class="detail-label"><i class="fas fa-id-card me-1"></i>Patient ID:</span><span class="detail-value">${p.patient_id}</span></div>
                                <div class="detail-item"><span class="detail-label"><i class="fas fa-calendar me-1"></i>Study Date:</span><span class="detail-value">${this.formatDate(p.study_date)}</span></div>
                                <div class="detail-item"><span class="detail-label"><i class="fas fa-database me-1"></i>Source:</span><span class="detail-value">${p.source}</span></div>
                                <div class="detail-item"><span class="detail-label"><i class="fas fa-file-medical me-1"></i>Files:</span><span class="detail-value">${p.file_count || 'N/A'}</span></div>
                            </div>
                            ${p.folder_path ? `<div class="detail-item"><span class="detail-label"><i class="fas fa-folder me-1"></i>Location:</span><span class="detail-value" style="font-family: monospace; font-size: 0.9rem; word-break: break-all;">${p.folder_path}</span></div>` : ''}
                            <div class="patient-actions" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(0, 101, 51, 0.1); display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="viewInSimpleViewer('${p.patient_id}')" class="view-btn primary-btn"><i class="fas fa-hd-video-camera me-2"></i>üáøüá¶ HD Viewer</button>
                                <button onclick="viewInBasicViewer('${p.patient_id}')" class="view-btn basic-btn"><i class="fas fa-images me-2"></i>Basic Viewer</button>
                                <button onclick="downloadStudy('${p.patient_id}')" class="view-btn download-btn"><i class="fas fa-download me-2"></i>Download DICOM</button>
                                <button onclick="sendToOHIF('${p.patient_id}', '')" class="view-btn ohif-btn"><i class="fas fa-cloud-upload-alt me-2"></i>Send to OHIF (Import)</button>
                                <button onclick="shareToOneDrive('${p.patient_id}', '')" class="view-btn basic-btn"><i class="fab fa-microsoft me-2"></i>Share to OneDrive</button>
                                <button onclick="shareToGDrive('${p.patient_id}', '')" class="view-btn basic-btn"><i class="fab fa-google-drive me-2"></i>Share to Google Drive</button>
                            </div>
                        </div>
                    `).join('');
                    this.resultsContainer.innerHTML = html;
                }

                formatDate(s) { if (!s || s.length < 8) return s || ''; try { return `${s.substr(0,4)}-${s.substr(4,2)}-${s.substr(6,2)}`; } catch(e){ return s; } }
                showResults() { this.resultsSection.style.display = 'block'; }
                hideResults() { this.resultsSection.style.display = 'none'; }
            }

            // ---- Utility functions used by other UI actions (kept from the original file) ----
            function viewInSimpleViewer(patientId, studyUID) {
                if (!patientId) return alert('Error: No patient ID specified');
                const params = new URLSearchParams(); params.append('patient_id', patientId); params.append('timestamp', Date.now()); if (studyUID) params.append('study_uid', studyUID);
                window.open(`/viewer/hd?${params.toString()}`, '_blank', 'width=1600,height=1000,scrollbars=yes,resizable=yes,toolbar=no,location=no');
            }

            function viewInBasicViewer(patientId, studyUID) { const params = new URLSearchParams(); if (patientId) params.append('patient_id', patientId); if (studyUID) params.append('study_uid', studyUID); window.open(`/viewer/basic?${params.toString()}`, '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes'); }

            // Download helper (kept behavior but simplified code flow)
            function downloadStudy(patientId) {
                if (!confirm(`Download DICOM for patient ID: ${patientId}?\n\nThis will open the first DICOM file by default (faster). Choose ZIP in the dialog to get a full ZIP.`)) return;
                const wantZip = confirm('Do you want a ZIP archive of all studies for this patient? (OK for ZIP, Cancel for single-file)');
                const downloadUrl = wantZip ? '/api/nas/download/job' : `/api/nas/download/patient?patient_id=${encodeURIComponent(patientId)}&format=raw`;

                let progressContainer = document.getElementById('download-progress-container');
                if (!progressContainer) {
                    progressContainer = document.createElement('div'); progressContainer.id = 'download-progress-container'; progressContainer.style.cssText = 'position:fixed;left:50%;top:20px;transform:translateX(-50%);z-index:10001;min-width:300px;';
                    progressContainer.innerHTML = `<div id="download-progress" style="background:rgba(255,255,255,0.95);border-radius:8px;padding:12px 16px;box-shadow:0 6px 20px rgba(0,0,0,0.1);display:flex;flex-direction:column;gap:8px;align-items:stretch;"><div style="font-weight:700;color:#006533">Preparing download</div><div style="height:10px;background:#eee;border-radius:6px;overflow:hidden;"><div id="download-progress-bar" style="width:0%;height:100%;background:linear-gradient(90deg,#006533,#FFB81C);"></div></div><div id="download-progress-text" style="font-size:0.85rem;color:#005580;text-align:right;">0%</div><div style="display:flex;justify-content:space-between;gap:8px;"><button id="download-cancel-btn" class="btn" style="background:#FF6B6B;color:white;border:none;padding:6px 12px;border-radius:6px;">Cancel</button><button id="download-hide-btn" class="btn" style="background:#006533;color:white;border:none;padding:6px 12px;border-radius:6px;">Hide</button></div></div>`;
                    document.body.appendChild(progressContainer);
                    document.getElementById('download-hide-btn').addEventListener('click', () => { progressContainer.style.display = 'none'; });
                } else { progressContainer.style.display = 'block'; }

                const progressBar = document.getElementById('download-progress-bar');
                const progressText = document.getElementById('download-progress-text');
                const cancelBtn = document.getElementById('download-cancel-btn');
                const controller = new AbortController();
                cancelBtn.onclick = () => { controller.abort(); showNotification('Download cancelled by user', 'error'); progressBar.style.width = '0%'; progressText.textContent = 'Cancelled'; };

                showNotification('Preparing download... This may take a few moments.', 'info');

                if (wantZip) {
                    fetch(downloadUrl, { method: 'POST', signal: controller.signal, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ patient_id: patientId, format: 'zip' }) })
                        .then(r => r.json()).then(data => {
                            if (!data || !data.job_id) throw new Error('Failed to create download job');
                            const jobId = data.job_id; const poll = setInterval(() => {
                                fetch(`/api/nas/download/job/${jobId}/status`).then(r => r.json()).then(statusData => {
                                    if (!statusData || !statusData.job) return; const job = statusData.job;
                                    if (job.progress) { progressBar.style.width = job.progress + '%'; progressText.textContent = job.progress + '%'; }
                                    if (job.state === 'ready' && job.download_url) { clearInterval(poll); const a = document.createElement('a'); a.href = job.download_url; a.download = job.filename || `patient_${patientId}.zip`; document.body.appendChild(a); a.click(); a.remove(); progressBar.style.width = '100%'; progressText.textContent = '100%'; showNotification('Download completed!', 'success'); setTimeout(() => { if (progressContainer) progressContainer.style.display = 'none'; }, 2000); }
                                    else if (job.state === 'error') { clearInterval(poll); showNotification('Download failed: ' + (job.error || 'Unknown'), 'error'); progressBar.style.width = '0%'; progressText.textContent = 'Failed'; }
                                }).catch(() => {});
                            }, 1000);
                        }).catch(err => { console.error(err); showNotification('Failed to start download job', 'error'); });
                } else {
                    fetch(downloadUrl, { method: 'GET', signal: controller.signal })
                        .then(response => {
                            if (!response.ok) throw new Error(`Server returned ${response.status} ${response.statusText}`);
                            const contentLength = response.headers.get('Content-Length'); const total = contentLength ? parseInt(contentLength, 10) : null;
                            if (total === null) { progressBar.style.width = '20%'; progressText.textContent = 'Starting...'; }
                            const disposition = response.headers.get('Content-Disposition') || ''; let suggestedName = `patient_${patientId}_dicom${wantZip ? '.zip' : '.dcm'}`; const m = /filename\*=UTF-8''(.+)$/.exec(disposition) || /filename="?([^";]+)"?/.exec(disposition); if (m && m[1]) suggestedName = decodeURIComponent(m[1]);
                            const reader = response.body.getReader(); const chunks = []; let received = 0;
                            function read() { return reader.read().then(({ done, value }) => { if (done) return; chunks.push(value); received += value.length; if (total) { const pct = Math.round((received / total) * 100); progressBar.style.width = pct + '%'; progressText.textContent = pct + '%'; } else { const current = parseInt(progressBar.style.width || '0', 10); const next = Math.min(95, (isNaN(current) ? 5 : current + Math.random() * 5)); progressBar.style.width = next + '%'; progressText.textContent = Math.round(next) + '%'; } return read(); }); }
                            return read().then(() => ({ chunks, suggestedName }));
                        })
                        .then(({ chunks, suggestedName }) => { const blob = new Blob(chunks); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = suggestedName; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); progressBar.style.width = '100%'; progressText.textContent = '100%'; showNotification('Download completed!', 'success'); setTimeout(() => { if (progressContainer) progressContainer.style.display = 'none'; }, 2000); })
                        .catch(err => { if (err.name === 'AbortError') return; console.error('Download error', err); showNotification('Download failed: ' + err.message, 'error'); progressBar.style.width = '0%'; progressText.textContent = 'Failed'; });
                }
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; color: white; font-weight: 600; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: all 0.3s ease; ${type === 'success' ? 'background: linear-gradient(135deg, #006533, #FFB81C);' : type === 'error' ? 'background: linear-gradient(135deg, #DC2626, #FF6B6B);' : 'background: linear-gradient(135deg, #005580, #006533);'}`;
                notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}`;
                document.body.appendChild(notification);
                setTimeout(() => { notification.style.transform = 'translateX(0)'; notification.style.opacity = '1'; }, 100);
                setTimeout(() => { notification.style.transform = 'translateX(100%)'; notification.style.opacity = '0'; setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 300); }, 4000);
            }

            // Date-based helpers and search helpers
            // Load counts and patient lists by date/date-range. These helpers were
            // previously global but were missing after a refactor; reintroduce them
            // so legacy buttons continue to work.
            async function loadDateCount(date, elementId) {
                try {
                    const params = { study_date: date, limit: 1 };
                    const data = await SearchAPI.searchPatients(params);
                    const count = (data && (data.total_found || (data.patients && data.patients.length))) || 0;
                    const el = document.getElementById(elementId);
                    if (el) el.textContent = `${count} ${count === 1 ? 'patient' : 'patients'}`;
                    return count;
                } catch (e) {
                    console.error('loadDateCount error', e);
                    const el = document.getElementById(elementId);
                    if (el) el.textContent = '‚Äî';
                    return 0;
                }
            }

            async function loadDateRangeCount(startDate, endDate, elementId) {
                try {
                    const body = { query: `${startDate}:${endDate}`, search_type: 'date_range', limit: 1 };
                    const res = await fetch('/api/nas/search/patient', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    let data = {};
                    try { data = await res.json(); } catch (e) { /* ignore non-json */ }
                    const count = (data && (data.total_found || (data.patients && data.patients.length))) || 0;
                    const el = document.getElementById(elementId);
                    if (el) el.textContent = `${count} ${count === 1 ? 'patient' : 'patients'}`;
                    return count;
                } catch (e) {
                    console.error('loadDateRangeCount error', e);
                    const el = document.getElementById(elementId);
                    if (el) el.textContent = '‚Äî';
                    return 0;
                }
            }

            function loadTodayPatients() { const today = new Date().toISOString().split('T')[0]; searchPatientsByDate(today, "Today's Patients"); }
            function loadYesterdayPatients() { const d = new Date(); d.setDate(d.getDate() - 1); searchPatientsByDate(d.toISOString().split('T')[0], "Yesterday's Patients"); }
            function loadWeekPatients() { const t = new Date(); const s = new Date(); s.setDate(t.getDate() - 7); searchPatientsByDateRange(s.toISOString().split('T')[0], t.toISOString().split('T')[0], "This Week's Patients"); }

            function searchPatientsByDate(date, title) {
                showNotification(`Loading ${title.toLowerCase()}...`, 'info');
                fetch('/api/nas/search/patient', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: date, search_type: 'study_date', limit: 100 }) })
                    .then(r => r.json()).then(data => { if (data.success && data.patients) { displaySearchResults(data.patients, `${title} (${data.patients.length} patients)`); showNotification(`Found ${data.patients.length} patients for ${title.toLowerCase()}`, 'success'); } else { displaySearchResults([], `${title} (0 patients)`); showNotification(`No patients found for ${title.toLowerCase()}`, 'info'); } }).catch(e => { console.error(e); showNotification('Error loading patients', 'error'); });
            }

            function searchPatientsByDateRange(startDate, endDate, title) { showNotification(`Loading ${title.toLowerCase()}...`, 'info'); fetch('/api/nas/search/patient', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: `${startDate}:${endDate}`, search_type: 'date_range', limit: 200 }) }).then(r => r.json()).then(data => { if (data.success && data.patients) { displaySearchResults(data.patients, `${title} (${data.patients.length} patients)`); showNotification(`Found ${data.patients.length} patients for ${title.toLowerCase()}`, 'success'); } else { displaySearchResults([], `${title} (0 patients)`); showNotification(`No patients found for ${title.toLowerCase()}`, 'info'); } }).catch(e => { console.error(e); showNotification('Error loading patients', 'error'); }); }

            function displaySearchResults(patients, title) { const rs = document.getElementById('resultsSection'); const rt = document.getElementById('resultsTitle'); const rc = document.getElementById('resultsCount'); const container = document.getElementById('resultsContainer'); rt.textContent = title; rc.textContent = `${patients.length} results`; rs.style.display = 'block'; if (!patients.length) { container.innerHTML = `<div class="no-results"><i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i><h3>No Patients Found</h3><p>No patients found for the selected date criteria.</p></div>`; return; } const html = patients.map(p => `<div class="patient-card"><div class="patient-info"><div class="patient-main"><h3 class="patient-name">${p.patient_name || 'Unknown Name'}</h3><div class="patient-details"><span class="patient-id"><i class="fas fa-id-card me-2"></i>${p.patient_id}</span><span class="study-date"><i class="fas fa-calendar me-2"></i>${p.study_date || 'Unknown Date'}</span><span class="modality"><i class="fas fa-x-ray me-2"></i>${p.modality || 'Unknown'}</span></div></div><div class="patient-actions"><button class="btn view-btn ohif-btn" onclick="viewInOHIF('${p.patient_id}', '${p.study_instance_uid || ''}')"><i class="fas fa-eye me-2"></i>OHIF Viewer</button><button class="btn view-btn basic-btn" onclick="viewInBasicViewer('${p.patient_id}', '${p.study_instance_uid || ''}')"><i class="fas fa-search me-2"></i>Basic Viewer</button><button class="btn view-btn download-btn" onclick="downloadStudy('${p.patient_id}')"><i class="fas fa-download me-2"></i>Download</button><button class="btn view-btn ohif-btn" onclick="sendToOHIF('${p.patient_id}', '${p.study_instance_uid || ''}')"><i class="fas fa-cloud-upload-alt me-2"></i>Send to OHIF</button><button class="btn view-btn basic-btn" onclick="shareToOneDrive('${p.patient_id}', '${p.study_instance_uid || ''}')"><i class="fab fa-microsoft me-2"></i>OneDrive</button><button class="btn view-btn basic-btn" onclick="shareToGDrive('${p.patient_id}', '${p.study_instance_uid || ''}')"><i class="fab fa-google-drive me-2"></i>Google Drive</button></div></div></div>`).join(''); container.innerHTML = html; rs.scrollIntoView({ behavior: 'smooth' }); }

            // Cloud sharing helpers (kept behavior)
            async function shareToCloud(provider, patientId, studyUID) {
                if (!patientId) return alert('Missing patient ID');
                try {
                    const resp = await fetch('/api/nas/export/cloud', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider, patient_id: patientId, study_uid: studyUID || undefined, make_public: true })
                    });

                    let data = null;
                    try { data = await resp.json(); } catch (e) { /* ignore non-json */ }

                    if (!resp.ok) {
                        const errMsg = (data && (data.error || data.message)) || `Server returned ${resp.status} ${resp.statusText}`;
                        const lower = String(errMsg).toLowerCase();
                        // Missing token -> immediately open provider-specific setup page
                        if (lower.includes('token')) {
                            const setupUrl = provider === 'gdrive' ? '/api/nas/gdrive/setup' : '/api/nas/onedrive/setup';
                            window.open(setupUrl, '_blank');
                            return;
                        }
                        // No files -> give actionable message
                        if (lower.includes('no dicom') || lower.includes('no accessible folder')) {
                            alert('Cloud share failed: No DICOM files found for this patient. Ensure the patient has been indexed or files are accessible on the NAS.');
                            return;
                        }
                        // Offer a ZIP download fallback
                        const goZip = confirm(`${errMsg}\n\nDownload ZIP locally instead?`);
                        if (goZip) return downloadStudy(patientId);
                        throw new Error(errMsg);
                    }

                    if (data && !data.success) {
                        const err = data.error || 'Cloud export failed';
                        const lower = String(err).toLowerCase();
                        if (lower.includes('token')) { const setupUrl = provider === 'gdrive' ? '/api/nas/gdrive/setup' : '/api/nas/onedrive/setup'; window.open(setupUrl, '_blank'); return; }
                        if (lower.includes('no dicom') || lower.includes('no accessible folder')) {
                            alert('Cloud share failed: No DICOM files found for this patient. Ensure the patient has been indexed or files are accessible on the NAS.');
                            return;
                        }
                        throw new Error(err);
                    }

                    if (data && data.share_link) {
                        const open = confirm(`${provider} upload complete. Open share link now?`);
                        if (open) window.open(data.share_link, '_blank');
                    } else {
                        alert(`${provider} upload complete. File ID: ${(data && data.file_id) || ''}`);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Cloud share failed: ' + (e.message || e));
                }
            }

            // Small wrappers used by template buttons
            window.logout = logout; window.viewInSimpleViewer = viewInSimpleViewer; window.viewInBasicViewer = viewInBasicViewer; window.downloadStudy = downloadStudy; window.sendToOHIF = async function(patientId, studyUID) { try { if (!patientId) return alert('Missing patient ID'); const resp = await fetch('/api/nas/orthanc/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ patient_id: patientId, study_uid: studyUID || undefined }) }); const data = await resp.json(); if (!data.success) throw new Error(data.error || 'Import failed'); const sUID = data.study_uid || studyUID || ''; const probe = await fetch('/static/ohif/index.html', { method: 'HEAD' }); const base = window.location.origin; if (probe.ok) { const u = new URL(`${base}/ohif/app`); u.searchParams.set('patient_id', patientId); if (sUID) u.searchParams.set('study_uid', sUID); window.open(u.toString(), '_blank'); } else { const p = new URLSearchParams(); if (sUID) p.set('StudyInstanceUIDs', sUID); window.open(`${base}/ohif/viewer?${p.toString()}`, '_blank'); } } catch (e) { console.error(e); alert('Failed to send to OHIF: ' + e.message); } };
            window.shareToOneDrive = (patientId, studyUID) => shareToCloud('onedrive', patientId, studyUID);
            window.shareToGDrive = (patientId, studyUID) => shareToCloud('gdrive', patientId, studyUID);

            // Initialize on DOM ready
            document.addEventListener('DOMContentLoaded', () => {
                window._patientSearch = new PatientSearchSystem();
                loadPatientCounts();
                // Initialize cloud connect buttons
                try { initCloudButtons(); } catch(e) { console.error('initCloudButtons failed', e); }
            });

            // Expose date-count functions globally
            window.loadTodayPatients = loadTodayPatients; window.loadYesterdayPatients = loadYesterdayPatients; window.loadWeekPatients = loadWeekPatients; window.loadPatientCounts = function() {
                const today = new Date().toISOString().split('T')[0]; const y = new Date(); y.setDate(y.getDate() - 1); const yesterday = y.toISOString().split('T')[0]; const s = new Date(); s.setDate(s.getDate() - 7); const weekStart = s.toISOString().split('T')[0]; loadDateCount(today, 'todayCount'); loadDateCount(yesterday, 'yesterdayCount'); loadDateRangeCount(weekStart, today, 'weekCount'); };

            // make helpers available for legacy calls
            window.shareToCloud = shareToCloud; window.displaySearchResults = displaySearchResults;

            // Cloud button helpers: query server config and wire buttons
            async function initCloudButtons() {
                const odBtn = document.getElementById('onedriveConnectBtn');
                const odStatus = document.getElementById('onedriveStatus');
                const gdBtn = document.getElementById('gdriveConnectBtn');
                const gdStatus = document.getElementById('gdriveStatus');
                if (!odBtn || !odStatus || !gdBtn || !gdStatus) return;
                try {
                    const r = await fetch('/api/nas/onedrive/config');
                    const j = await r.json();
                    if (j.configured) {
                        odStatus.textContent = 'Configured ‚Äî click to manage or reconnect';
                    } else {
                        odStatus.textContent = 'Not configured ‚Äî click to set up OneDrive';
                    }
                    // Always allow opening the setup page so users can follow the UI flow
                    odBtn.disabled = false;
                    odBtn.onclick = () => { window.open('/api/nas/onedrive/setup', '_blank'); };
                } catch (e) { console.error('onedrive config error', e); odStatus.textContent = 'Status unknown ‚Äî click to configure'; odBtn.disabled = false; odBtn.onclick = () => { window.open('/api/nas/onedrive/setup', '_blank'); } }

                try {
                    const r2 = await fetch('/api/nas/gdrive/config');
                    const j2 = await r2.json();
                    if (j2.configured) {
                        gdStatus.textContent = 'Configured ‚Äî click to manage or reconnect';
                    } else {
                        gdStatus.textContent = 'Not configured ‚Äî click to set up Google Drive';
                    }
                    // Always allow opening the setup page
                    gdBtn.disabled = false;
                    gdBtn.onclick = () => { window.open('/api/nas/gdrive/setup', '_blank'); };
                } catch (e) { console.error('gdrive config error', e); gdStatus.textContent = 'Status unknown ‚Äî click to configure'; gdBtn.disabled = false; gdBtn.onclick = () => { window.open('/api/nas/gdrive/setup', '_blank'); } }
            }
        })();
    </script>
</body>
</html>