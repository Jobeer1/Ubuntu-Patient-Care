<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Professional DICOM Viewer</title>
    
    <!-- Cornerstone.js for medical imaging -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-web-image-loader@2.1.1/dist/cornerstoneWebImageLoader.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .viewer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #1a1a1a;
            padding: 10px 20px;
            border-bottom: 2px solid #4a90e2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        
        .patient-info {
            color: #4a90e2;
            font-weight: bold;
        }
        
        .tools {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .tool-btn {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: #4a90e2;
            border-color: #4a90e2;
        }
        
        .tool-btn.active {
            background: #4a90e2;
            border-color: #4a90e2;
        }
        
        .viewer-main {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .viewport {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            cursor: crosshair;
        }
        
        .viewport canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .series-list {
            width: 300px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 10px;
        }
        
        .series-item {
            background: #2d2d2d;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #333;
            transition: all 0.2s;
        }
        
        .series-item:hover {
            background: #3d3d3d;
            border-color: #4a90e2;
        }
        
        .series-item.active {
            background: #4a90e2;
            border-color: #4a90e2;
        }
        
        .series-title {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 5px;
        }
        
        .series-details {
            font-size: 12px;
            color: #ccc;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-label {
            color: #4a90e2;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .control-value {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            width: 60px;
        }
        
        .image-nav {
            position: absolute;
            bottom: 60px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .download-options {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            min-width: 200px;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px 0;
            width: 100%;
            font-size: 12px;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4a90e2;
            font-size: 18px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="header">
            <div class="patient-info">
                <span id="patient-name">Loading Patient...</span>
                <span id="patient-details" style="margin-left: 20px; color: #ccc; font-size: 12px;"></span>
            </div>
            <div class="tools">
                <button class="tool-btn" id="tool-wwwc" title="Window/Level">W/L</button>
                <button class="tool-btn" id="tool-zoom" title="Zoom">üîç Zoom</button>
                <button class="tool-btn" id="tool-pan" title="Pan">‚úã Pan</button>
                <button class="tool-btn" id="tool-length" title="Measure">üìè Measure</button>
                <button class="tool-btn" id="tool-invert" title="Invert">üîÑ Invert</button>
                <button class="tool-btn" id="tool-reset" title="Reset View">üîÑ Reset</button>
            </div>
        </div>
        
        <div class="viewer-main">
            <div class="series-list" id="series-list">
                <h3 style="color: #4a90e2; margin-top: 0;">üìã Series</h3>
                <div id="series-items"></div>
            </div>
            
            <div style="flex: 1; position: relative;">
                <div class="viewport" id="dicomViewport"></div>
                <div class="loading" id="loading">üè• Loading DICOM Images...</div>
                
                <div class="controls">
                    <span class="control-label">W:</span>
                    <input type="number" class="control-value" id="window-width" value="400">
                    <span class="control-label">L:</span>
                    <input type="number" class="control-value" id="window-center" value="50">
                    <span class="control-label">Zoom:</span>
                    <span class="control-value" id="zoom-level">1.0x</span>
                </div>
                
                <div class="image-nav">
                    <button class="tool-btn" id="prev-image">‚¨ÖÔ∏è Prev</button>
                    <span id="image-info" style="color: #4a90e2; font-size: 12px;">1 / 1</span>
                    <button class="tool-btn" id="next-image">Next ‚û°Ô∏è</button>
                </div>
            </div>
        </div>
        
        <div class="download-options">
            <h4 style="color: #4a90e2; margin-top: 0;">üì• Download Options</h4>
            <button class="download-btn" onclick="downloadDICOM()">üíæ Download DICOM</button>
            <button class="download-btn" onclick="downloadJPEG()">üñºÔ∏è Download JPEG</button>
            <button class="download-btn" onclick="downloadPDF()">üìÑ Generate Report</button>
            <button class="download-btn" onclick="shareStudy()">üîó Share Study</button>
        </div>
    </div>

    <script>
        // Global variables
        let currentStudyUID = null;
        let currentSeriesUID = null;
        let currentImageIndex = 0;
        let totalImages = 0;
        let viewport = null;
        let activeElement = null;
        
        // Initialize viewer
        document.addEventListener('DOMContentLoaded', function() {
            initializeViewer();
            loadStudyData();
        });
        
        function initializeViewer() {
            // Initialize Cornerstone
            cornerstone.enable(document.getElementById('dicomViewport'));
            activeElement = document.getElementById('dicomViewport');
            
            // Configure WADO image loader
            cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
            cornerstoneWADOImageLoader.external.dicomParser = window.dicomParser;
            
            // Set up event listeners
            setupEventListeners();
            setupTools();
            
            console.log('‚úÖ DICOM viewer initialized');
        }
        
        function setupEventListeners() {
            // Window/Level controls
            document.getElementById('window-width').addEventListener('input', updateWindowLevel);
            document.getElementById('window-center').addEventListener('input', updateWindowLevel);
            
            // Image navigation
            document.getElementById('prev-image').addEventListener('click', () => changeImage(-1));
            document.getElementById('next-image').addEventListener('click', () => changeImage(1));
            
            // Tool buttons
            document.getElementById('tool-reset').addEventListener('click', resetView);
            document.getElementById('tool-invert').addEventListener('click', invertImage);
            
            // Viewport events
            activeElement.addEventListener('cornerstoneimagerendered', onImageRendered);
            activeElement.addEventListener('cornerstonenewimage', onNewImage);
        }
        
        function setupTools() {
            // Initialize Cornerstone Tools
            cornerstoneTools.external.cornerstone = cornerstone;
            cornerstoneTools.external.Hammer = window.Hammer;
            
            cornerstoneTools.init();
            
            // Add tools
            cornerstoneTools.addTool(cornerstoneTools.WwwcTool);
            cornerstoneTools.addTool(cornerstoneTools.ZoomTool);
            cornerstoneTools.addTool(cornerstoneTools.PanTool);
            cornerstoneTools.addTool(cornerstoneTools.LengthTool);
            
            // Set default tool
            cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });
            
            // Tool button handlers
            document.getElementById('tool-wwwc').addEventListener('click', () => setActiveTool('Wwwc'));
            document.getElementById('tool-zoom').addEventListener('click', () => setActiveTool('Zoom'));
            document.getElementById('tool-pan').addEventListener('click', () => setActiveTool('Pan'));
            document.getElementById('tool-length').addEventListener('click', () => setActiveTool('Length'));
        }
        
        function setActiveTool(toolName) {
            // Deactivate all tools
            cornerstoneTools.setToolDisabled('Wwwc');
            cornerstoneTools.setToolDisabled('Zoom');
            cornerstoneTools.setToolDisabled('Pan');
            cornerstoneTools.setToolDisabled('Length');
            
            // Activate selected tool
            cornerstoneTools.setToolActive(toolName, { mouseButtonMask: 1 });
            
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tool-' + toolName.toLowerCase()).classList.add('active');
        }
        
        function loadStudyData() {
            // Get study UID from URL parameters or template context
            const urlParams = new URLSearchParams(window.location.search);
            currentStudyUID = urlParams.get('studyUID') || '{{ study_uid }}';
            
            if (!currentStudyUID || currentStudyUID === '') {
                document.getElementById('loading').innerHTML = '‚ùå No study specified';
                return;
            }
            
            console.log('üìã Loading study:', currentStudyUID);
            loadStudyFromOrthanc(currentStudyUID);
        }
        
        function getStudyUIDFromShare() {
            // Extract study UID from URL parameters or template context  
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('studyUID') || '{{ study_uid }}' || null;
        }
        
        function loadStudyFromOrthanc(studyUID) {
            // Load study metadata from Orthanc
            fetch(`http://localhost:8042/studies/${studyUID}`)
                .then(response => response.json())
                .then(study => {
                    updatePatientInfo(study);
                    loadSeries(study.Series);
                })
                .catch(error => {
                    console.error('Error loading study:', error);
                    document.getElementById('loading').innerHTML = '‚ùå Error loading study';
                });
        }
        
        function updatePatientInfo(study) {
            const patientName = study.PatientMainDicomTags.PatientName || 'Unknown Patient';
            const patientID = study.PatientMainDicomTags.PatientID || '';
            const studyDate = study.MainDicomTags.StudyDate || '';
            const studyDescription = study.MainDicomTags.StudyDescription || '';
            
            document.getElementById('patient-name').textContent = patientName;
            document.getElementById('patient-details').textContent = 
                `ID: ${patientID} | Date: ${studyDate} | ${studyDescription}`;
        }
        
        function loadSeries(seriesUIDs) {
            const seriesContainer = document.getElementById('series-items');
            seriesContainer.innerHTML = '';
            
            seriesUIDs.forEach((seriesUID, index) => {
                fetch(`http://localhost:8042/series/${seriesUID}`)
                    .then(response => response.json())
                    .then(series => {
                        const seriesElement = createSeriesElement(series, index === 0);
                        seriesContainer.appendChild(seriesElement);
                        
                        // Load first series by default
                        if (index === 0) {
                            loadSeries(seriesUID);
                        }
                    });
            });
        }
        
        function createSeriesElement(series, isActive) {
            const div = document.createElement('div');
            div.className = 'series-item' + (isActive ? ' active' : '');
            div.onclick = () => loadSeriesImages(series.ID);
            
            div.innerHTML = `
                <div class="series-title">${series.MainDicomTags.SeriesDescription || 'Series'}</div>
                <div class="series-details">
                    Modality: ${series.MainDicomTags.Modality || 'N/A'}<br>
                    Images: ${series.Instances.length}<br>
                    Series: ${series.MainDicomTags.SeriesNumber || 'N/A'}
                </div>
            `;
            
            return div;
        }
        
        function loadSeriesImages(seriesUID) {
            currentSeriesUID = seriesUID;
            
            fetch(`http://localhost:8042/series/${seriesUID}`)
                .then(response => response.json())
                .then(series => {
                    totalImages = series.Instances.length;
                    currentImageIndex = 0;
                    
                    // Load first instance
                    if (series.Instances.length > 0) {
                        loadInstance(series.Instances[0]);
                    }
                    
                    updateImageInfo();
                    updateSeriesSelection(seriesUID);
                });
        }
        
        function loadInstance(instanceUID) {
            const imageId = `wadouri:http://localhost:8042/instances/${instanceUID}/file`;
            
            cornerstone.loadImage(imageId).then(image => {
                cornerstone.displayImage(activeElement, image);
                document.getElementById('loading').style.display = 'none';
                
                // Update window/level controls
                const viewport = cornerstone.getViewport(activeElement);
                document.getElementById('window-width').value = Math.round(viewport.voi.windowWidth);
                document.getElementById('window-center').value = Math.round(viewport.voi.windowCenter);
                
            }).catch(error => {
                console.error('Error loading image:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error loading image';
            });
        }
        
        function changeImage(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < totalImages) {
                currentImageIndex = newIndex;
                
                // Get current series instances
                fetch(`http://localhost:8042/series/${currentSeriesUID}`)
                    .then(response => response.json())
                    .then(series => {
                        loadInstance(series.Instances[currentImageIndex]);
                        updateImageInfo();
                    });
            }
        }
        
        function updateImageInfo() {
            document.getElementById('image-info').textContent = 
                `${currentImageIndex + 1} / ${totalImages}`;
        }
        
        function updateSeriesSelection(seriesUID) {
            document.querySelectorAll('.series-item').forEach(item => {
                item.classList.remove('active');
            });
            // Would need to match by series UID - simplified for now
        }
        
        function updateWindowLevel() {
            const windowWidth = parseInt(document.getElementById('window-width').value);
            const windowCenter = parseInt(document.getElementById('window-center').value);
            
            const viewport = cornerstone.getViewport(activeElement);
            viewport.voi.windowWidth = windowWidth;
            viewport.voi.windowCenter = windowCenter;
            cornerstone.setViewport(activeElement, viewport);
        }
        
        function resetView() {
            cornerstone.reset(activeElement);
            const viewport = cornerstone.getViewport(activeElement);
            document.getElementById('zoom-level').textContent = viewport.scale.toFixed(1) + 'x';
        }
        
        function invertImage() {
            const viewport = cornerstone.getViewport(activeElement);
            viewport.invert = !viewport.invert;
            cornerstone.setViewport(activeElement, viewport);
        }
        
        function onImageRendered(e) {
            const viewport = cornerstone.getViewport(activeElement);
            document.getElementById('zoom-level').textContent = viewport.scale.toFixed(1) + 'x';
        }
        
        function onNewImage(e) {
            console.log('New image loaded');
        }
        
        // Download functions
        function downloadDICOM() {
            if (currentStudyUID) {
                window.open(`http://localhost:8042/studies/${currentStudyUID}/archive`, '_blank');
            }
        }
        
        function downloadJPEG() {
            alert('JPEG export functionality will be implemented based on your requirements');
        }
        
        function downloadPDF() {
            alert('PDF report generation will be implemented based on your requirements');
        }
        
        function shareStudy() {
            alert('Study sharing functionality available through the main sharing system');
        }
    </script>
</body>
</html>