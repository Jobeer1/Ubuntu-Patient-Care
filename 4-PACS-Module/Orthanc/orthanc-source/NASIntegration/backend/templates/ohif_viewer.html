<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáøüá¶ SA Medical Imaging - Professional DICOM Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- DWV (DICOM Web Viewer) - Free Open Source DICOM Viewer -->
    <script src="https://cdn.jsdelivr.net/npm/dwv@0.33.0/dist/dwv.min.js"></script>
    
    <!-- Alternative: Cornerstone DICOM Libraries for better performance -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.es5.min.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #006533 0%, #FFB81C 30%, #005580 70%, #006533 100%);
            min-height: 100vh;
        }

        .ohif-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 3px solid rgba(255, 184, 28, 0.3);
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .ohif-header {
            background: linear-gradient(135deg, #006533 0%, #FFB81C 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ohif-header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .ohif-viewer-area {
            height: calc(100vh - 140px);
            background: #000;
            color: #FFB81C;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 30px;
            text-align: center;
            padding: 40px;
        }

        /* New viewer integration styles */
        .viewer-integration {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            color: white;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-state h3 {
            color: #FFB81C;
            margin: 0;
        }

        .loading-state p {
            color: #ccc;
            max-width: 400px;
        }

        .viewer-frame {
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .orthanc-integration {
            background: rgba(0, 101, 51, 0.1);
            border: 2px solid rgba(0, 101, 51, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .orthanc-integration h3 {
            color: #006533;
            margin-bottom: 15px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #006533;
        }

        .btn-secondary {
            background: #6c757d;
        }

        /* Professional DICOM Viewer Styles */
        .ohif-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: linear-gradient(135deg, #006533 0%, #FFB81C 100%);
            color: white;
        }

        .header-left h1 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
        }

        .patient-info {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-tool {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-tool:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .dicom-viewer-container {
            display: flex;
            height: calc(100vh - 140px);
            background: #1a1a1a;
        }

        .viewer-sidebar {
            width: 280px;
            background: #2d2d2d;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #444;
        }

        .viewer-sidebar h4 {
            color: #FFB81C;
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }

        .tool-group {
            margin-bottom: 25px;
        }

        .tool-group h5 {
            color: #ccc;
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-btn {
            display: block;
            width: 100%;
            background: #3d3d3d;
            border: none;
            color: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tool-btn:hover {
            background: #4d4d4d;
            transform: translateX(5px);
        }

        .tool-btn.active {
            background: #006533;
            border-left: 4px solid #FFB81C;
        }

        .tool-btn i {
            width: 20px;
            margin-right: 8px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #ccc;
        }

        .setting-item input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .study-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #3d3d3d;
            padding: 10px;
            border-radius: 8px;
        }

        .btn-nav {
            background: #006533;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-nav:hover {
            background: #007a3d;
        }

        .image-counter {
            color: #FFB81C;
            font-weight: bold;
        }

        .viewer-main {
            flex: 1;
            position: relative;
            background: #000;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-content i {
            font-size: 3rem;
            color: #FFB81C;
            margin-bottom: 20px;
        }

        .loading-content h3 {
            color: #FFB81C;
            margin-bottom: 10px;
        }

        .loading-progress {
            margin-top: 20px;
            width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #006533, #FFB81C);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: block;
            margin-top: 10px;
            color: #ccc;
        }

        .dicom-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: crosshair;
        }

        #dicomCanvas {
            width: 100%;
            height: 100%;
            background: #000;
        }

        .viewport-overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
        }

        .top-left {
            top: 10px;
            left: 10px;
        }

        .top-right {
            top: 10px;
            right: 10px;
        }

        .bottom-left {
            bottom: 10px;
            left: 10px;
        }

        .bottom-right {
            bottom: 10px;
            right: 10px;
            text-align: right;
        }

        .overlay-info div {
            margin-bottom: 5px;
        }

        .south-african-flag {
            font-size: 16px;
            margin-top: 5px;
        }

        .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            max-width: 500px;
        }

        .no-data-message i {
            font-size: 4rem;
            color: #FFB81C;
            margin-bottom: 20px;
        }

        .no-data-message h3 {
            color: #FFB81C;
            margin-bottom: 15px;
        }

        .no-data-message ul {
            text-align: left;
            margin: 15px 0;
        }

        .action-buttons {
            margin-top: 20px;
        }

        .action-buttons .btn {
            margin: 0 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d2d;
            color: white;
            padding: 10px 20px;
            font-size: 0.85rem;
        }

        .status-left, .status-right {
            display: flex;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-item i {
            color: #FFB81C;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .viewer-sidebar {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .dicom-viewer-container {
                flex-direction: column;
            }

            .viewer-sidebar {
                width: 100%;
                height: 200px;
                order: 2;
            }

            .viewer-main {
                order: 1;
                height: calc(100vh - 340px);
            }
        }

        .ohif-logo {
            font-size: 5rem;
            color: #FFB81C;
        }

        .ohif-info {
            max-width: 600px;
        }

        .ohif-info h2 {
            color: #FFB81C;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .ohif-info p {
            color: #fff;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: rgba(255, 184, 28, 0.1);
            border: 2px solid rgba(255, 184, 28, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: left;
        }

        .feature-card h4 {
            color: #FFB81C;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-card p {
            color: #ccc;
            font-size: 0.9rem;
            margin: 0;
        }

        .setup-notice {
            background: rgba(0, 85, 128, 0.2);
            border: 2px solid rgba(0, 85, 128, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            color: #fff;
        }

        .setup-notice h3 {
            color: #FFB81C;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .integration-steps {
            background: rgba(0, 101, 51, 0.2);
            border: 2px solid rgba(0, 101, 51, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .integration-steps h4 {
            color: #FFB81C;
            margin-bottom: 15px;
        }

        .integration-steps ol {
            color: #ccc;
            line-height: 1.8;
        }

        .integration-steps li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="ohif-container">
        <!-- Professional Medical Header -->
        <div class="ohif-header">
            <div class="header-left">
                <h1>üè•üáøüá¶ Professional DICOM Viewer</h1>
                <div class="patient-info">
                    <span class="patient-id">Patient: {{ patient_id or 'Unknown' }}</span>
                    <span class="study-info">Study: {{ study_uid[:12] + '...' if study_uid else 'Loading...' }}</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-tool" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn btn-tool" onclick="resetViewer()" title="Reset View">
                    <i class="fas fa-refresh"></i>
                </button>
                <button class="close-btn" onclick="closeViewer()">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>

        <!-- Main DICOM Viewer Area -->
        <div class="dicom-viewer-container">
            <!-- Left Sidebar - Tools -->
            <div class="viewer-sidebar">
                <h4><i class="fas fa-tools"></i> Viewer Tools</h4>
                
                <div class="tool-group">
                    <h5>Navigation</h5>
                    <button class="tool-btn active" onclick="setTool('pan')" data-tool="pan">
                        <i class="fas fa-hand-paper"></i> Pan
                    </button>
                    <button class="tool-btn" onclick="setTool('zoom')" data-tool="zoom">
                        <i class="fas fa-search-plus"></i> Zoom
                    </button>
                    <button class="tool-btn" onclick="setTool('window')" data-tool="window">
                        <i class="fas fa-adjust"></i> Window/Level
                    </button>
                </div>

                <div class="tool-group">
                    <h5>Measurements</h5>
                    <button class="tool-btn" onclick="setTool('length')" data-tool="length">
                        <i class="fas fa-ruler"></i> Length
                    </button>
                    <button class="tool-btn" onclick="setTool('angle')" data-tool="angle">
                        <i class="fas fa-drafting-compass"></i> Angle
                    </button>
                    <button class="tool-btn" onclick="setTool('rectangle')" data-tool="rectangle">
                        <i class="fas fa-square"></i> ROI
                    </button>
                </div>

                <div class="tool-group">
                    <h5>View Settings</h5>
                    <div class="setting-item">
                        <label>Window Width: <span id="windowWidthValue">400</span></label>
                        <input type="range" id="windowWidth" min="1" max="4000" value="400" onchange="updateWindow()">
                    </div>
                    <div class="setting-item">
                        <label>Window Center: <span id="windowCenterValue">40</span></label>
                        <input type="range" id="windowCenter" min="-1000" max="1000" value="40" onchange="updateWindow()">
                    </div>
                    <div class="setting-item">
                        <label>Zoom: <span id="zoomValue">100%</span></label>
                        <input type="range" id="zoomSlider" min="25" max="500" value="100" onchange="updateZoom()">
                    </div>
                </div>

                <div class="tool-group">
                    <h5>Study Navigation</h5>
                    <div class="study-controls">
                        <button class="btn btn-nav" onclick="previousImage()" title="Previous Image">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="image-counter">
                            <span id="currentImage">1</span> / <span id="totalImages">1</span>
                        </span>
                        <button class="btn btn-nav" onclick="nextImage()" title="Next Image">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Viewer Area -->
            <div class="viewer-main">
                <!-- Loading State -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading DICOM Images...</h3>
                        <p>Connecting to Orthanc PACS and retrieving patient studies...</p>
                        <div class="loading-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>
                </div>

                <!-- DICOM Viewport -->
                <div class="dicom-viewport" id="dicomViewport">
                    <canvas id="dicomCanvas" width="800" height="600"></canvas>
                    
                    <!-- Viewport Overlay Info -->
                    <div class="viewport-overlay top-left">
                        <div class="overlay-info">
                            <div>Patient: <span id="overlayPatientName">{{ patient_id or 'Unknown' }}</span></div>
                            <div>Study Date: <span id="overlayStudyDate">Loading...</span></div>
                            <div>Modality: <span id="overlayModality">Loading...</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay top-right">
                        <div class="overlay-info">
                            <div>Series: <span id="overlaySeriesNumber">1</span></div>
                            <div>Image: <span id="overlayImageNumber">1</span></div>
                            <div>Slice: <span id="overlaySliceLocation">0.0mm</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay bottom-left">
                        <div class="overlay-info">
                            <div>WW: <span id="overlayWindowWidth">400</span></div>
                            <div>WL: <span id="overlayWindowLevel">40</span></div>
                            <div>Zoom: <span id="overlayZoom">100%</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay bottom-right">
                        <div class="overlay-info">
                            <div>Institution: SA Medical Imaging</div>
                            <div class="south-african-flag">üáøüá¶</div>
                        </div>
                    </div>
                </div>

                <!-- No Data Message -->
                <div class="no-data-message" id="noDataMessage" style="display: none;">
                    <i class="fas fa-x-ray"></i>
                    <h3>No DICOM Images Found</h3>
                    <p>No DICOM studies found for patient: <strong>{{ patient_id or 'Unknown' }}</strong></p>
                    <p>This could be because:</p>
                    <ul>
                        <li>The patient has no imaging studies in the system</li>
                        <li>The studies are not yet uploaded to Orthanc</li>
                        <li>There may be a connection issue with the PACS server</li>
                    </ul>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="retryLoad()">
                            <i class="fas fa-refresh"></i> Retry Loading
                        </button>
                        <button class="btn btn-secondary" onclick="openOrthancDirectly()">
                            <i class="fas fa-external-link-alt"></i> Open Orthanc Directly
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span class="status-item">
                    <i class="fas fa-server"></i>
                    PACS: <span id="pacsStatus">Connecting...</span>
                </span>
                <span class="status-item">
                    <i class="fas fa-images"></i>
                    Images: <span id="imageCount">Loading...</span>
                </span>
            </div>
            <div class="status-right">
                <span class="status-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </span>
            </div>
        </div>

                <!-- Fallback viewer frame -->
                <div class="viewer-frame" id="viewerFrame" style="display: none;">
                    <iframe id="ohifIframe" 
                            src="" 
                            style="width: 100%; height: 600px; border: none; border-radius: 10px;"
                            title="OHIF DICOM Viewer">
                    </iframe>
                </div>

                <!-- Direct Orthanc Integration -->
                <div class="orthanc-integration" id="orthancIntegration" style="display: none;">
                    <h3><i class="fas fa-server"></i>Direct Orthanc Integration</h3>
                    <p>Connected to Orthanc PACS server for DICOM viewing</p>
                    <div class="orthanc-viewer" id="orthancViewer">
                        <!-- Orthanc viewer will be embedded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const patientId = '{{ patient_id }}';
        const studyUID = '{{ study_uid }}';
        
        console.log('üè• OHIF Viewer initialized for patient:', patientId, 'study:', studyUID);
        
        // Initialize OHIF viewer on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeOHIFViewer();
        });
        
        async function initializeOHIFViewer() {
            try {
                console.log('üîç Searching for OHIF installation...');
                
                // Try to find a working OHIF instance
                const ohifUrl = await findOHIFInstance();
                
                if (ohifUrl) {
                    console.log('‚úÖ Found OHIF at:', ohifUrl);
                    loadOHIFViewer(ohifUrl);
                } else {
                    console.log('‚ö†Ô∏è No OHIF found, trying Orthanc direct integration');
                    loadOrthancViewer();
                }
                
            } catch (error) {
                console.error('‚ùå OHIF initialization error:', error);
                showViewerError('Failed to initialize OHIF viewer');
            }
        }
        
        async function findOHIFInstance() {
            // First, check if we have Orthanc running
            try {
                console.log('üîç Checking Orthanc availability via proxy...');
                const orthancResponse = await fetch('/api/nas/orthanc-proxy/system', { method: 'GET' });
                
                if (orthancResponse.ok) {
                    console.log('‚úÖ Orthanc is running');
                    
                    // Check if OHIF plugin is available
                    try {
                        const ohifResponse = await fetch('/api/nas/orthanc-proxy/ohif/', { method: 'GET' });
                        
                        if (ohifResponse.ok || ohifResponse.status === 404) {
                            console.log('‚úÖ OHIF plugin endpoint accessible');
                            // Use the Orthanc OHIF plugin path through proxy
                            return '/api/nas/orthanc-proxy/ohif/';
                        }
                    } catch (ohifError) {
                        console.log('‚ö†Ô∏è OHIF plugin not available, will use Orthanc web interface');
                    }
                    
                    // Fallback to Orthanc web interface
                    return '/api/nas/orthanc-proxy/';
                }
            } catch (error) {
                console.log('‚ùå Orthanc not accessible:', error);
            }
            
            // Try other OHIF instances
            const possibleUrls = [
                'http://localhost:3000',        // OHIF dev server
                'http://localhost:8080/ohif/',  // Alternative setup
            ];
            
            for (const url of possibleUrls) {
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD',
                        timeout: 3000 
                    });
                    
                    console.log(`‚úÖ Found OHIF at: ${url}`);
                    return url;
                } catch (error) {
                    console.log(`‚ùå OHIF not found at: ${url}`);
                    continue;
                }
            }
            
            return null;
        }
        
        function loadOHIFViewer(ohifUrl) {
            try {
                const loadingState = document.getElementById('loadingOverlay');
                const viewerFrame = document.getElementById('viewerFrame');
                const iframe = document.getElementById('ohifIframe');
                
                console.log('üñ•Ô∏è Loading viewer from:', ohifUrl);
                
                // Check if this is Orthanc web interface
                if (ohifUrl.includes('localhost:8042') && !ohifUrl.includes('/ohif/')) {
                    loadOrthancWebInterface(ohifUrl);
                    return;
                }
                
                // Build OHIF URL with study parameters
                let viewerUrl = ohifUrl;
                
                // If we have a patient ID, try to find studies in Orthanc
                if (patientId && patientId !== 'None') {
                    findPatientStudiesInOrthanc(patientId)
                        .then(studies => {
                            if (studies.length > 0) {
                                const studyUIDs = studies.map(s => s.StudyInstanceUID).join(',');
                                
                                if (ohifUrl.includes('/ohif/')) {
                                    // OHIF plugin
                                    viewerUrl = `${ohifUrl}?StudyInstanceUIDs=${encodeURIComponent(studyUIDs)}`;
                                } else {
                                    // External OHIF
                                    const params = new URLSearchParams();
                                    params.append('StudyInstanceUIDs', studyUIDs);
                                    // Point to our proxied DICOMweb for same-origin access
                                    params.append('url', `${window.location.origin}/api/nas/dicom-web`);
                                    viewerUrl += '?' + params.toString();
                                }
                                
                                loadViewer(viewerUrl);
                            } else {
                                showViewerError(`No studies found in Orthanc for patient ${patientId}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error finding patient studies:', error);
                            loadViewer(viewerUrl);
                        });
                } else {
                    loadViewer(viewerUrl);
                }
                
                function loadViewer(url) {
                    console.log('Loading viewer URL:', url);
                    
                    // Update loading state
                    loadingState.innerHTML = `
                        <i class="fas fa-cog fa-spin" style="font-size: 3rem; color: #006533;"></i>
                        <h3>Loading OHIF Viewer...</h3>
                        <p>Patient: ${patientId || 'Not specified'}</p>
                    `;
                    
                    // Set iframe source
                    iframe.src = url;
                    
                    // Show viewer frame after a delay
                    setTimeout(() => {
                        loadingState.style.display = 'none';
                        viewerFrame.style.display = 'block';
                    }, 5000);
                    
                    // Handle iframe load events
                    iframe.onload = function() {
                        console.log('‚úÖ Viewer loaded successfully');
                        loadingState.style.display = 'none';
                        viewerFrame.style.display = 'block';
                    };
                    
                    iframe.onerror = function() {
                        console.error('‚ùå Failed to load viewer');
                        showViewerError('Failed to load DICOM viewer');
                    };
                }
                
            } catch (error) {
                console.error('Error loading OHIF viewer:', error);
                showViewerError('Error loading OHIF viewer');
            }
        }
        
        async function findPatientStudiesInOrthanc(patientId) {
            try {
                console.log('üîç Searching Orthanc for patient:', patientId);
                
                const orthancUrl = `${window.location.origin}/api/nas/orthanc-proxy`;
                const response = await fetch(`${orthancUrl}/patients`);
                
                if (!response.ok) {
                    throw new Error('Failed to connect to Orthanc');
                }
                
                const patients = await response.json();
                const studies = [];
                
                for (const orthancPatientId of patients) {
                    const patientResponse = await fetch(`${orthancUrl}/patients/${orthancPatientId}`);
                    
                    if (patientResponse.ok) {
                        const patientData = await patientResponse.json();
                        
                        // Check if this matches our patient ID
                        if (patientData.MainDicomTags && 
                            (patientData.MainDicomTags.PatientID === patientId ||
                             patientData.ID === patientId)) {
                            
                            // Get study details
                            for (const studyId of patientData.Studies || []) {
                                const studyResponse = await fetch(`${orthancUrl}/studies/${studyId}`);
                                
                                if (studyResponse.ok) {
                                    const studyData = await studyResponse.json();
                                    studies.push({
                                        StudyInstanceUID: studyData.MainDicomTags?.StudyInstanceUID || studyId,
                                        StudyDescription: studyData.MainDicomTags?.StudyDescription || 'Unknown Study',
                                        StudyDate: studyData.MainDicomTags?.StudyDate || 'Unknown Date'
                                    });
                                }
                            }
                            break;
                        }
                    }
                }
                
                console.log(`üìä Found ${studies.length} studies for patient ${patientId}`);
                return studies;
                
            } catch (error) {
                console.error('Error finding patient studies in Orthanc:', error);
                return [];
            }
        }
        
        function loadOrthancWebInterface(orthancUrl) {
            const loadingState = document.getElementById('loadingOverlay');
            const viewerFrame = document.getElementById('viewerFrame');
            const iframe = document.getElementById('ohifIframe');
            
            console.log('üñ•Ô∏è Loading Orthanc web interface');
            
            // Update loading state
            loadingState.innerHTML = `
                <i class="fas fa-server fa-spin" style="font-size: 3rem; color: #006533;"></i>
                <h3>Loading Orthanc Web Interface...</h3>
                <p>Patient: ${patientId || 'Not specified'}</p>
                <p style="color: #ccc; font-size: 0.9rem;">Full DICOM viewer functionality via Orthanc PACS</p>
            `;
            
            // Build Orthanc URL (note: Orthanc web UI under proxy may have pathing quirks)
            let viewerUrl = orthancUrl;
            
            // If we have a patient ID, we can navigate directly to the patient
            if (patientId && patientId !== 'None') {
                // For now, just load the main interface - user can navigate to patient
                viewerUrl = `${orthancUrl}#!patients`;
            }
            
            console.log('üì∫ Loading Orthanc URL:', viewerUrl);
            
            // Set iframe source
            iframe.src = viewerUrl;
            iframe.style.height = '700px'; // Make it taller for Orthanc interface
            
            // Show viewer frame after a delay
            setTimeout(() => {
                loadingState.style.display = 'none';
                viewerFrame.style.display = 'block';
            }, 3000);
            
            // Handle iframe load events
            iframe.onload = function() {
                console.log('‚úÖ Orthanc web interface loaded successfully');
                loadingState.style.display = 'none';
                viewerFrame.style.display = 'block';
            };
            
            iframe.onerror = function() {
                console.error('‚ùå Failed to load Orthanc web interface');
                showViewerError('Failed to load Orthanc web interface');
            };
        }
        
        function loadOrthancViewer() {
            try {
                const loadingState = document.getElementById('loadingOverlay');
                const orthancIntegration = document.getElementById('orthancIntegration');
                const orthancViewer = document.getElementById('orthancViewer');
                
                // Show Orthanc integration
                loadingState.style.display = 'none';
                orthancIntegration.style.display = 'block';
                
                // Create Orthanc viewer interface
                orthancViewer.innerHTML = `
                    <div class="orthanc-viewer-container" style="background: #000; border-radius: 10px; padding: 20px; text-align: center; min-height: 400px;">
                        <div style="color: #FFB81C; margin-bottom: 20px;">
                            <i class="fas fa-server" style="font-size: 3rem;"></i>
                            <h3>Orthanc PACS Integration</h3>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4 style="color: white; margin-bottom: 15px;">Patient Information</h4>
                            <div style="color: #ccc; text-align: left;">
                                <p><strong>Patient ID:</strong> ${patientId || 'Not specified'}</p>
                                <p><strong>Study UID:</strong> ${studyUID || 'Not specified'}</p>
                                <p><strong>PACS Server:</strong> http://localhost:8042</p>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <button class="btn btn-primary" onclick="openOrthancWeb()" style="background: #006533; margin: 10px;">
                                <i class="fas fa-external-link-alt"></i> Open Orthanc Web Interface
                            </button>
                            <button class="btn btn-secondary" onclick="openOHIFPublic()" style="background: #005580; margin: 10px;">
                                <i class="fas fa-globe"></i> Use Public OHIF Viewer
                            </button>
                        </div>
                        
                        <div style="color: #999; font-size: 0.9rem; margin-top: 20px;">
                            <p><i class="fas fa-info-circle"></i> To enable full OHIF integration:</p>
                            <p>Install Orthanc DICOMweb plugin and configure OHIF endpoints</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading Orthanc viewer:', error);
                showViewerError('Error loading Orthanc viewer');
            }
        }
        
        function openOrthancWeb() {
            // Use themed Orthanc Explorer instead of raw localhost
            window.open('/orthanc/explorer', '_blank');
        }
        
        // Professional DICOM Viewer Implementation
        let currentTool = 'pan';
        let currentImageIndex = 0;
        let totalImages = 1;
        let loadedImages = [];
        let viewport = null;
        let canvas = null;
        let ctx = null;
        
        // Initialize the DICOM viewer on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDICOMViewer();
            updateClock();
            setInterval(updateClock, 1000);
        });
        
        function initializeDICOMViewer() {
            console.log('üè• Initializing Professional DICOM Viewer');
            
            canvas = document.getElementById('dicomCanvas');
            ctx = canvas.getContext('2d');
            viewport = document.getElementById('dicomViewport');
            
            // Set up canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Set up mouse events
            setupMouseEvents();
            
            // Initialize Cornerstone if available
            try {
                if (typeof cornerstone !== 'undefined') {
                    cornerstone.enable(canvas);
                    console.log('‚úÖ Cornerstone initialized');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Cornerstone not available, using fallback viewer');
            }
            
            // Load patient data
            loadPatientData();
        }
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }
        
        function setupMouseEvents() {
            let isDragging = false;
            let lastMousePos = { x: 0, y: 0 };
            let panOffset = { x: 0, y: 0 };
            let zoomLevel = 1.0;
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMousePos = { x: e.clientX, y: e.clientY };
                e.preventDefault();
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - lastMousePos.x;
                const deltaY = e.clientY - lastMousePos.y;
                
                switch (currentTool) {
                    case 'pan':
                        panOffset.x += deltaX;
                        panOffset.y += deltaY;
                        redrawCanvas();
                        break;
                    case 'window':
                        updateWindowLevel(deltaX, deltaY);
                        break;
                }
                
                lastMousePos = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                zoomLevel = Math.max(0.1, Math.min(5.0, zoomLevel * delta));
                
                document.getElementById('zoomSlider').value = Math.round(zoomLevel * 100);
                document.getElementById('zoomValue').textContent = Math.round(zoomLevel * 100) + '%';
                document.getElementById('overlayZoom').textContent = Math.round(zoomLevel * 100) + '%';
                
                redrawCanvas();
            });
        }
        
        async function loadPatientData() {
            const patientId = '{{ patient_id }}';
            
            if (!patientId || patientId === 'None') {
                showNoDataMessage('No patient ID provided');
                return;
            }
            
            console.log(`üîç Loading DICOM data for patient: ${patientId}`);
            updateProgress(10, 'Connecting to Orthanc PACS...');
            
            try {
                // First, try to connect to Orthanc
                const orthancResponse = await fetch('http://localhost:8042/system', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                    }
                });
                
                if (orthancResponse.ok) {
                    document.getElementById('pacsStatus').textContent = 'Connected';
                    updateProgress(30, 'Searching for patient studies...');
                    await findPatientInOrthanc(patientId);
                } else {
                    throw new Error('Orthanc not accessible');
                }
                
            } catch (error) {
                console.error('Error loading patient data:', error);
                document.getElementById('pacsStatus').textContent = 'Disconnected';
                showNoDataMessage('Unable to connect to Orthanc PACS server');
            }
        }
        
        async function findPatientInOrthanc(patientId) {
            try {
                updateProgress(40, 'Searching Orthanc database...');
                
                const response = await fetch('http://localhost:8042/patients', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch patients from Orthanc');
                }
                
                const patients = await response.json();
                console.log(`üìä Found ${patients.length} patients in Orthanc`);
                
                updateProgress(60, 'Matching patient records...');
                
                for (const orthancPatientId of patients) {
                    const patientResponse = await fetch(`http://localhost:8042/patients/${orthancPatientId}`, {
                        headers: {
                            'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                        }
                    });
                    
                    if (patientResponse.ok) {
                        const patientData = await patientResponse.json();
                        
                        // Check if this matches our patient ID
                        if (patientData.MainDicomTags && 
                            (patientData.MainDicomTags.PatientID === patientId ||
                             patientData.ID === patientId ||
                             patientId.includes(patientData.MainDicomTags.PatientID))) {
                            
                            console.log('‚úÖ Found matching patient in Orthanc');
                            updateProgress(80, 'Loading patient studies...');
                            await loadPatientStudies(orthancPatientId, patientData);
                            return;
                        }
                    }
                }
                
                // If no exact match found, try the first few patients as demo
                console.log('‚ö†Ô∏è Exact patient not found, loading demo data');
                if (patients.length > 0) {
                    await loadDemoPatient(patients[0]);
                } else {
                    showNoDataMessage('No patients found in Orthanc PACS');
                }
                
            } catch (error) {
                console.error('Error finding patient in Orthanc:', error);
                showNoDataMessage('Error searching Orthanc database');
            }
        }
        
        async function loadPatientStudies(orthancPatientId, patientData) {
            try {
                updateProgress(85, 'Loading study images...');
                
                // Update patient info
                document.getElementById('overlayPatientName').textContent = 
                    patientData.MainDicomTags?.PatientName || patientData.ID;
                
                if (patientData.Studies && patientData.Studies.length > 0) {
                    const firstStudy = patientData.Studies[0];
                    await loadStudyImages(firstStudy);
                } else {
                    showNoDataMessage('No studies found for this patient');
                }
                
            } catch (error) {
                console.error('Error loading patient studies:', error);
                showNoDataMessage('Error loading patient studies');
            }
        }
        
        async function loadStudyImages(studyId) {
            try {
                updateProgress(90, 'Processing DICOM images...');
                
                const studyResponse = await fetch(`http://localhost:8042/studies/${studyId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                    }
                });
                
                if (studyResponse.ok) {
                    const studyData = await studyResponse.json();
                    
                    // Update study info
                    document.getElementById('overlayStudyDate').textContent = 
                        studyData.MainDicomTags?.StudyDate || 'Unknown';
                    document.getElementById('overlayModality').textContent = 
                        studyData.MainDicomTags?.Modality || 'Unknown';
                    
                    if (studyData.Series && studyData.Series.length > 0) {
                        await loadSeriesImages(studyData.Series[0]);
                    }
                }
                
                updateProgress(100, 'Loading complete!');
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('Error loading study images:', error);
                showNoDataMessage('Error loading study images');
            }
        }
        
        async function loadSeriesImages(seriesId) {
            try {
                const seriesResponse = await fetch(`http://localhost:8042/series/${seriesId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                    }
                });
                
                if (seriesResponse.ok) {
                    const seriesData = await seriesResponse.json();
                    
                    if (seriesData.Instances && seriesData.Instances.length > 0) {
                        totalImages = seriesData.Instances.length;
                        document.getElementById('totalImages').textContent = totalImages;
                        document.getElementById('imageCount').textContent = totalImages;
                        
                        // Load first image
                        await loadDICOMImage(seriesData.Instances[0]);
                    }
                }
                
            } catch (error) {
                console.error('Error loading series images:', error);
                // Load demo image instead
                loadDemoImage();
            }
        }
        
        async function loadDICOMImage(instanceId) {
            try {
                const imageUrl = `http://localhost:8042/instances/${instanceId}/preview`;
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    console.log('‚úÖ DICOM image loaded successfully');
                    
                    // Clear canvas and draw image
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Calculate scaling to fit image
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width - img.width * scale) / 2;
                    const y = (canvas.height - img.height * scale) / 2;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    
                    // Update image counter
                    document.getElementById('currentImage').textContent = currentImageIndex + 1;
                };
                
                img.onerror = function() {
                    console.error('‚ùå Failed to load DICOM image');
                    loadDemoImage();
                };
                
                // Try to load with auth headers
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Error loading DICOM image:', error);
                loadDemoImage();
            }
        }
        
        async function loadDemoPatient(orthancPatientId) {
            try {
                console.log('üìñ Loading demo patient data');
                updateProgress(85, 'Loading demo patient...');
                
                const patientResponse = await fetch(`http://localhost:8042/patients/${orthancPatientId}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('orthanc:orthanc')
                    }
                });
                
                if (patientResponse.ok) {
                    const patientData = await patientResponse.json();
                    document.getElementById('overlayPatientName').textContent = 
                        patientData.MainDicomTags?.PatientName || 'Demo Patient';
                    
                    if (patientData.Studies && patientData.Studies.length > 0) {
                        await loadStudyImages(patientData.Studies[0]);
                        return;
                    }
                }
                
                // Fallback to demo image
                loadDemoImage();
                
            } catch (error) {
                console.error('Error loading demo patient:', error);
                loadDemoImage();
            }
        }
        
        function loadDemoImage() {
            console.log('üìñ Loading demo medical image');
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Draw demo medical image
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw simulated medical image
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw chest outline
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, 150, 200, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw ribs
            for (let i = 0; i < 8; i++) {
                const y = centerY - 150 + (i * 35);
                ctx.beginPath();
                ctx.arc(centerX, y, 80, 0.2, Math.PI - 0.2);
                ctx.stroke();
            }
            
            // Draw spine
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - 180);
            ctx.lineTo(centerX, centerY + 180);
            ctx.stroke();
            
            // Add demo text
            ctx.fillStyle = '#FFB81C';
            ctx.font = '20px Arial';
            ctx.fillText('DEMO MEDICAL IMAGE', 20, 40);
            ctx.font = '14px Arial';
            ctx.fillText('South African Medical Imaging System', 20, 65);
            ctx.fillText('Professional DICOM Viewer', 20, 85);
            
            // Update status
            document.getElementById('pacsStatus').textContent = 'Demo Mode';
            document.getElementById('imageCount').textContent = '1 (Demo)';
        }
        
        function redrawCanvas() {
            // Redraw current image with current pan/zoom settings
            // This would be implemented with the actual image data
            console.log('üñºÔ∏è Redrawing canvas with current settings');
        }
        
        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
            const loadingContent = document.querySelector('.loading-content p');
            if (loadingContent) {
                loadingContent.textContent = message;
            }
        }
        
        function showNoDataMessage(message) {
            document.getElementById('loadingOverlay').style.display = 'none';
            const noDataMsg = document.getElementById('noDataMessage');
            noDataMsg.style.display = 'block';
            
            const messageP = noDataMsg.querySelector('p');
            if (messageP) {
                messageP.innerHTML = message + '<br><strong>Patient ID: {{ patient_id }}</strong>';
            }
        }
        
        // Tool Functions
        function setTool(tool) {
            currentTool = tool;
            
            // Update tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // Update cursor
            switch (tool) {
                case 'pan':
                    canvas.style.cursor = 'grab';
                    break;
                case 'zoom':
                    canvas.style.cursor = 'zoom-in';
                    break;
                case 'window':
                    canvas.style.cursor = 'crosshair';
                    break;
                default:
                    canvas.style.cursor = 'crosshair';
            }
        }
        
        function updateWindow() {
            const width = document.getElementById('windowWidth').value;
            const center = document.getElementById('windowCenter').value;
            
            document.getElementById('windowWidthValue').textContent = width;
            document.getElementById('windowCenterValue').textContent = center;
            document.getElementById('overlayWindowWidth').textContent = width;
            document.getElementById('overlayWindowLevel').textContent = center;
        }
        
        function updateWindowLevel(deltaX, deltaY) {
            const widthSlider = document.getElementById('windowWidth');
            const centerSlider = document.getElementById('windowCenter');
            
            const newWidth = Math.max(1, Math.min(4000, parseInt(widthSlider.value) + deltaX));
            const newCenter = Math.max(-1000, Math.min(1000, parseInt(centerSlider.value) + deltaY));
            
            widthSlider.value = newWidth;
            centerSlider.value = newCenter;
            
            updateWindow();
        }
        
        function updateZoom() {
            const zoom = document.getElementById('zoomSlider').value;
            document.getElementById('zoomValue').textContent = zoom + '%';
            document.getElementById('overlayZoom').textContent = zoom + '%';
        }
        
        function previousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                document.getElementById('currentImage').textContent = currentImageIndex + 1;
                // Load previous image
                console.log('‚¨ÖÔ∏è Loading previous image');
            }
        }
        
        function nextImage() {
            if (currentImageIndex < totalImages - 1) {
                currentImageIndex++;
                document.getElementById('currentImage').textContent = currentImageIndex + 1;
                // Load next image
                console.log('‚û°Ô∏è Loading next image');
            }
        }
        
        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }
        
        function resetViewer() {
            // Reset all viewer settings
            document.getElementById('windowWidth').value = 400;
            document.getElementById('windowCenter').value = 40;
            document.getElementById('zoomSlider').value = 100;
            updateWindow();
            updateZoom();
            redrawCanvas();
        }
        
        function retryLoad() {
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            loadPatientData();
        }
        
        function openOrthancDirectly() {
            // Use themed Orthanc Explorer instead of raw localhost
            window.open('/orthanc/explorer', '_blank');
        }
        
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        
        function closeViewer() {
            if (window.opener) {
                window.close();
            } else {
                window.history.back();
            }
        }
    </script>
</body>
</html>