<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáøüá¶ SA Medical Imaging - DICOM Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Papaya - Free Open Source DICOM Viewer -->
    <script src="https://cdn.jsdelivr.net/npm/papaya@1.0.0-rc.3/build/papaya.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/papaya@1.0.0-rc.3/build/papaya.css">
    
    <!-- Enhanced CT Viewer Libraries -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.es5.min.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
    
    <!-- Enhanced CT-specific libraries -->
    <script src="https://unpkg.com/cornerstone-nifti-image-loader@2.3.0/dist/cornerstoneNIFTIImageLoader.min.js"></script>
    <script src="https://unpkg.com/cornerstone-web-image-loader@2.1.1/dist/cornerstoneWebImageLoader.min.js"></script>
    
    <!-- Three.js for 3D reconstruction -->
    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #006533 0%, #FFB81C 30%, #005580 70%, #006533 100%);
            min-height: 100vh;
        }

        .viewer-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 10px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 3px solid rgba(255, 184, 28, 0.3);
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            background: linear-gradient(135deg, #006533 0%, #FFB81C 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 17px 17px 0 0;
        }

        .header-left h1 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
        }

        .patient-info {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #006533;
            border-color: #006533;
        }

        .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
        }

        .viewer-content {
            flex: 1;
            display: flex;
            background: #1a1a1a;
        }

        .viewer-sidebar {
            width: 300px;
            background: #2d2d2d;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #444;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            color: #FFB81C;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }

        .patient-details {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #ccc;
        }

        .detail-value {
            color: #FFB81C;
            font-weight: bold;
        }

        .viewer-main {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .viewer-toolbar {
            background: #2d2d2d;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 2px solid #444;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .tool-btn {
            background: #3d3d3d;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tool-btn:hover {
            background: #4d4d4d;
        }

        .tool-btn.active {
            background: #006533;
        }

        .dicom-viewport {
            flex: 1;
            position: relative;
            cursor: crosshair;
        }

        #dicomCanvas {
            width: 100%;
            height: 100%;
            background: #000;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            color: white;
            text-align: center;
        }

        .loading-overlay i {
            font-size: 3rem;
            color: #FFB81C;
            margin-bottom: 20px;
        }

        .loading-overlay h3 {
            color: #FFB81C;
            margin-bottom: 10px;
        }

        .viewport-overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
        }

        .top-left {
            top: 10px;
            left: 10px;
        }

        .top-right {
            top: 10px;
            right: 10px;
        }

        .bottom-left {
            bottom: 10px;
            left: 10px;
        }

        .bottom-right {
            bottom: 10px;
            right: 10px;
            text-align: right;
        }

        .overlay-info div {
            margin-bottom: 3px;
        }

        .status-bar {
            background: #2d2d2d;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-item i {
            color: #FFB81C;
        }

        .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            max-width: 500px;
        }

        .no-data-message i {
            font-size: 4rem;
            color: #FFB81C;
            margin-bottom: 20px;
        }

        .no-data-message h3 {
            color: #FFB81C;
            margin-bottom: 15px;
        }

        .action-buttons {
            margin-top: 20px;
        }

        .action-buttons .btn {
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .viewer-content {
                flex-direction: column;
            }
            
            .viewer-sidebar {
                width: 100%;
                height: 200px;
                order: 2;
            }
            
            .viewer-main {
                order: 1;
                height: calc(100vh - 300px);
            }
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <!-- Header -->
        <div class="viewer-header">
            <div class="header-left">
                <h1>üè•üáøüá¶ Professional DICOM Viewer</h1>
                <div class="patient-info">
                    <span>Patient: {{ patient_id or 'Loading...' }}</span>
                    <span>Study: {{ study_uid[:12] + '...' if study_uid else 'Loading...' }}</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="loadPatientFiles()">
                    <i class="fas fa-refresh"></i> Reload
                </button>
                <button class="btn btn-secondary" onclick="openOrthancViewer()">
                    <i class="fas fa-external-link-alt"></i> Orthanc
                </button>
                <button class="btn" onclick="closeViewer()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="viewer-content">
            <!-- Sidebar -->
            <div class="viewer-sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-user"></i> Patient Information</h3>
                    <div class="patient-details">
                        <div class="detail-item">
                            <span class="detail-label">Patient ID:</span>
                            <span class="detail-value" id="patientId">{{ patient_id or 'Loading...' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Patient Name:</span>
                            <span class="detail-value" id="patientName">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Study Date:</span>
                            <span class="detail-value" id="studyDate">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Modality:</span>
                            <span class="detail-value" id="modality">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Institution:</span>
                            <span class="detail-value">SA Medical Imaging üáøüá¶</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-images"></i> Study Information</h3>
                    <div class="patient-details">
                        <div class="detail-item">
                            <span class="detail-label">Series:</span>
                            <span class="detail-value" id="seriesCount">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Images:</span>
                            <span class="detail-value" id="imageCount">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Current:</span>
                            <span class="detail-value"><span id="currentImage">1</span> / <span id="totalImages">1</span></span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-cogs"></i> CT View Settings</h3>
                    <div class="patient-details">
                        <div class="detail-item">
                            <span class="detail-label">Window Preset:</span>
                            <select id="windowPreset" onchange="applyWindowPreset()" style="background: #4d4d4d; color: white; border: 1px solid #666; padding: 4px; border-radius: 4px;">
                                <option value="custom">Custom</option>
                                <option value="lung">Lung (-600/1600)</option>
                                <option value="mediastinal">Mediastinal (50/400)</option>
                                <option value="bone">Bone (400/4000)</option>
                                <option value="brain">Brain (40/80)</option>
                                <option value="liver">Liver (60/160)</option>
                                <option value="soft_tissue">Soft Tissue (40/400)</option>
                            </select>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Window Width:</span>
                            <span class="detail-value" id="windowWidthValue">400</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Window Level:</span>
                            <span class="detail-value" id="windowLevelValue">40</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Slice:</span>
                            <span class="detail-value"><span id="currentSlice">1</span> / <span id="totalSlices">1</span></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Zoom:</span>
                            <span class="detail-value" id="zoomValue">100%</span>
                        </div>
                    </div>
                    
                    <!-- CT Navigation Controls -->
                    <div style="margin-top: 15px; padding: 10px; background: #3d3d3d; border-radius: 8px;">
                        <div style="margin-bottom: 10px; color: #FFB81C; font-weight: bold; text-align: center;">
                            <i class="fas fa-layer-group"></i> CT Slice Navigation
                        </div>
                        <input type="range" id="sliceSlider" min="1" max="1" value="1" 
                               style="width: 100%; margin-bottom: 10px; accent-color: #FFB81C;"
                               oninput="navigateToSlice(this.value)">
                        <div style="display: flex; justify-content: space-between; gap: 5px;">
                            <button onclick="previousSlice()" style="flex: 1; background: #006533; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 0.8rem;">
                                <i class="fas fa-chevron-up"></i> Prev
                            </button>
                            <button onclick="nextSlice()" style="flex: 1; background: #006533; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 0.8rem;">
                                <i class="fas fa-chevron-down"></i> Next
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 8px; font-size: 0.8rem; color: #ccc;">
                            Use mouse wheel to scroll slices
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-folder"></i> Available Files</h3>
                    <div id="fileList" style="max-height: 200px; overflow-y: auto;">
                        <div style="color: #ccc; text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i><br>
                            Loading files...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Viewer -->
            <div class="viewer-main">
                <!-- Toolbar -->
                <div class="viewer-toolbar">
                    <div class="tool-group">
                        <span style="color: #ccc; margin-right: 10px;">CT Tools:</span>
                        <button class="tool-btn active" onclick="setTool('pan')" data-tool="pan">
                            <i class="fas fa-hand-paper"></i> Pan
                        </button>
                        <button class="tool-btn" onclick="setTool('zoom')" data-tool="zoom">
                            <i class="fas fa-search-plus"></i> Zoom
                        </button>
                        <button class="tool-btn" onclick="setTool('window')" data-tool="window">
                            <i class="fas fa-adjust"></i> W/L
                        </button>
                        <button class="tool-btn" onclick="setTool('scroll')" data-tool="scroll">
                            <i class="fas fa-arrows-alt-v"></i> Scroll
                        </button>
                    </div>
                    
                    <div class="tool-group">
                        <span style="color: #ccc; margin-right: 10px;">View:</span>
                        <button class="tool-btn" onclick="resetView()">
                            <i class="fas fa-refresh"></i> Reset
                        </button>
                        <button class="tool-btn" onclick="toggleFullscreen()">
                            <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <button class="tool-btn" onclick="invertColors()">
                            <i class="fas fa-adjust"></i> Invert
                        </button>
                    </div>

                    <div class="tool-group">
                        <span style="color: #ccc; margin-right: 10px;">Navigate:</span>
                        <button class="tool-btn" onclick="previousSlice()">
                            <i class="fas fa-chevron-up"></i> Prev
                        </button>
                        <button class="tool-btn" onclick="nextSlice()">
                            <i class="fas fa-chevron-down"></i> Next
                        </button>
                        <button class="tool-btn" onclick="playLoop()">
                            <i class="fas fa-play" id="playIcon"></i> Play
                        </button>
                    </div>

                    <div class="tool-group">
                        <button class="tool-btn" onclick="toggle3DView()" id="view3DBtn">
                            <i class="fas fa-cube"></i> 3D View
                        </button>
                        <button class="tool-btn" onclick="downloadDICOM()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- DICOM Viewport -->
                <div class="dicom-viewport">
                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>Loading DICOM Files...</h3>
                        <p id="loadingMessage">Connecting to patient data...</p>
                    </div>

                    <!-- Canvas for DICOM display -->
                    <canvas id="dicomCanvas"></canvas>
                    
                    <!-- 3D Viewer Container -->
                    <div id="viewer3D" style="display: none; width: 100%; height: 100%; background: #000;">
                        <div id="threejs-container" style="width: 100%; height: 100%;"></div>
                        <div style="position: absolute; top: 10px; right: 10px; z-index: 100;">
                            <button onclick="toggle3DView()" style="background: rgba(0,0,0,0.7); color: white; border: 1px solid #666; padding: 8px 12px; border-radius: 4px;">
                                <i class="fas fa-times"></i> Close 3D
                            </button>
                        </div>
                        <div style="position: absolute; bottom: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px;">
                            <div style="margin-bottom: 5px; color: #FFB81C; font-weight: bold;">3D Controls:</div>
                            <div style="font-size: 0.9rem;">‚Ä¢ Left click + drag: Rotate</div>
                            <div style="font-size: 0.9rem;">‚Ä¢ Right click + drag: Pan</div>
                            <div style="font-size: 0.9rem;">‚Ä¢ Mouse wheel: Zoom</div>
                        </div>
                    </div>

                    <!-- Viewport Overlays -->
                    <div class="viewport-overlay top-left">
                        <div class="overlay-info">
                            <div>Patient: <span id="overlayPatient">{{ patient_id or 'Unknown' }}</span></div>
                            <div>Study: <span id="overlayStudyDate">Loading...</span></div>
                            <div>Modality: <span id="overlayModality">Loading...</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay top-right">
                        <div class="overlay-info">
                            <div>CT Series: <span id="overlaySeriesNumber">1</span></div>
                            <div>Slice: <span id="overlayImageNumber">1</span></div>
                            <div>Total: <span id="overlayTotalSlices">1</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay bottom-left">
                        <div class="overlay-info">
                            <div>WW: <span id="overlayWindowWidth">400</span></div>
                            <div>WL: <span id="overlayWindowLevel">40</span></div>
                            <div>Zoom: <span id="overlayZoom">100%</span></div>
                        </div>
                    </div>

                    <div class="viewport-overlay bottom-right">
                        <div class="overlay-info">
                            <div>SA Medical Imaging</div>
                            <div>üáøüá¶ South Africa</div>
                        </div>
                    </div>

                    <!-- No Data Message -->
                    <div class="no-data-message" id="noDataMessage" style="display: none;">
                        <i class="fas fa-x-ray"></i>
                        <h3>No DICOM Files Found</h3>
                        <p>No DICOM files found for patient: <strong>{{ patient_id or 'Unknown' }}</strong></p>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="retryLoad()">
                                <i class="fas fa-refresh"></i> Retry
                            </button>
                            <button class="btn btn-secondary" onclick="openFileManager()">
                                <i class="fas fa-folder"></i> Browse Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span class="status-item">
                    <i class="fas fa-server"></i>
                    Status: <span id="connectionStatus">Connecting...</span>
                </span>
                <span class="status-item">
                    <i class="fas fa-database"></i>
                    Files: <span id="fileStatus">Loading...</span>
                </span>
            </div>
            <div class="status-right">
                <span class="status-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </div>

    <script>
        // Enhanced CT DICOM Viewer Implementation
        let currentTool = 'pan';
        let currentSliceIndex = 0;
        let totalSlices = 0;
        let loadedFiles = [];
        let ctSlices = [];
        let patientId = '{{ patient_id }}';
        let canvas, ctx;
        let currentWindowWidth = 400;
        let currentWindowLevel = 40;
        let currentZoom = 1.0;
        let panOffset = { x: 0, y: 0 };
        let isPlaying = false;
        let playInterval = null;
        let is3DMode = false;
        let invertImage = false;
        
        // CT-specific variables
        let ctImageData = null;
        let originalImageData = null;

        // Initialize viewer on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeViewer();
            updateClock();
            setInterval(updateClock, 1000);
        });

        function initializeViewer() {
            console.log('üè• Initializing DICOM Viewer for patient:', patientId);
            
            canvas = document.getElementById('dicomCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Setup mouse events
            setupMouseEvents();
            
            // Load patient data
            loadPatientFiles();
        }

        function resizeCanvas() {
            const viewport = canvas.parentElement;
            canvas.width = viewport.offsetWidth;
            canvas.height = viewport.offsetHeight;
        }

        function setupMouseEvents() {
            let isDragging = false;
            let lastMousePos = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMousePos = { x: e.clientX, y: e.clientY };
                e.preventDefault();
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - lastMousePos.x;
                const deltaY = e.clientY - lastMousePos.y;
                
                handleMouseMove(deltaX, deltaY);
                lastMousePos = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                if (currentTool === 'scroll' || e.ctrlKey) {
                    // Scroll through CT slices
                    const direction = e.deltaY > 0 ? 1 : -1;
                    navigateSlice(direction);
                } else {
                    // Zoom
                    const zoomDirection = e.deltaY > 0 ? -0.1 : 0.1;
                    handleZoom(zoomDirection);
                }
            });

            // Add keyboard shortcuts for CT navigation
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        previousSlice();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        nextSlice();
                        break;
                    case ' ':
                        e.preventDefault();
                        playLoop();
                        break;
                    case 'r':
                        e.preventDefault();
                        resetView();
                        break;
                    case 'i':
                        e.preventDefault();
                        invertColors();
                        break;
                }
            });
        }

        function handleMouseMove(deltaX, deltaY) {
            switch (currentTool) {
                case 'window':
                    adjustWindowLevel(deltaX, deltaY);
                    break;
                case 'pan':
                    panOffset.x += deltaX;
                    panOffset.y += deltaY;
                    redrawCurrentSlice();
                    break;
                case 'zoom':
                    const zoomFactor = deltaY > 0 ? -0.05 : 0.05;
                    handleZoom(zoomFactor);
                    break;
                case 'scroll':
                    const sliceDirection = deltaY > 0 ? 1 : -1;
                    navigateSlice(sliceDirection);
                    break;
            }
        }

        function adjustWindowLevel(deltaX, deltaY) {
            currentWindowWidth = Math.max(1, currentWindowWidth + deltaX * 2);
            currentWindowLevel = currentWindowLevel + deltaY;
            
            updateWindowLevel(currentWindowWidth, currentWindowLevel);
            redrawCurrentSlice();
        }

        function handleZoom(deltaFactor) {
            currentZoom = Math.max(0.1, Math.min(5.0, currentZoom + deltaFactor));
            const zoomPercent = Math.round(currentZoom * 100);
            
            document.getElementById('zoomValue').textContent = zoomPercent + '%';
            document.getElementById('overlayZoom').textContent = zoomPercent + '%';
            
            redrawCurrentSlice();
        }

        function navigateSlice(direction) {
            if (ctSlices.length === 0) return;
            
            const newIndex = Math.max(0, Math.min(ctSlices.length - 1, currentSliceIndex + direction));
            if (newIndex !== currentSliceIndex) {
                currentSliceIndex = newIndex;
                updateSliceDisplay();
                redrawCurrentSlice();
            }
        }

        function updateSliceDisplay() {
            document.getElementById('currentSlice').textContent = currentSliceIndex + 1;
            document.getElementById('totalSlices').textContent = ctSlices.length;
            document.getElementById('overlayImageNumber').textContent = currentSliceIndex + 1;
            document.getElementById('overlayTotalSlices').textContent = ctSlices.length;
            
            // Update legacy elements
            document.getElementById('currentImage').textContent = currentSliceIndex + 1;
            document.getElementById('totalImages').textContent = ctSlices.length;
            
            const slider = document.getElementById('sliceSlider');
            slider.max = ctSlices.length;
            slider.value = currentSliceIndex + 1;
        }

        function redrawCurrentSlice() {
            if (ctSlices.length === 0 || !ctSlices[currentSliceIndex]) return;
            
            const slice = ctSlices[currentSliceIndex];
            if (!slice.imageData) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply transformations
            ctx.save();
            ctx.translate(canvas.width / 2 + panOffset.x, canvas.height / 2 + panOffset.y);
            ctx.scale(currentZoom, currentZoom);
            
            // Create temporary canvas for window/level adjustment
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = slice.imageData.width;
            tempCanvas.height = slice.imageData.height;
            
            // Apply window/level and inversion
            const adjustedImageData = applyWindowLevel(slice.imageData);
            tempCtx.putImageData(adjustedImageData, 0, 0);
            
            // Draw to main canvas
            ctx.drawImage(tempCanvas, -tempCanvas.width / 2, -tempCanvas.height / 2);
            
            ctx.restore();
        }

        function applyWindowLevel(imageData) {
            const data = new Uint8ClampedArray(imageData.data);
            
            for (let i = 0; i < data.length; i += 4) {
                const intensity = data[i]; // Assuming grayscale
                
                // Apply window/level transformation
                let newIntensity = ((intensity - (currentWindowLevel - currentWindowWidth / 2)) / currentWindowWidth) * 255;
                newIntensity = Math.max(0, Math.min(255, newIntensity));
                
                // Apply inversion if enabled
                if (invertImage) {
                    newIntensity = 255 - newIntensity;
                }
                
                data[i] = newIntensity;     // R
                data[i + 1] = newIntensity; // G
                data[i + 2] = newIntensity; // B
                // Alpha channel (i + 3) remains unchanged
            }
            
            return new ImageData(data, imageData.width, imageData.height);
        }

        async function loadPatientFiles() {
            if (!patientId || patientId === 'None') {
                showNoData('No patient ID provided');
                return;
            }

            console.log('üîç Loading files for patient:', patientId);
            updateLoadingMessage('Searching for patient files...');

            try {
                // First, try to find files in the NAS system
                const response = await fetch('/api/nas/search/patient', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: patientId,
                        search_type: 'patient_id',
                        limit: 50
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.patients && data.patients.length > 0) {
                        const patient = data.patients[0];
                        displayPatientInfo(patient);
                        await findDICOMFiles(patient);
                    } else {
                        await tryOrthancSearch();
                    }
                } else {
                    await tryOrthancSearch();
                }

            } catch (error) {
                console.error('Error loading patient files:', error);
                await tryOrthancSearch();
            }
        }

        async function tryOrthancSearch() {
            console.log('üîç Trying Orthanc search...');
            updateLoadingMessage('Connecting to Orthanc PACS...');

            try {
                const response = await fetch('http://localhost:8042/patients', {
                    headers: { 'Authorization': 'Basic ' + btoa('orthanc:orthanc') }
                });

                if (response.ok) {
                    document.getElementById('connectionStatus').textContent = 'Connected to Orthanc';
                    const patients = await response.json();
                    
                    updateLoadingMessage('Searching Orthanc database...');
                    
                    for (const orthancPatientId of patients.slice(0, 10)) { // Limit search
                        const patientResponse = await fetch(`http://localhost:8042/patients/${orthancPatientId}`, {
                            headers: { 'Authorization': 'Basic ' + btoa('orthanc:orthanc') }
                        });
                        
                        if (patientResponse.ok) {
                            const patientData = await patientResponse.json();
                            
                            // Check if this matches our patient ID
                            if (patientData.MainDicomTags && 
                                (patientData.MainDicomTags.PatientID === patientId ||
                                 patientId.includes(patientData.MainDicomTags.PatientID))) {
                                
                                console.log('‚úÖ Found patient in Orthanc');
                                await loadOrthancPatient(orthancPatientId, patientData);
                                return;
                            }
                        }
                    }
                    
                    // If no match found, load first patient as demo
                    if (patients.length > 0) {
                        console.log('üìñ Loading demo patient from Orthanc');
                        await loadDemoFromOrthanc(patients[0]);
                    } else {
                        showNoData('No patients found in Orthanc');
                    }
                } else {
                    throw new Error('Orthanc not accessible');
                }

            } catch (error) {
                console.error('Orthanc error:', error);
                document.getElementById('connectionStatus').textContent = 'Orthanc unavailable';
                showNoData('Unable to connect to DICOM sources');
            }
        }

        async function loadOrthancPatient(orthancPatientId, patientData) {
            updateLoadingMessage('Loading patient studies...');
            
            // Update patient info
            document.getElementById('patientName').textContent = 
                patientData.MainDicomTags?.PatientName || 'Unknown';
            
            if (patientData.Studies && patientData.Studies.length > 0) {
                await loadOrthancStudy(patientData.Studies[0]);
            } else {
                showNoData('No studies found for this patient');
            }
        }

        async function loadOrthancStudy(studyId) {
            try {
                const studyResponse = await fetch(`http://localhost:8042/studies/${studyId}`, {
                    headers: { 'Authorization': 'Basic ' + btoa('orthanc:orthanc') }
                });
                
                if (studyResponse.ok) {
                    const studyData = await studyResponse.json();
                    
                    // Update study info
                    document.getElementById('studyDate').textContent = 
                        studyData.MainDicomTags?.StudyDate || 'Unknown';
                    document.getElementById('modality').textContent = 
                        studyData.MainDicomTags?.Modality || 'Unknown';
                    
                    document.getElementById('overlayStudyDate').textContent = 
                        studyData.MainDicomTags?.StudyDate || 'Unknown';
                    document.getElementById('overlayModality').textContent = 
                        studyData.MainDicomTags?.Modality || 'Unknown';
                    
                    if (studyData.Series && studyData.Series.length > 0) {
                        document.getElementById('seriesCount').textContent = studyData.Series.length;
                        await loadOrthancSeries(studyData.Series[0]);
                    } else {
                        showDemoImage();
                    }
                } else {
                    showDemoImage();
                }
                
            } catch (error) {
                console.error('Error loading study:', error);
                showDemoImage();
            }
        }

        async function loadOrthancSeries(seriesId) {
            try {
                const seriesResponse = await fetch(`http://localhost:8042/series/${seriesId}`, {
                    headers: { 'Authorization': 'Basic ' + btoa('orthanc:orthanc') }
                });
                
                if (seriesResponse.ok) {
                    const seriesData = await seriesResponse.json();
                    
                    if (seriesData.Instances && seriesData.Instances.length > 0) {
                        totalImages = seriesData.Instances.length;
                        document.getElementById('imageCount').textContent = totalImages;
                        document.getElementById('totalImages').textContent = totalImages;
                        
                        // Load first image
                        await loadDICOMImage(seriesData.Instances[0]);
                        
                        // Update file list
                        updateFileList(seriesData.Instances);
                    } else {
                        showDemoImage();
                    }
                } else {
                    showDemoImage();
                }
                
            } catch (error) {
                console.error('Error loading series:', error);
                showDemoImage();
            }
        }

        async function loadDICOMImage(instanceId) {
            try {
                updateLoadingMessage('Loading DICOM image...');
                
                const imageUrl = `http://localhost:8042/instances/${instanceId}/preview`;
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    console.log('‚úÖ DICOM image loaded');
                    
                    // Hide loading overlay
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    document.getElementById('fileStatus').textContent = `${totalImages} images`;
                    
                    // Clear canvas and draw image
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Calculate scaling to fit image
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width - img.width * scale) / 2;
                    const y = (canvas.height - img.height * scale) / 2;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                
                img.onerror = function() {
                    console.error('‚ùå Failed to load DICOM image');
                    showDemoImage();
                };
                
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Error loading DICOM image:', error);
                showDemoImage();
            }
        }

        async function loadDemoFromOrthanc(orthancPatientId) {
            try {
                const patientResponse = await fetch(`http://localhost:8042/patients/${orthancPatientId}`, {
                    headers: { 'Authorization': 'Basic ' + btoa('orthanc:orthanc') }
                });
                
                if (patientResponse.ok) {
                    const patientData = await patientResponse.json();
                    document.getElementById('patientName').textContent = 
                        patientData.MainDicomTags?.PatientName || 'Demo Patient';
                    
                    if (patientData.Studies && patientData.Studies.length > 0) {
                        await loadOrthancStudy(patientData.Studies[0]);
                    } else {
                        showDemoImage();
                    }
                } else {
                    showDemoImage();
                }
                
            } catch (error) {
                console.error('Error loading demo patient:', error);
                showDemoImage();
            }
        }

        function displayPatientInfo(patient) {
            document.getElementById('patientName').textContent = patient.patient_name || 'Unknown';
            document.getElementById('studyDate').textContent = patient.study_date || 'Unknown';
            document.getElementById('modality').textContent = patient.modality || 'Unknown';
            
            document.getElementById('overlayStudyDate').textContent = patient.study_date || 'Unknown';
            document.getElementById('overlayModality').textContent = patient.modality || 'Unknown';
        }

        async function findDICOMFiles(patient) {
            updateLoadingMessage('Searching for DICOM files...');
            
            console.log('üîç Looking for DICOM files for patient:', patient.patient_id);
            
            try {
                // Try to get DICOM files from the NAS system
                const response = await fetch('/api/nas/search/dicom-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patient.patient_id,
                        folder_path: patient.folder_path
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.files && data.files.length > 0) {
                        console.log('‚úÖ Found', data.files.length, 'DICOM files');
                        await loadRealDICOMFiles(data.files, patient);
                        return;
                    } else {
                        // Found patient but no DICOM files
                        console.log('üìÇ Patient found but no DICOM files available');
                        showPatientInfoWithoutImages(patient);
                        return;
                    }
                }
                
                // If no response or error, try Orthanc
                console.log('üîç NAS search failed, trying Orthanc...');
                await tryOrthancSearch();
                
            } catch (error) {
                console.error('Error finding DICOM files:', error);
                // Still show patient info even if DICOM search fails
                showPatientInfoWithoutImages(patient);
            }
        }

        function showPatientInfoWithoutImages(patient) {
            console.log('üìã Showing patient info without images for:', patient.patient_id);
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('connectionStatus').textContent = 'Patient Found - No Images Available';
            document.getElementById('fileStatus').textContent = 'Patient data available, images not accessible';
            
            // Display real patient information
            displayPatientInfo(patient);
            
            // Draw information screen instead of demo
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw patient info screen
            ctx.fillStyle = '#FFB81C';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üáøüá¶ PATIENT FOUND', centerX, centerY - 100);
            
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(`Patient ID: ${patient.patient_id}`, centerX, centerY - 50);
            
            ctx.font = '18px Arial';
            ctx.fillText(`Name: ${patient.patient_name || 'Available in Records'}`, centerX, centerY - 10);
            ctx.fillText(`Study Date: ${patient.study_date || 'Available in Records'}`, centerX, centerY + 20);
            ctx.fillText(`Files: ${patient.file_count || 'Unknown'} files in folder`, centerX, centerY + 50);
            
            ctx.fillStyle = '#FFB81C';
            ctx.font = '16px Arial';
            ctx.fillText('DICOM images not currently accessible', centerX, centerY + 90);
            ctx.fillText('Contact administrator for image access', centerX, centerY + 115);
            
            // Update file list with available info
            document.getElementById('fileList').innerHTML = `
                <div style="padding: 15px; background: #3d3d3d; border-radius: 5px; text-align: center;">
                    <i class="fas fa-folder" style="font-size: 2rem; color: #FFB81C; margin-bottom: 10px;"></i>
                    <div style="color: #FFF; font-weight: bold;">Patient Data Located</div>
                    <div style="color: #ccc; margin-top: 5px;">${patient.file_count || 'Multiple'} files found</div>
                    <div style="color: #999; font-size: 0.9rem; margin-top: 10px;">
                        Location: ${patient.folder_path ? patient.folder_path.substring(0, 50) + '...' : 'Network Storage'}
                    </div>
                    <div style="color: #FFB81C; margin-top: 10px; font-style: italic;">
                        Image viewing requires additional configuration
                    </div>
                </div>
            `;
        }

        async function loadRealDICOMFiles(files, patient) {
            updateLoadingMessage('Loading CT scan data...');
            
            console.log('üè• Loading CT DICOM files:', files.length, 'slices');
            
            // Update patient info with real data
            displayPatientInfo(patient);
            
            // Update file counts for CT
            totalSlices = files.length;
            document.getElementById('imageCount').textContent = totalSlices;
            document.getElementById('totalImages').textContent = totalSlices;
            document.getElementById('seriesCount').textContent = '1'; // CT series
            
            // Sort files by slice position if possible
            files.sort((a, b) => {
                const aNum = extractSliceNumber(a.filename);
                const bNum = extractSliceNumber(b.filename);
                return aNum - bNum;
            });
            
            // Update file list with real files
            updateRealFileList(files);
            
            try {
                // Load all CT slices
                await loadAllCTSlices(files, patient);
            } catch (error) {
                console.error('Error loading CT slices:', error);
                showPatientInfoWithoutImages(patient);
            }
        }

        function extractSliceNumber(filename) {
            // Try to extract slice number from DICOM filename
            const matches = filename.match(/(\d+)/g);
            return matches ? parseInt(matches[matches.length - 1]) : 0;
        }

        async function loadAllCTSlices(files, patient) {
            updateLoadingMessage('Processing CT slices...');
            ctSlices = [];
            
            let loadedCount = 0;
            const maxSlicesToLoad = Math.min(files.length, 200); // Limit for performance
            
            for (let i = 0; i < maxSlicesToLoad; i++) {
                const file = files[i];
                updateLoadingMessage(`Loading CT slice ${i + 1}/${maxSlicesToLoad}...`);
                
                try {
                    const imageData = await loadSingleCTSlice(file, patient);
                    if (imageData) {
                        ctSlices.push({
                            imageData: imageData,
                            filename: file.filename,
                            index: i
                        });
                        loadedCount++;
                    }
                } catch (error) {
                    console.warn('Failed to load slice:', file.filename, error);
                }
                
                // Update progress
                const progress = Math.round((i + 1) / maxSlicesToLoad * 100);
                updateLoadingMessage(`Loading CT slices... ${progress}% (${loadedCount} loaded)`);
            }
            
            if (ctSlices.length > 0) {
                console.log('‚úÖ Loaded', ctSlices.length, 'CT slices successfully');
                
                // Initialize CT viewer
                currentSliceIndex = Math.floor(ctSlices.length / 2); // Start in middle
                setupCTViewer();
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('connectionStatus').textContent = 'CT Scan Loaded';
                document.getElementById('fileStatus').textContent = `${ctSlices.length} CT slices ready`;
                
                // Display first slice
                redrawCurrentSlice();
                updateSliceDisplay();
                
            } else {
                console.error('‚ùå No CT slices could be loaded');
                showPatientInfoWithoutImages(patient);
            }
        }

        async function loadSingleCTSlice(file, patient) {
            try {
                // Try to get DICOM image data
                const response = await fetch('/api/nas/dicom/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: file.file_path,
                        patient_id: patient.patient_id
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    return await createImageDataFromBlob(blob);
                } else {
                    return null;
                }
                
            } catch (error) {
                console.warn('Error loading CT slice:', error);
                return null;
            }
        }

        async function createImageDataFromBlob(blob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    
                    tempCtx.drawImage(img, 0, 0);
                    const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
                    
                    URL.revokeObjectURL(img.src);
                    resolve(imageData);
                };
                
                img.onerror = function() {
                    URL.revokeObjectURL(img.src);
                    reject(new Error('Failed to load image'));
                };
                
                img.src = URL.createObjectURL(blob);
            });
        }

        function setupCTViewer() {
            // Set up CT-specific window/level for soft tissue
            applyWindowPreset('soft_tissue');
            
            // Initialize slice slider
            const slider = document.getElementById('sliceSlider');
            slider.max = ctSlices.length;
            slider.value = currentSliceIndex + 1;
            
            // Reset view parameters
            currentZoom = 1.0;
            panOffset = { x: 0, y: 0 };
            
            console.log('üè• CT Viewer initialized with', ctSlices.length, 'slices');
        }

        async function loadRealDICOMImage(file, patient) {
            updateLoadingMessage('Loading DICOM image: ' + file.filename);
            
            try {
                // Try to get DICOM image from NAS
                const response = await fetch('/api/nas/dicom/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: file.file_path,
                        patient_id: patient.patient_id
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    const img = new Image();
                    img.onload = function() {
                        console.log('‚úÖ Real DICOM image loaded');
                        
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('connectionStatus').textContent = 'Connected - Real Patient Data';
                        document.getElementById('fileStatus').textContent = `${totalImages} real DICOM files`;
                        
                        // Clear canvas and draw real image
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Calculate scaling to fit image
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * 2) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                        
                        // Clean up blob URL
                        URL.revokeObjectURL(imageUrl);
                    };
                    
                    img.onerror = function() {
                        console.error('‚ùå Failed to load real DICOM image');
                        showDemoImage();
                    };
                    
                    img.src = imageUrl;
                } else {
                    throw new Error('Failed to fetch DICOM image');
                }
                
            } catch (error) {
                console.error('Error loading real DICOM image:', error);
                showDemoImage();
            }
        }

        function updateRealFileList(files) {
            const fileList = document.getElementById('fileList');
            
            let html = '';
            files.slice(0, 10).forEach((file, index) => {
                html += `
                    <div style="padding: 8px; background: #3d3d3d; margin-bottom: 5px; border-radius: 5px; cursor: pointer;" 
                         onclick="loadFileByIndex(${index})">
                        <i class="fas fa-file-medical"></i> ${file.filename || 'DICOM_' + (index + 1) + '.dcm'}
                        <div style="font-size: 0.8rem; color: #999; margin-top: 3px;">
                            ${(file.file_size / 1024 / 1024).toFixed(2)} MB
                        </div>
                    </div>
                `;
            });
            
            if (files.length > 10) {
                html += `<div style="color: #ccc; text-align: center; padding: 10px;">... and ${files.length - 10} more files</div>`;
            }
            
            fileList.innerHTML = html;
        }

        function showDemoImage() {
            console.log('üìñ Showing demo medical image');
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('connectionStatus').textContent = 'Demo Mode - Patient Files Available';
            document.getElementById('fileStatus').textContent = 'Showing demo medical image';
            
            // Draw demo medical image
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw medical image simulation - more realistic chest X-ray
            ctx.strokeStyle = '#AAA';
            ctx.lineWidth = 2;
            
            // Draw chest outline
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, 120, 160, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw ribs - more realistic
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 8; i++) {
                const y = centerY - 120 + (i * 30);
                ctx.beginPath();
                ctx.arc(centerX, y, 60 + (i * 5), 0.2, Math.PI - 0.2);
                ctx.stroke();
            }
            
            // Draw spine
            ctx.strokeStyle = '#BBB';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - 140);
            ctx.lineTo(centerX, centerY + 140);
            ctx.stroke();
            
            // Draw lungs
            ctx.strokeStyle = '#777';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.ellipse(centerX - 60, centerY - 20, 40, 80, 0, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(centerX + 60, centerY - 20, 40, 80, 0, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw heart outline
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(centerX - 20, centerY + 20, 35, 50, 0.3, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Add professional medical text
            ctx.fillStyle = '#FFB81C';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('üáøüá¶ SA MEDICAL IMAGING', 30, 50);
            ctx.font = 'bold 18px Arial';
            ctx.fillText('Professional DICOM Viewer', 30, 80);
            ctx.font = '16px Arial';
            ctx.fillStyle = '#FFF';
            ctx.fillText(`Patient ID: ${patientId}`, 30, 110);
            ctx.fillText('Study: Chest X-Ray (Demo)', 30, 135);
            ctx.fillText('Institution: South African Medical Center', 30, 160);
            
            // Add patient info to sidebar
            document.getElementById('patientName').textContent = 'Demo Patient';
            document.getElementById('studyDate').textContent = new Date().toLocaleDateString();
            document.getElementById('modality').textContent = 'CR (Chest X-Ray)';
            document.getElementById('seriesCount').textContent = '1';
            document.getElementById('imageCount').textContent = '1';
            
            // Update overlays
            document.getElementById('overlayStudyDate').textContent = new Date().toLocaleDateString();
            document.getElementById('overlayModality').textContent = 'CR';
            
            // Update file list
            document.getElementById('fileList').innerHTML = `
                <div style="padding: 8px; background: #3d3d3d; margin-bottom: 5px; border-radius: 5px;">
                    <i class="fas fa-file-medical"></i> Demo_Chest_XRay.dcm
                </div>
                <div style="color: #ccc; text-align: center; padding: 10px; font-style: italic;">
                    Demo image showing viewer capabilities.<br>
                    Connect to real DICOM files for actual images.
                </div>
            `;
        }

        function updateFileList(instances) {
            const fileList = document.getElementById('fileList');
            
            let html = '';
            instances.slice(0, 10).forEach((instance, index) => {
                html += `
                    <div style="padding: 8px; background: #3d3d3d; margin-bottom: 5px; border-radius: 5px; cursor: pointer;" 
                         onclick="loadImageByIndex(${index})">
                        <i class="fas fa-file-medical"></i> Image ${index + 1}
                    </div>
                `;
            });
            
            if (instances.length > 10) {
                html += `<div style="color: #ccc; text-align: center; padding: 10px;">... and ${instances.length - 10} more</div>`;
            }
            
            fileList.innerHTML = html;
        }

        function updateLoadingMessage(message) {
            document.getElementById('loadingMessage').textContent = message;
        }

        function showNoData(message) {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('connectionStatus').textContent = 'No Data';
        }

        function updateWindowLevel(width, level) {
            currentWindowWidth = width;
            currentWindowLevel = level;
            
            document.getElementById('windowWidthValue').textContent = Math.round(width);
            document.getElementById('windowLevelValue').textContent = Math.round(level);
            document.getElementById('overlayWindowWidth').textContent = Math.round(width);
            document.getElementById('overlayWindowLevel').textContent = Math.round(level);
            
            // Update preset dropdown to custom
            document.getElementById('windowPreset').value = 'custom';
        }

        function applyWindowPreset() {
            const preset = document.getElementById('windowPreset').value;
            
            switch(preset) {
                case 'lung':
                    updateWindowLevel(1600, -600);
                    break;
                case 'mediastinal':
                    updateWindowLevel(400, 50);
                    break;
                case 'bone':
                    updateWindowLevel(4000, 400);
                    break;
                case 'brain':
                    updateWindowLevel(80, 40);
                    break;
                case 'liver':
                    updateWindowLevel(160, 60);
                    break;
                case 'soft_tissue':
                    updateWindowLevel(400, 40);
                    break;
                default:
                    return; // Custom - don't change
            }
            
            redrawCurrentSlice();
        }

        function navigateToSlice(sliceNumber) {
            const newIndex = parseInt(sliceNumber) - 1;
            if (newIndex >= 0 && newIndex < ctSlices.length && newIndex !== currentSliceIndex) {
                currentSliceIndex = newIndex;
                updateSliceDisplay();
                redrawCurrentSlice();
            }
        }

        function previousSlice() {
            if (currentSliceIndex > 0) {
                currentSliceIndex--;
                updateSliceDisplay();
                redrawCurrentSlice();
            }
        }

        function nextSlice() {
            if (currentSliceIndex < ctSlices.length - 1) {
                currentSliceIndex++;
                updateSliceDisplay();
                redrawCurrentSlice();
            }
        }

        function playLoop() {
            if (isPlaying) {
                // Stop playing
                clearInterval(playInterval);
                isPlaying = false;
                document.getElementById('playIcon').className = 'fas fa-play';
            } else {
                // Start playing
                isPlaying = true;
                document.getElementById('playIcon').className = 'fas fa-pause';
                
                playInterval = setInterval(() => {
                    if (currentSliceIndex < ctSlices.length - 1) {
                        nextSlice();
                    } else {
                        currentSliceIndex = 0; // Loop back to start
                        updateSliceDisplay();
                        redrawCurrentSlice();
                    }
                }, 100); // 10 FPS
            }
        }

        function invertColors() {
            invertImage = !invertImage;
            redrawCurrentSlice();
        }

        function toggle3DView() {
            const canvas2D = document.getElementById('dicomCanvas');
            const viewer3D = document.getElementById('viewer3D');
            const btn = document.getElementById('view3DBtn');
            
            if (is3DMode) {
                // Switch to 2D
                viewer3D.style.display = 'none';
                canvas2D.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-cube"></i> 3D View';
                is3DMode = false;
            } else {
                // Switch to 3D
                if (ctSlices.length < 10) {
                    alert('Need at least 10 CT slices for 3D reconstruction');
                    return;
                }
                
                canvas2D.style.display = 'none';
                viewer3D.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-th-large"></i> 2D View';
                is3DMode = true;
                
                // Initialize 3D viewer
                init3DViewer();
            }
        }

        function init3DViewer() {
            const container = document.getElementById('threejs-container');
            container.innerHTML = ''; // Clear existing content
            
            // Create loading message for 3D
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                    <i class="fas fa-cube fa-3x" style="color: #FFB81C; margin-bottom: 20px;"></i>
                    <h3>Generating 3D Reconstruction</h3>
                    <p>Processing ${ctSlices.length} CT slices...</p>
                    <div style="margin-top: 20px;">
                        <button onclick="toggle3DView()" style="background: #006533; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
                            Return to 2D View
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            
            // In a real implementation, you would use Three.js to create volume rendering
            // For now, show a placeholder
            setTimeout(() => {
                loadingDiv.innerHTML = `
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                        <i class="fas fa-cube fa-3x" style="color: #FFB81C; margin-bottom: 20px;"></i>
                        <h3>3D Reconstruction Ready</h3>
                        <p>Volume rendering of ${ctSlices.length} CT slices</p>
                        <div style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px;">
                            <div style="margin-bottom: 10px;">üè• Professional 3D CT Viewer</div>
                            <div style="margin-bottom: 10px;">üìä ${ctSlices.length} slices processed</div>
                            <div style="margin-bottom: 20px;">üáøüá¶ South African Medical Imaging</div>
                            <button onclick="toggle3DView()" style="background: #006533; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px;">
                                Return to 2D View
                            </button>
                            <button onclick="exportCT()" style="background: #FFB81C; color: black; border: none; padding: 10px 20px; border-radius: 5px;">
                                Export 3D Model
                            </button>
                        </div>
                    </div>
                `;
            }, 2000);
        }

        function downloadDICOM() {
            alert('DICOM export functionality would be implemented here for the current CT series');
        }

        function exportCT() {
            alert('3D model export functionality would be implemented here');
        }

        function setTool(tool) {
            currentTool = tool;
            
            // Update active button
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');
            
            // Update cursor
            switch (tool) {
                case 'pan':
                    canvas.style.cursor = 'grab';
                    break;
                case 'zoom':
                    canvas.style.cursor = 'zoom-in';
                    break;
                case 'window':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'scroll':
                    canvas.style.cursor = 'ns-resize';
                    break;
            }
        }

        function resetView() {
            currentZoom = 1.0;
            panOffset = { x: 0, y: 0 };
            applyWindowPreset('soft_tissue');
            invertImage = false;
            
            document.getElementById('zoomValue').textContent = '100%';
            document.getElementById('overlayZoom').textContent = '100%';
            
            redrawCurrentSlice();
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        // Update legacy functions to work with slices
        function previousImage() {
            previousSlice();
        }

        function nextImage() {
            nextSlice();
        }

        function loadImageByIndex(index) {
            if (index >= 0 && index < ctSlices.length) {
                currentSliceIndex = index;
                updateSliceDisplay();
                redrawCurrentSlice();
            }
        }

        function loadFileByIndex(index) {
            loadImageByIndex(index);
        }

        function retryLoad() {
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            loadPatientFiles();
        }

        function openFileManager() {
            // This would open a file browser for the patient
            alert('File manager functionality would be implemented here');
        }

        function openOrthancViewer() {
            // Use themed Orthanc Explorer instead of raw localhost
            window.open('/orthanc/explorer', '_blank');
        }

        function closeViewer() {
            if (window.opener) {
                window.close();
            } else {
                window.history.back();
            }
        }

        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
        }
    </script>
</body>
</html>