# ğŸ” OAuth Authentication Flow

## ğŸ“Š Visual Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGIN PAGE (localhost:5000/login)                â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ¥ğŸ‡¿ğŸ‡¦ South African Medical Imaging System                   â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚  Username: [____________]                           â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Password: [____________]                           â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Role:     [â–¼ Select Role]                          â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  [ğŸš€ Secure Login]                                  â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OR CONTINUE WITH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [ğŸ”µ Sign in with Microsoft]  â† NEW!                        â”‚ â”‚
â”‚  â”‚  [ğŸ”´ Sign in with Google]     â† NEW!                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ User clicks OAuth button
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND ROUTES (Flask)                           â”‚
â”‚                                                                     â”‚
â”‚  /api/auth/microsoft  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  /api/auth/google     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                                                                  â”‚  â”‚
â”‚  â€¢ Reads OAuth config from .env                                 â”‚  â”‚
â”‚  â€¢ Builds authorization URL                                     â”‚  â”‚
â”‚  â€¢ Redirects to OAuth provider                                  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                                                                   â”‚
                                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OAUTH PROVIDER (Microsoft/Google)                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ” Sign in to your account                                  â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Email:    [user@example.com]                                â”‚ â”‚
â”‚  â”‚  Password: [************]                                    â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [Sign In]                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  User authenticates with their Microsoft/Google account            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ OAuth provider redirects back
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CALLBACK ROUTE (Flask Backend)                         â”‚
â”‚                                                                     â”‚
â”‚  /auth/microsoft/callback  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  /auth/google/callback     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                                                                  â”‚  â”‚
â”‚  1. Receives authorization code                                 â”‚  â”‚
â”‚  2. Exchanges code for access token                             â”‚  â”‚
â”‚  3. Fetches user info from provider API                         â”‚  â”‚
â”‚  4. Creates Flask session:                                      â”‚  â”‚
â”‚     â€¢ session['user_id']                                        â”‚  â”‚
â”‚     â€¢ session['username']                                       â”‚  â”‚
â”‚     â€¢ session['email']                                          â”‚  â”‚
â”‚     â€¢ session['oauth_provider']                                 â”‚  â”‚
â”‚     â€¢ session['authenticated'] = True                           â”‚  â”‚
â”‚  5. Redirects to dashboard                                      â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                                                                   â”‚
                                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DASHBOARD (localhost:5000/)                      â”‚
â”‚                                                                     â”‚
â”‚  âœ… User is now authenticated and can access:                      â”‚
â”‚     â€¢ Patient records                                               â”‚
â”‚     â€¢ DICOM images                                                  â”‚
â”‚     â€¢ Medical reports                                               â”‚
â”‚     â€¢ System features based on role                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Authentication Methods Comparison

| Method | Setup Required | User Experience | Security | Best For |
|--------|---------------|-----------------|----------|----------|
| **Local Auth** | None | Username + Password + Role | Basic | Development, Testing |
| **Microsoft OAuth** | Azure App Registration | Single Sign-On | Enterprise SSO | Organizations using Microsoft 365 |
| **Google OAuth** | Google Cloud Project | Single Sign-On | OAuth 2.0 | Public access, Gmail users |

## ğŸ” Security Features

### Session Management
```python
session['user_id'] = user_info.get('id')
session['username'] = username
session['email'] = email
session['oauth_provider'] = 'microsoft' or 'google'
session['authenticated'] = True
session['is_admin'] = False  # Default for OAuth users
session['role'] = 'user'
```

### OAuth Scopes Requested

**Microsoft:**
- `openid` - Basic authentication
- `profile` - User's profile information
- `email` - User's email address
- `User.Read` - Read user's profile from Microsoft Graph

**Google:**
- `openid` - Basic authentication
- `profile` - User's profile information
- `email` - User's email address

## ğŸ›¡ï¸ Error Handling

The system handles various error scenarios:

1. **OAuth Not Configured**: Shows error message on login page
2. **Authorization Failed**: Redirects to login with error message
3. **Token Exchange Failed**: Logs error and shows user-friendly message
4. **Network Errors**: Catches exceptions and provides feedback

## ğŸ”§ Configuration Files

```
backend/
â”œâ”€â”€ .env                    â† Your OAuth credentials (not in git)
â”œâ”€â”€ .env.example           â† Template for OAuth setup
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ auth_routes.py     â† OAuth implementation
â””â”€â”€ templates/
    â””â”€â”€ login.html         â† Login page with OAuth buttons
```

## ğŸ“ Environment Variables

```env
# Microsoft OAuth
MICROSOFT_CLIENT_ID=abc123...
MICROSOFT_CLIENT_SECRET=xyz789...
MICROSOFT_TENANT_ID=common
MICROSOFT_REDIRECT_URI=http://localhost:5000/auth/microsoft/callback

# Google OAuth
GOOGLE_CLIENT_ID=123456...
GOOGLE_CLIENT_SECRET=secret789...
GOOGLE_REDIRECT_URI=http://localhost:5000/auth/google/callback
```

## ğŸ¯ User Roles After OAuth Login

By default, OAuth users get:
- `role`: `user`
- `is_admin`: `False`
- `user_type`: `user`

To customize roles based on email domain or specific users, modify the callback functions in `auth_routes.py`:

```python
# Example: Grant admin to specific domain
if email.endswith('@hospital.co.za'):
    session['is_admin'] = True
    session['role'] = 'admin'
```

## ğŸš€ Next Steps

1. âœ… OAuth buttons added to login page
2. âœ… Backend routes implemented
3. âœ… Session management configured
4. â³ Configure OAuth credentials (see OAUTH_SETUP_GUIDE.md)
5. â³ Test authentication flow
6. â³ Customize user roles based on your needs
