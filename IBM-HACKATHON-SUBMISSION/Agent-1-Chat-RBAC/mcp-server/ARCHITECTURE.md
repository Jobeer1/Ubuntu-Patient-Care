# MCP Server Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Clinician Browser                            │
│                    (Chrome, Firefox, Safari, etc.)                   │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ HTTPS
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         MCP Server (Port 8080)                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    FastAPI Application                        │  │
│  │                                                               │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │  │
│  │  │   Auth      │  │    Token    │  │    User     │         │  │
│  │  │   Routes    │  │   Routes    │  │   Routes    │         │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │  │
│  │                                                               │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │  │
│  │  │    JWT      │  │    User     │  │   Audit     │         │  │
│  │  │  Service    │  │  Service    │  │  Service    │         │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    SQLite/PostgreSQL Database                 │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │
│  │  │  Users   │ │  Roles   │ │  Audit   │ │ Context  │       │  │
│  │  │  Table   │ │  Table   │ │   Logs   │ │  Tables  │       │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ OAuth 2.0 / OIDC
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    Identity Providers                                │
│  ┌──────────────────────┐         ┌──────────────────────┐         │
│  │   Google OAuth       │         │  Microsoft OAuth     │         │
│  │   accounts.google    │         │  login.microsoft     │         │
│  └──────────────────────┘         └──────────────────────┘         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Authentication Flow

```
┌──────────┐                                                    ┌──────────┐
│          │  1. Click "Sign in with Google"                   │          │
│          │ ─────────────────────────────────────────────────>│          │
│          │                                                    │          │
│          │  2. Redirect to /auth/google                      │          │
│ Clinician│ ─────────────────────────────────────────────────>│   MCP    │
│ Browser  │                                                    │  Server  │
│          │  3. Redirect to Google OAuth                      │          │
│          │<─────────────────────────────────────────────────│          │
│          │                                                    │          │
└────┬─────┘                                                    └────┬─────┘
     │                                                               │
     │ 4. Login with Google                                         │
     │                                                               │
     ↓                                                               │
┌──────────┐                                                         │
│  Google  │  5. Return authorization code                          │
│  OAuth   │ ───────────────────────────────────────────────────────┘
└──────────┘                                                         │
                                                                     │
     ┌───────────────────────────────────────────────────────────────┘
     │
     │ 6. Exchange code for user info
     │ 7. Get/Create user in database
     │ 8. Generate JWT token
     │ 9. Set secure cookie
     │ 10. Redirect to RIS with token
     ↓
┌──────────┐
│   RIS    │
│ Frontend │
└──────────┘
```

---

## Token Validation Flow (PACS Access)

```
┌──────────┐                                                    ┌──────────┐
│   RIS    │  1. Request DICOM image                           │  Nginx   │
│ Frontend │    GET /studies/123                               │  Reverse │
│          │    Authorization: Bearer <JWT>                    │  Proxy   │
│          │ ─────────────────────────────────────────────────>│          │
└──────────┘                                                    └────┬─────┘
                                                                     │
                                                                     │ 2. Validate JWT
                                                                     ↓
                                                                ┌──────────┐
                                                                │   MCP    │
                                                                │  Server  │
                                                                │          │
                                                                │ POST     │
                                                                │ /token/  │
                                                                │ validate │
                                                                └────┬─────┘
                                                                     │
                                                                     │ 3. Check signature
                                                                     │    Check expiration
                                                                     │    Check user active
                                                                     │
                                                                     │ 4. Return validation
                                                                     ↓
┌──────────┐                                                    ┌──────────┐
│  Nginx   │  5. If valid, forward request                     │ Orthanc  │
│  Reverse │ ─────────────────────────────────────────────────>│   PACS   │
│  Proxy   │                                                    │          │
│          │  6. Return DICOM data                             │          │
│          │<─────────────────────────────────────────────────│          │
└────┬─────┘                                                    └──────────┘
     │
     │ 7. Return to client
     ↓
┌──────────┐
│   RIS    │
│ Frontend │
└──────────┘
```

---

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         User Actions                                 │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      Authentication Layer                            │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐         │
│  │   Google     │    │  Microsoft   │    │   Manual     │         │
│  │   OAuth      │    │   OAuth      │    │   Token      │         │
│  └──────────────┘    └──────────────┘    └──────────────┘         │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      User Provisioning                               │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  1. Extract email from OAuth                                  │  │
│  │  2. Query user database                                       │  │
│  │  3. Create user if not exists                                 │  │
│  │  4. Load user role and permissions                            │  │
│  │  5. Load user context (language, preferences)                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      JWT Token Generation                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Token Payload:                                               │  │
│  │  {                                                            │  │
│  │    "user_id": 123,                                            │  │
│  │    "email": "doctor@clinic.org",                             │  │
│  │    "name": "Dr. Smith",                                       │  │
│  │    "role": "Radiologist",                                     │  │
│  │    "permissions": ["view_images", "create_reports"],         │  │
│  │    "exp": 1697658000,                                         │  │
│  │    "iat": 1697654400                                          │  │
│  │  }                                                            │  │
│  │                                                               │  │
│  │  Signed with: JWT_SECRET_KEY                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      Token Distribution                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐         │
│  │   Secure     │    │   Response   │    │   Redirect   │         │
│  │   Cookie     │    │   Header     │    │   to RIS     │         │
│  └──────────────┘    └──────────────┘    └──────────────┘         │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      Application Access                              │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                                                               │  │
│  │  RIS Frontend                    PACS/Orthanc                │  │
│  │  ┌──────────────┐                ┌──────────────┐           │  │
│  │  │ Dashboard    │                │ DICOM Viewer │           │  │
│  │  │ Reports      │                │ Image Access │           │  │
│  │  │ Dictation    │                │ Study List   │           │  │
│  │  └──────────────┘                └──────────────┘           │  │
│  │         │                                │                   │  │
│  │         └────────────┬───────────────────┘                   │  │
│  │                      │                                       │  │
│  │                      ↓                                       │  │
│  │            All requests include JWT                          │  │
│  │            Token validated on each request                   │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      Audit Logging                                   │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Every action logged:                                         │  │
│  │  - User login/logout                                          │  │
│  │  - PACS access                                                │  │
│  │  - Report creation                                            │  │
│  │  - Patient data access                                        │  │
│  │  - Failed authentication attempts                             │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         MCP Server Components                        │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                      API Layer (FastAPI)                    │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │    │
│  │  │  Auth    │ │  Token   │ │  Users   │ │  Audit   │     │    │
│  │  │  Routes  │ │  Routes  │ │  Routes  │ │  Routes  │     │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘     │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    Service Layer                            │    │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐      │    │
│  │  │     JWT      │ │     User     │ │    Audit     │      │    │
│  │  │   Service    │ │   Service    │ │   Service    │      │    │
│  │  │              │ │              │ │              │      │    │
│  │  │ - Generate   │ │ - CRUD ops   │ │ - Log events │      │    │
│  │  │ - Validate   │ │ - Roles      │ │ - Query logs │      │    │
│  │  │ - Refresh    │ │ - Context    │ │ - Reports    │      │    │
│  │  └──────────────┘ └──────────────┘ └──────────────┘      │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    Data Layer (SQLAlchemy)                  │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │    │
│  │  │  User    │ │  Role    │ │  Audit   │ │ Context  │     │    │
│  │  │  Model   │ │  Model   │ │   Log    │ │  Model   │     │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘     │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              ↓                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    Database (SQLite/PostgreSQL)             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Security Layers

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 7: Audit & Monitoring                  │
│  - All actions logged                                                │
│  - Real-time alerts                                                  │
│  - Compliance reporting                                              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 6: Authorization                       │
│  - Role-Based Access Control (RBAC)                                  │
│  - Permission checks                                                 │
│  - Resource-level authorization                                      │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 5: Token Validation                    │
│  - JWT signature verification                                        │
│  - Expiration checks                                                 │
│  - Token revocation                                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 4: Session Management                  │
│  - Secure cookies                                                    │
│  - HttpOnly flag                                                     │
│  - SameSite policy                                                   │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 3: Authentication                      │
│  - OAuth 2.0 / OIDC                                                  │
│  - State parameter (CSRF protection)                                 │
│  - Nonce validation                                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 2: Transport Security                  │
│  - HTTPS/TLS encryption                                              │
│  - Certificate validation                                            │
│  - Secure protocols only                                             │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────┐
│                         Layer 1: Identity Provider                   │
│  - Google/Microsoft security                                         │
│  - Multi-Factor Authentication (MFA)                                 │
│  - Strong password policies                                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Production Environment                       │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    Load Balancer (Optional)                 │    │
│  │                    - SSL Termination                        │    │
│  │                    - Health checks                          │    │
│  └────────────────────────────┬───────────────────────────────┘    │
│                               │                                      │
│                               ↓                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    MCP Server Instances                     │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │    │
│  │  │   Instance   │  │   Instance   │  │   Instance   │    │    │
│  │  │      1       │  │      2       │  │      3       │    │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘    │    │
│  └────────────────────────────┬───────────────────────────────┘    │
│                               │                                      │
│                               ↓                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    PostgreSQL Database                      │    │
│  │                    - Primary/Replica setup                  │    │
│  │                    - Automated backups                      │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    Redis Cache (Optional)                   │    │
│  │                    - Session storage                        │    │
│  │                    - Token blacklist                        │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Ubuntu Patient Care System                        │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    MCP Server (Port 8080)                   │    │
│  │                    - Authentication Gateway                 │    │
│  │                    - Token Management                       │    │
│  │                    - User Management                        │    │
│  │                    - Audit Logging                          │    │
│  └────────────────────────────┬───────────────────────────────┘    │
│                               │                                      │
│                               │ Issues JWT                           │
│                               │                                      │
│              ┌────────────────┴────────────────┐                    │
│              │                                 │                    │
│              ↓                                 ↓                    │
│  ┌─────────────────────────┐     ┌─────────────────────────┐      │
│  │  RIS Frontend (5443)    │     │  Nginx Proxy (5000)     │      │
│  │  - Login with SSO       │     │  - JWT Validation       │      │
│  │  - Include JWT in API   │     │  - Forward to Orthanc   │      │
│  │  - Load user context    │     │  - Audit logging        │      │
│  └────────────┬────────────┘     └────────────┬────────────┘      │
│               │                                │                    │
│               ↓                                ↓                    │
│  ┌─────────────────────────┐     ┌─────────────────────────┐      │
│  │  RIS Backend (5001)     │     │  Orthanc PACS (8042)    │      │
│  │  - Validate JWT         │     │  - Serve DICOM images   │      │
│  │  - Process reports      │     │  - Protected by proxy   │      │
│  │  - Medical dictation    │     │  - Study management     │      │
│  └─────────────────────────┘     └─────────────────────────┘      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

This architecture provides:
- ✅ Single Sign-On for all components
- ✅ Centralized authentication and authorization
- ✅ Secure token-based access control
- ✅ Comprehensive audit logging
- ✅ Scalable and maintainable design
- ✅ POPIA/HIPAA compliance ready
