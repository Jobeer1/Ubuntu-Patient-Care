<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🇿🇦 NAS Integration - Medical Imaging</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nas_integration.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏥🇿🇦 NAS Integration & Network Discovery</h1>
            <p class="subtitle">Medical Image Storage & Network Device Management</p>
            <a href="/" class="back-link">← Back to Dashboard</a>
        </header>

        <div class="grid">
            <!-- Orthanc Integration Section -->
            <div class="section">
                <h3>🏥 Orthanc PACS Integration</h3>
                <p>Connect to your Orthanc PACS server for DICOM management</p>
                <input type="text" id="orthancUrl" placeholder="Orthanc URL (e.g., http://localhost:8042)" value="http://localhost:8042">
                <input type="text" id="orthancUser" placeholder="Username (optional)">
                <input type="password" id="orthancPass" placeholder="Password (optional)">
                <br>
                <button class="btn btn-primary" onclick="connectOrthanc()">🔗 Connect to Orthanc</button>
                <button class="btn" onclick="testOrthancConnection()">🧪 Test Connection</button>
                <div id="orthancStatus" class="result-area">No connection attempted...</div>
            </div>

            <!-- Image Indexing Section -->
            <div class="section">
                <h3>📂 Medical Image Indexing</h3>
                <p>Scan and index DICOM images from network storage</p>
                <div class="mb-2">
                    <label>NAS Share Path</label>
                    <input type="text" id="indexPath" placeholder="\\\\nas-host\\share\\dicom or /share/dicom" value="/nas/dicom/" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Username</label>
                    <input type="text" id="indexUsername" placeholder="username" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Password</label>
                    <input type="password" id="indexPassword" placeholder="password" class="form-control">
                </div>
                <div class="mb-2">
                    <select id="indexOptions" class="form-select">
                        <option value="scan_only">Scan Only (No Database)</option>
                        <option value="index_metadata">Index Metadata Only</option>
                        <option value="full_index">Full Index with Thumbnails</option>
                    </select>
                </div>
                <div class="mb-2">
                    <button class="btn btn-warning" onclick="startIndexing()">📊 Start Indexing</button>
                    <button class="btn" onclick="getIndexStatus()">📈 Check Progress</button>
                </div>
                <div id="indexResults" class="result-area">Indexing not started...</div>
            </div>
        </div>

        <div class="grid">
            <!-- Patient Search Section -->
            <div class="section">
                <h3>🔍 Patient Image Search</h3>
                <p>Search indexed medical images by patient information</p>
                <input type="text" id="patientQuery" placeholder="Patient Name, ID, or Study Date">
                <select id="searchType">
                    <option value="name">Patient Name</option>
                    <option value="id">Patient ID</option>
                    <option value="study_date">Study Date</option>
                    <option value="modality">Modality (CT, MRI, etc.)</option>
                </select>
                <br>
                <button class="btn btn-success" onclick="searchPatients()">🔍 Search Images</button>
                <button class="btn" onclick="clearSearchResults()">🗑️ Clear Results</button>
                <div id="searchResults" class="result-area">No search performed...</div>
            </div>

            <!-- Secure Sharing Section -->
            <div class="section">
                <h3>🔒 Secure Patient Sharing</h3>
                <p>Generate secure download links for patients</p>
                <input type="text" id="sharePatientId" placeholder="Patient ID for sharing">
                <input type="text" id="shareStudyId" placeholder="Study ID (optional)">
                <input type="number" id="linkExpiry" placeholder="Link expiry (hours)" value="24" min="1" max="168">
                <textarea id="shareMessage" placeholder="Message for patient (optional)" rows="3"></textarea>
                <br>
                <button class="btn btn-success" onclick="generateShareLink()">🔗 Generate Secure Link</button>
                <button class="btn" onclick="copyLinkToClipboard()">📋 Copy Link</button>
                <div id="shareResults" class="result-area">No links generated yet...</div>
            </div>
        </div>

        <div class="grid">
            <!-- Enhanced Network Discovery -->
            <div class="section">
                <h3>🔍 Enhanced NAS Network Discovery</h3>
                <p>Advanced network discovery with ARP table and range ping capabilities</p>
                
                <!-- ARP Table Section -->
                <div class="discovery-subsection">
                    <h4>📋 ARP Table Discovery</h4>
                    <p class="subsection-desc">View devices currently in the system's ARP table</p>
                    <button class="btn" onclick="getArpTable()">📋 View ARP Table</button>
                    <button class="btn" onclick="enhancedDiscover(true, false)">🔍 Quick ARP Scan</button>
                </div>
                
                <!-- Range Ping Section -->
                <div class="discovery-subsection">
                    <h4>🎯 Range Ping Discovery</h4>
                    <div class="network-config-grid">
                        <div class="config-item">
                            <label>Start IP:</label>
                            <input type="text" id="startIp" placeholder="192.168.1.1" value="192.168.1.1">
                        </div>
                        <div class="config-item">
                            <label>End IP:</label>
                            <input type="text" id="endIp" placeholder="192.168.1.50" value="192.168.1.50">
                        </div>
                        <div class="config-item">
                            <label>Timeout (sec):</label>
                            <input type="number" id="pingTimeout" min="1" max="10" value="2">
                        </div>
                        <div class="config-item">
                            <label>Max Concurrent:</label>
                            <input type="number" id="maxConcurrent" min="1" max="50" value="10">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn" onclick="pingRange()">🎯 Ping IP Range</button>
                        <button class="btn" onclick="enhancedDiscover(false, true)">🔍 Range Scan Only</button>
                        <button class="btn btn-warning" onclick="enhancedDiscover(true, true)">🚀 Full Discovery (ARP + Range)</button>
                        <button class="btn btn-success" onclick="saveNetworkSettings()">💾 Save Network Settings</button>
                    </div>
                </div>
                
                <!-- Quick Ping Section -->
                <div class="discovery-subsection">
                    <h4>📡 Quick Ping Test</h4>
                    <div class="quick-ping-form">
                        <div class="ping-input-group">
                            <label>IP Address:</label>
                            <input type="text" id="singlePingIp" placeholder="192.168.1.100">
                        </div>
                        <div class="ping-input-group">
                            <label>Timeout:</label>
                            <input type="number" id="singlePingTimeout" min="1" max="30" value="5">
                        </div>
                        <button class="btn" onclick="pingSingleDevice()">📡 Ping</button>
                    </div>
                </div>
                
                <!-- Legacy Discovery -->
                <div class="discovery-subsection legacy">
                    <h4>🔄 Legacy Network Scan</h4>
                    <div class="legacy-form">
                        <input type="text" id="networkRange" placeholder="Network Range (e.g., 155.235.81.0/24)" value="155.235.81.0/24">
                        <button class="btn" onclick="startNetworkScan()">🔍 Start Network Scan</button>
                    </div>
                </div>
                
                <div id="discoveryResults" class="result-area">Ready to discover network devices...</div>
            </div>

            <!-- Storage Configuration -->
            <div class="section">
                <h3>⚙️ Storage Configuration</h3>
                <p>Configure DICOM storage paths and backup settings</p>
                <input type="text" id="storagePath" placeholder="Primary Storage Path" value="/nas/dicom/primary/">
                <input type="text" id="backupPath" placeholder="Backup Storage Path" value="/nas/dicom/backup/">
                <select id="compressionLevel">
                    <option value="none">No Compression</option>
                    <option value="lossless">Lossless Compression</option>
                    <option value="lossy">Lossy Compression</option>
                </select>
                <br>
                <button class="btn btn-warning" onclick="configureStorage()">⚙️ Configure Storage</button>
                <button class="btn" onclick="testStoragePaths()">🧪 Test Paths</button>
                <div id="storageResults" class="result-area">Storage not configured...</div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Processing request...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load modular JavaScript files in correct order -->
    <script src="{{ url_for('static', filename='js/nas-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui-helpers.js') }}"></script>
    <!-- Modular UI helper parts (must load after loader) -->
    <script src="{{ url_for('static', filename='js/ui-helpers/ports.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui-helpers/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui-helpers/formatters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/orthanc-integration.js') }}"></script>
    <script src="{{ url_for('static', filename='js/network-discovery.js') }}"></script>
    <script src="{{ url_for('static', filename='js/device-management.js') }}"></script>
    <script src="{{ url_for('static', filename='js/global-aliases.js') }}"></script>
</body>
</html>
